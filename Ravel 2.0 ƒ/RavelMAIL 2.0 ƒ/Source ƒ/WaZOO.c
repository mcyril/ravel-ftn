#include <stdio.h>#include <ctype.h>#include <string.h>#include <stdlib.h>#include "Timing.h"#include "compatible.h"#include "zmodem.h"#include "wazoo.h"#include "ftsc.h"//#include "Port.h"#include "Comm.h"#include "Ravel_FTN.h"#include "Ravel_Prefs.h"#include "Pathes.h"#include "Scheduler.h"#include "Unattended.h"#include "Attacher.h"#include "log.h"#include "pmain.h"#include "freq.h"#include "hydra_chat.h"#include "clasp.h"/*--------------------------------------------------------------------------*//* WaZOO                                                                    *//*--------------------------------------------------------------------------*/extern ADDR			remote_addr, called_addr;extern short		got_arcmail;extern short		got_packet;extern short		Netmail_Session;extern short		isOriginator;extern short		sent_mail;extern short		mail_finished;extern short		remote_capabilities;extern char			YesJanus;extern char			YesHydra;extern char			YesZedZap;extern short		thy_request;				//	reote made file requestextern short		we_request;				//	we made file requestextern Boolean		Aborted;static short fsent;short WaZOO_callback (StringPtr reqs){	short	res;	if (remote_capabilities & DOES_CLASP)	{		reqs[reqs[0]+1] = 0;		fsent++;		res = Clasp(NULL, (char *)&reqs[1], CL_SENDBATCH);		switch (res)		{		case XFER_ABORT:					res = 1;			break;				case XFER_SKIP:					res = SPEC_COND;			break;				default:					res = OK;			break;		}				return res;	}	else#ifndef LITE	if (remote_capabilities & DOES_HYDRA)	{//	putlog (lgATTN, "hydra callback %#s", reqs);			reqs[reqs[0]+1] = 0;		fsent++;		res = hydra ((char *)&reqs[1], NULL);//	putlog (lgATTN, "%d => %s aborted", res, (Aborted) ? "Was" : "Not");		switch (res)		{		case XFER_ABORT:					res = 1;			break;				case XFER_SKIP:					res = SPEC_COND;			break;				default:					res = OK;			break;		}				return res;	}	else#endif		return (Send_Zmodem (reqs, NULL, fsent++, DO_WAZOO));}void WaZOO (short originator){	short		stat;	short		i = 0;//	char		j[100];//	char		k[100];		/*-----------------------------------------------------------------------------*/	/* Initialize WaZOO (е see EMSI transfer comments for resolve called_addr е)   */	/*-----------------------------------------------------------------------------*///	putlog ( lgATTN, " + WaZOO" );	fsent = 0;	stat =		got_arcmail =		got_packet = 0;		thy_request = 0;		//	reote made file request	we_request = 0;		//	we made file request	Netmail_Session = 1;		isOriginator = originator;		called_addr = remote_addr;		if (!CARRIER || CheckCancel())	{		Aborted = true;		return;	}	#ifndef LITE//	* Try Hydra first *	if ((((unsigned) remote_capabilities) & DOES_HYDRA) && YesHydra)	{//		status_line ("%s Janus", msgtxt[M_EMSI_METHOD]);		putlog ( lgNOPE, "Method:      Hydra" );		remote_capabilities |= DOES_HYDRA;		hydra_init (0, 1L);		if (Aborted)			goto endwazoo;				do_FLOfile (&called_addr, WaZOO_callback);		if (Aborted)		{			hydra_deinit ();			goto endwazoo;		}				hydra (NULL, NULL);		if (Aborted)		{			hydra_deinit ();			goto endwazoo;		}				if (thy_request)			respond_to_file_requests (fsent, WaZOO_callback);				if (Aborted)		{			hydra_deinit ();			goto endwazoo;		}				hydra (NULL, NULL);		hydra_deinit ();				FlushVol ( NULL, 0 );				goto endwazoo;	}	/* Try Janus first */	if ((((unsigned) remote_capabilities) & DOES_IANUS) && YesJanus)	{		putlog ( lgNOPE, "Method:      Janus" );		Janus ();		FlushVol ( NULL, 0 );				goto endwazoo;	}	#endif   /* See if we can both do ZEDZAP */  	if ((remote_capabilities & ZED_ZAPPER) && YesZedZap)	{		putlog ( lgNOPE, "Method:      ZedZap" );		remote_capabilities &= ~(ZED_ZIPPER | DOES_HYDRA | DOES_IANUS);//		remote_capabilities &= ~ZED_ZIPPER;	}	else		if (remote_capabilities & ZED_ZIPPER)		{			putlog ( lgNOPE, "Method:      ZedZip" );			remote_capabilities &= ~(ZED_ZAPPER | DOES_HYDRA | DOES_IANUS);//			remote_capabilities &= ~ZED_ZAPPER;		}		else		{			putlog ( lgNOPE, "Method:      DietIFNA" );			if (originator)			{				FTSC_sender (1);			}			else			{				FTSC_receiver (1);			}	//			Aborted = true;			goto endwazoo;		}		/*--------------------------------------------------------------------*/	/* ORIGINATOR: send/receive/send                                      */	/*--------------------------------------------------------------------*/	z_devinit (true);		//	ее	CHAT aware		if (originator)	{		putMessage ( 2, "\pSending outbound bundles" );        //		z_devinit (true);		//	ее	CHAT aware		do_FLOfile (&called_addr, WaZOO_callback);    	Send_Zmodem (NULL, NULL, (fsent ? END_BATCH : NOTHING_TO_DO), DO_WAZOO);		if (!CARRIER || CheckCancel())		{			Aborted = true;			goto endwazoo1;		}						putMessage ( 2, "\pReceiving inbound bundles" );        //		z_devinit (true);		//	ее	CHAT aware		if(!get_Zmodem (inboundPath, NULL))		{			putlog ( lgATTN, "Receive fault..." );			FlushVol ( NULL, 0 );			Aborted = true;			goto endwazoo1;		}			FlushVol ( NULL, 0 );				if (!CARRIER || CheckCancel())		{			Aborted = true;			goto endwazoo1;		}				//	we are calling and are we got reqs?				if (thy_request)		{#ifndef LITE			putMessage ( 2, "\pSending outbound bundles" );        //			z_devinit (true);	//	ее	CHAT aware			stat = respond_to_file_requests (0, WaZOO_callback);    //	* was (i, WaZOO_callback) *			if (Aborted)				goto endwazoo1;#endif			Send_Zmodem (NULL, NULL, ((stat) ? END_BATCH : NOTHING_TO_DO), DO_WAZOO);		}				mail_finished = 1;	}	/*--------------------------------------------------------------------*/	/* CALLED SYSTEM: receive/send/receive                                */	/*--------------------------------------------------------------------*/	else	{		putMessage ( 2, "\pReceiving inbound bundles" );        //		z_devinit (true);	//	ее	CHAT aware		if(!get_Zmodem (inboundPath, NULL))		{			putlog ( lgATTN, "Receive fault..." );			FlushVol ( NULL, 0 );			Aborted = true;			goto endwazoo1;		}		FlushVol ( NULL, 0 );				if (!CARRIER || CheckCancel())		{			Aborted = true;			goto endwazoo1;		}		putMessage ( 2, "\pSending outbound bundles" );        		//		z_devinit (true);	//	ее	CHAT aware		if (do_FLOfile (&called_addr, WaZOO_callback))		{#ifndef LITE			if(thy_request)				fsent = respond_to_file_requests (fsent, WaZOO_callback);#endif						if (Aborted)				goto endwazoo1;			    		Send_Zmodem (NULL, NULL, (fsent ? END_BATCH : NOTHING_TO_DO), DO_WAZOO);		}				if (!CARRIER || CheckCancel())		{			Aborted = true;			goto endwazoo1;		}//	е	no requests processed				if (we_request)		{			putMessage ( 2, "\pReceiving requests" );        //			z_devinit (true);	//	ее	CHAT aware			if(!get_Zmodem (inboundPath, NULL))			{				putlog ( lgATTN, "Fault receiving..." );				FlushVol ( NULL, 0 );				Aborted = true;				goto endwazoo1;			}		}	}endwazoo1:	z_devinit (false);	//	ее	CHAT awareendwazoo:	putMessage ( 3, "\p " );        }                                                /* wazoo */