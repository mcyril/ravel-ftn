#include <Sound.h>#include <string.h>#include "visual.h"#include "Ravel_FTN.h"#include "Ravel_Prefs.h"#include "compatible.h"#include "stringutl.h"#include "mFilter.h"#include "Scheduler.h"#include "nodelist.h"#include "Unattended.h"#include "Manual.h"#include "NodeCookie.h"extern	short			NodesNumber;		//	¥	Linked Nodes structs listextern	nodePrefHndl	*nodesHndls;extern	homeHndl		homesystem;			//	¥	Home system structextern	MenuHandle		nodeAddrs;pascal Boolean ModalFilterProc ( DialogPtr theDialog, EventRecord *theEvent, short *itemHit ){	Boolean result = false;	char	tmp[128];		if (theEvent->what == mouseDown)	{		Point		localWhere = theEvent->where;		GrafPtr		savePort;				GetPort (&savePort);		SetPort (theDialog);		GlobalToLocal (&localWhere);			if (FindDialogItem (theDialog, localWhere) == 7)	// 8 is popdown pump!		{			short	iType, inx;			Handle	iHandle;			Rect	iRect;			Point	popWhere;			GetDialogItem ( theDialog, 3, &iType, &iHandle, &iRect );			popWhere.v = iRect.bottom;			popWhere.h = iRect.left;			LocalToGlobal (&popWhere);						GetDialogItem ( theDialog, 8, &iType, &iHandle, &iRect );			PlotIconID (&iRect, atNone, (((WindowPeek)theDialog)->hilited) ? ttNone : ttDisabled, 5013);//			InvertRect (&iRect);			DisableItem (nodeAddrs, 1);			DisableItem (nodeAddrs, 2);			inx = PopUpMenuSelect ( nodeAddrs, popWhere.v, popWhere.h, 1 ) & 0xFFFF;						if (inx > 3)			{				inx -= 4;								printaddr ( &(*(nodesHndls[inx]))->Addr, &tmp[1] );				tmp[0] = strlen ( &tmp[1] );							GetDialogItem ( theDialog, 3, &iType, &iHandle, &iRect );				SetDialogItemText ( iHandle, (StringPtr) tmp );			}			else				if (inx == 1)				{					SysBeep (10);								}				else					if (inx == 2)					{			//	insert address attributes						SysBeep (10);					}						GetDialogItem ( theDialog, 8, &iType, &iHandle, &iRect );			PlotIconID (&iRect, atNone, (((WindowPeek)theDialog)->hilited) ? ttNone : ttDisabled, 5012);//			InvertRect (&iRect);		}			SetPort (savePort);	}	else		if (theEvent->what == keyDown)		{			char	key = theEvent->message & 0xFFL;			char	code;			short	linx = -1;									*itemHit = 0;/*			if ((theEvent->modifiers & (optionKey | cmdKey)) == (optionKey | cmdKey))			{				switch (code = (theEvent->message & 0xFF00L) >> 8)				{				case 0x12:								// 1				case 0x13:								// 2				case 0x14:								// 3				case 0x15:	linx = code - 0x12;	break;	// 4				case 0x17:	linx = 4;			break;	// 5				case 0x16:	linx = 5;			break;	// 6				case 0x1A:	linx = 6;			break;	// 7				case 0x1C:	linx = 7;			break;	// 8				case 0x19:	linx = 8;			break;	// 9								default:	break;				}								if (linx >= 0 && linx < NodesNumber)				{					short	iType;					Handle	iHandle;					Rect	iRect;					printaddr ( &(*(nodesHndls[linx]))->Addr, &tmp[1] );					tmp[0] = strlen ( &tmp[1] );									GetDialogItem ( theDialog, 3, &iType, &iHandle, &iRect );					SetDialogItemText ( iHandle, (StringPtr) tmp );				}								result = true;			}			else*/			{				if (key == 0x1B)				{					*itemHit = 2;					result = true;				}				else					if (key == 0x03 || key == 0x0D)					{						*itemHit = 1;						result = true;					}								if (*itemHit)					{						FalseClick (theDialog, *itemHit);					}			}		}		else			if (theEvent->what == updateEvt)			{				short	iType;				Handle	iHandle;				Rect	iRect;				GrafPtr		savePort;				GetPort (&savePort);				SetPort (theDialog);				GetDialogItem ( theDialog, 8, &iType, &iHandle, &iRect );				PlotIconID (&iRect, atNone, (((WindowPeek)theDialog)->hilited) ? ttNone : ttDisabled, 5012);				SetPort (savePort);			}	return result;}pascal Boolean ModalPollFilterProc ( DialogPtr theDialog, EventRecord *theEvent, short *itemHit ){	Boolean result = false;	char	tmp[128];	Str255	sTemp;	addr	tempaddr;		if (theEvent->what == mouseDown)	{		Point		localWhere = theEvent->where;		GrafPtr		savePort;				GetPort (&savePort);		SetPort (theDialog);		GlobalToLocal (&localWhere);			if (FindDialogItem (theDialog, localWhere) == 7)	// 8 is popdown pump!		{			short	iType, inx;			Handle	iHandle;			Rect	iRect;			Point	popWhere;			GetDialogItem ( theDialog, 8, &iType, &iHandle, &iRect );			popWhere.v = iRect.bottom+1;			popWhere.h = iRect.left;			LocalToGlobal (&popWhere);						GetDialogItem ( theDialog, 8, &iType, &iHandle, &iRect );			PlotIconID (&iRect, atNone, (((WindowPeek)theDialog)->hilited) ? ttNone : ttDisabled, 5013);//			InvertRect (&iRect);			if (yep())			{				EnableItem (nodeAddrs, 1);				EnableItem (nodeAddrs, 2);			}			else			{				DisableItem (nodeAddrs, 1);				DisableItem (nodeAddrs, 2);			}						inx = PopUpMenuSelect ( nodeAddrs, popWhere.v, popWhere.h, 1 ) & 0xFFFF;						if (inx > 3)			{				inx -= 4;								printaddr ( &(*(nodesHndls[inx]))->Addr, &tmp[1] );				tmp[0] = strlen ( &tmp[1] );							GetDialogItem ( theDialog, 3, &iType, &iHandle, &iRect );				SetDialogItemText ( iHandle, (StringPtr) tmp );				GetDialogItem ( theDialog, 4, &iType, &iHandle, &iRect );				SetDialogItemText ( iHandle, "\p" );				GetDialogItem ( theDialog, 10, &iType, &iHandle, &iRect );				SetDialogItemText ( iHandle, "\p" );				GetDialogItem ( theDialog, 5, &iType, &iHandle, &iRect );				SetControlValue ( (ControlHandle) iHandle, ((*(nodesHndls[inx]))->Poll == 0) ? 1 : 0 );								GetDialogItem ( theDialog, 6, &iType, &iHandle, &iRect );				SetControlValue ( (ControlHandle) iHandle, ((*(nodesHndls[inx]))->Poll == 1) ? 1 : 0 );				GetDialogItem ( theDialog, 7, &iType, &iHandle, &iRect );				SetControlValue ( (ControlHandle) iHandle, ((*(nodesHndls[inx]))->Poll == 2) ? 1 : 0 );				*itemHit = 8;				result = true;			}			else				if (inx == 1)				{					GetDialogItem ( theDialog, 3, &iType, &iHandle, &iRect );					GetDialogItemText ( iHandle, sTemp );					sTemp[sTemp[0]+1] = 0;										tempaddr.zone = (*homesystem)->mainAddr.ad.zone;					tempaddr.net = (*homesystem)->mainAddr.ad.net;					tempaddr.node = (*homesystem)->mainAddr.ad.node;					tempaddr.point = 0;										parseaddr ( &tempaddr, (char *) &sTemp[1] );										GetDialogItem ( theDialog, 4, &iType, &iHandle, &iRect );					SetDialogItemText ( iHandle, "\p" );					if (NodeBrowse (&tempaddr))					{						printaddr (&tempaddr, (char *) &sTemp[1]);						sTemp[0] = strlen ((char *) &sTemp[1]);												GetDialogItem ( theDialog, 3, &iType, &iHandle, &iRect );						SetDialogItemText ( iHandle, sTemp );						if ( GetPhoneFromAddr ( &tempaddr, sTemp ) )						{							GetDialogItem ( theDialog, 4, &iType, &iHandle, &iRect );							SetDialogItemText ( iHandle, sTemp );						}						*itemHit = 9;						result = true;					}				}				else					if (inx == 2)					{			//	insert address attributes											GetDialogItem ( theDialog, 3, &iType, &iHandle, &iRect );						GetDialogItemText ( iHandle, sTemp );						sTemp[sTemp[0]+1] = 0;												tempaddr.zone = 0;						tempaddr.net = 0;						tempaddr.node = 0;						tempaddr.point = 0;												parseaddr ( &tempaddr, (char *) &sTemp[1] );												if (tempaddr.zone && tempaddr.net)						{							if ( GetPhoneFromAddr ( &tempaddr, sTemp ) )							{								GetDialogItem ( theDialog, 4, &iType, &iHandle, &iRect );								SetDialogItemText ( iHandle, sTemp );							}						}					}						GetDialogItem ( theDialog, 8, &iType, &iHandle, &iRect );			PlotIconID (&iRect, atNone, (((WindowPeek)theDialog)->hilited) ? ttNone : ttDisabled, 5012);//			InvertRect (&iRect);		}			SetPort (savePort);	}	else		if (theEvent->what == keyDown)		{			char	key = theEvent->message & 0xFFL;			char	code;			short	linx = -1;									*itemHit = 0;						if ((theEvent->modifiers & (optionKey | cmdKey)) == (optionKey | cmdKey))			{				switch (code = (theEvent->message & 0xFF00L) >> 8)				{				case 0x08:	*itemHit = 7;		break;	//	crash				case 0x02:	*itemHit = 6;		break;	//	direct				case 0x04:	*itemHit = 5;		break;	//	hold				case 0x03:	*itemHit = 12;		break;	//	force								case 0x12:								// 1				case 0x13:								// 2				case 0x14:								// 3				case 0x15:	linx = code - 0x12;	break;	// 4				case 0x17:	linx = 4;			break;	// 5				case 0x16:	linx = 5;			break;	// 6				case 0x1A:	linx = 6;			break;	// 7				case 0x1C:	linx = 7;			break;	// 8				case 0x19:	linx = 8;			break;	// 9								default:	break;				}								if (linx >= 0 && linx < NodesNumber)				{					short	iType;					Handle	iHandle;					Rect	iRect;					printaddr ( &(*(nodesHndls[linx]))->Addr, &tmp[1] );					tmp[0] = strlen ( &tmp[1] );									GetDialogItem ( theDialog, 3, &iType, &iHandle, &iRect );					SetDialogItemText ( iHandle, (StringPtr) tmp );					GetDialogItem ( theDialog, 4, &iType, &iHandle, &iRect );					SetDialogItemText ( iHandle, "\p" );					GetDialogItem ( theDialog, 10, &iType, &iHandle, &iRect );					SetDialogItemText ( iHandle, "\p" );					GetDialogItem ( theDialog, 5, &iType, &iHandle, &iRect );					SetControlValue ( (ControlHandle) iHandle, ((*(nodesHndls[linx]))->Poll == 0) ? 1 : 0 );										GetDialogItem ( theDialog, 6, &iType, &iHandle, &iRect );					SetControlValue ( (ControlHandle) iHandle, ((*(nodesHndls[linx]))->Poll == 1) ? 1 : 0 );					GetDialogItem ( theDialog, 7, &iType, &iHandle, &iRect );					SetControlValue ( (ControlHandle) iHandle, ((*(nodesHndls[linx]))->Poll == 2) ? 1 : 0 );					*itemHit = 8;				}								result = true;			}			else			{				if (key == 0x1B)				{					*itemHit = 2;					result = true;				}				else					if (key == 0x03 || key == 0x0D)					{						*itemHit = 1;						result = true;					}					if (*itemHit)					{						FalseClick (theDialog, *itemHit);					}			}		}		else			if (theEvent->what == updateEvt)			{				short	iType;				Handle	iHandle;				Rect	iRect;				GrafPtr		savePort;				GetPort (&savePort);				SetPort (theDialog);				GetDialogItem ( theDialog, 8, &iType, &iHandle, &iRect );				PlotIconID (&iRect, atNone, (((WindowPeek)theDialog)->hilited) ? ttNone : ttDisabled, 5012);				SetPort (savePort);			}	return result;}pascal Boolean ModalEditPollFilterProc ( DialogPtr theDialog, EventRecord *theEvent, short *itemHit ){	Boolean result = false;	char	tmp[128];	Str255	sTemp;	addr	tempaddr;			if (theEvent->what == keyDown)		{			char	key = theEvent->message & 0xFFL;			char	code;			short	linx = -1;									*itemHit = 0;						if ((theEvent->modifiers & (optionKey | cmdKey)) == (optionKey | cmdKey))			{				switch (code = (theEvent->message & 0xFF00L) >> 8)				{				case 0x08:	*itemHit = 7;		break;	//	crash				case 0x02:	*itemHit = 6;		break;	//	direct				case 0x04:	*itemHit = 5;		break;	//	hold				case 0x03:	*itemHit = 12;		break;	//	force								default:	break;				}								result = true;			}			else			{				if (key == 0x1B)				{					*itemHit = 2;					result = true;				}				else					if (key == 0x03 || key == 0x0D)					{						*itemHit = 1;						result = true;					}					if (*itemHit)					{						FalseClick (theDialog, *itemHit);					}			}		}		else			if (theEvent->what == updateEvt)			{				short	iType;				Handle	iHandle;				Rect	iRect;				GrafPtr		savePort;				GetPort (&savePort);				SetPort (theDialog);				GetDialogItem ( theDialog, 8, &iType, &iHandle, &iRect );				PlotIconID (&iRect, atNone, (((WindowPeek)theDialog)->hilited) ? ttNone : ttDisabled, 5012);				SetPort (savePort);			}	return result;}pascal Boolean ModalClearFilterProc ( DialogPtr theDialog, EventRecord *theEvent, short *itemHit ){#pragma unused (theDialog)	Boolean result = false;		if (theEvent->what == keyDown)	{		char	key = theEvent->message & 0xFFL;						*itemHit = 0;				if (key == 0x1B)		{			*itemHit = 2;			result = true;		}		else			if (key == 0x03 || key == 0x0D)			{				*itemHit = 1;				result = true;			}				if (*itemHit)		{			FalseClick (theDialog, *itemHit);		}	}	return result;}