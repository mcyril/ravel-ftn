#include <CommResources.h>#include <CRMSerialDevices.h>#include <Connections.h>#include <CTBUtilities.h>#include <stdio.h>#include <string.h>#include "PatchNewControl.h"#include "PascalStr.h"#include "PKT.h"#include "Prefs.h"extern	Str255			toolName;extern	Str255			lstnr1, lstnr2;extern	Ptr				configStr;extern	h_ftsc			ftsc;void	doCTBSetup (MenuHandle mHandle);void	doCTBEdit (void);void doCTBSetup (MenuHandle mHandle){	OSErr			err;	short			vRefNum, inx, refNum, procID;	long			dirID;	Str255			str;		ConnHandle		conn;	CMBufferSizes	bSizes;	long			Sizes;		Point			where = {40,40};		Handle			h;	char			flags;	GetMenuItemText (mHandle, 1, str);	if (str[0])	{//	¥	CommTool already selected&configured			procID = CMGetProcID (str);			if (procID == -1)		{//	¥	CommTool has been removed?			goto asnew;		}	}	else	{//	¥	No CommTool was selected&confoguredasnew:			err = CRMGetIndToolName (classCM, 1, str);				if (err == noErr)		{			procID = CMGetProcID (str);						if (procID == -1)			{				str[0] = 0;				goto bailout;			}		}				configStr = NULL;	}	memset (&bSizes, 0, sizeof (bSizes));	conn = CMNew (procID, cmNoMenus | cmQuiet, (long *) &bSizes, 0L, 0L);	if (conn)	{		if (configStr)		{			err = CMSetConfig (conn, configStr);		}		err = CMChoose (&conn, where, NULL);		if (err == chooseOKMinor || err == chooseOKMajor)		{			procID = (**conn).procID;			CMGetToolName (procID, str);						configStr = CMGetConfig (conn);			if (configStr)			{				flags = HGetState((Handle) conn);				HLock ((Handle)conn);				BlockMove ((**conn).config,					(**conn).oldConfig,					GetPtrSize ((**conn).oldConfig));				HSetState ((Handle)conn, flags);			}		}		else			pStrCopy (toolName, str);				CMDispose (conn);	}bailout:	SetMenuItemText (mHandle, 1, (str[0]) ? str : "\pCTB");	if (str[0])	{		pStrCopy (str, toolName);	}	else		configStr = NULL;}static	TEHandle	hTE;static	short		focus;static pascal Boolean setupFilter ( DialogPtr theDialog, EventRecord *theEvent, short *itemHit ){	Boolean 	result = false;	Point		localWhere = theEvent->where;	GrafPtr		savePort;	short		initem, part;	WindowPtr	window;	short		iType;	Handle		iHandle;	Rect		iRect;	switch (theEvent->what)	{	case keyDown:	case autoKey:			part = theEvent->message & 0x00FF;			if (part == 0x03 || part == 0x0D)		{			*itemHit = 1;			result = true;		}		else			if (part == 0x1B)			{				*itemHit = 2;				result = true;			}			else				if (focus == 0)				{					TEKey (part, hTE);					result = true;							}		break;		case mouseDown:			switch ( part = FindWindow (theEvent->where, &window) )		{		case inContent:					if (window != FrontWindow())			{//				SelectWindow(window);				result = false;			}			else			{				GetPort (&savePort);				SetPort (theDialog);				GlobalToLocal (&localWhere);								initem = FindDialogItem (theDialog, localWhere) + 1;								switch (initem)				{				case 3:										TEClick (localWhere, (theEvent->modifiers & shiftKey) != 0, hTE);					result = false;					focus = 0;					break;								case 4:				case 5:									focus = initem;					break;				}				((DialogPeek)theDialog)->editField = focus;				SetPort (savePort);			}						break;		}				break;	case updateEvt:				GetPort (&savePort);			SetPort (theDialog);			GetDialogItem (theDialog, 3, &iType, &iHandle, &iRect);			TEUpdate (&iRect, hTE);			SetPort (savePort);				break;	}	return result;}void doCTBEdit (){	DialogPtr	linxDlg;	short		iHit;		GrafPtr		oldPort;	short		iType;	Handle		iHandle;	Rect		iRect;	FontInfo		fi;	GetPort (&oldPort);		PatchNewControl ();	linxDlg = GetNewDialog ( 502, NULL, (WindowPtr) -1L );	UnPatchNewControl ();		SetPort (linxDlg);	focus = 0;	((DialogPeek)linxDlg)->editField = 0;		TextFont (1);	TextSize (9);		(*(((DialogPeek) linxDlg)->textH))->txFont = 1;	(*(((DialogPeek) linxDlg)->textH))->txSize = 9;	GetFontInfo (&fi);	(*(((DialogPeek) linxDlg)->textH))->lineHeight = fi.ascent + fi.descent + fi.leading;	(*(((DialogPeek) linxDlg)->textH))->fontAscent = fi.ascent;	GetDialogItem (linxDlg, 3, &iType, &iHandle, &iRect);	hTE = TENew (&iRect, &iRect);	TESetText (configStr, strlen (configStr), hTE);	TEActivate (hTE);	TEAutoView (true,hTE);		InsetRect (&iRect, -1, -1);	FrameRect (&iRect);	GetDialogItem (linxDlg, 4, &iType, &iHandle, &iRect);	SetDialogItemText (iHandle, lstnr1);	GetDialogItem (linxDlg, 5, &iType, &iHandle, &iRect);	SetDialogItemText (iHandle, lstnr2);	GetDialogItem ( linxDlg, 8, &iType, &iHandle, &iRect );	SetControlValue ( (ControlHandle) iHandle, (*ftsc)->ctb_mon );	do {			ModalDialog ( setupFilter, &iHit );				switch (iHit)		{		case 8:						GetDialogItem ( linxDlg, iHit, &iType, &iHandle, &iRect );			SetControlValue ( (ControlHandle) iHandle, !GetControlValue ((ControlHandle) iHandle) );						break;					default:						break;		}			} while (iHit != 1 && iHit != 2);	if (iHit == 1)	{		DisposePtr (configStr);				configStr = NewPtrClear ((*hTE)->teLength+1);		HLock ((*hTE)->hText);		memcpy (configStr, *(*hTE)->hText, (*hTE)->teLength);		GetDialogItem (linxDlg, 4, &iType, &iHandle, &iRect);		GetDialogItemText (iHandle, lstnr1);		GetDialogItem (linxDlg, 5, &iType, &iHandle, &iRect);		GetDialogItemText (iHandle, lstnr2);		GetDialogItem ( linxDlg, 8, &iType, &iHandle, &iRect );		(*ftsc)->ctb_mon = GetControlValue ((ControlHandle) iHandle);	}		TEDispose (hTE);	DisposeDialog (linxDlg);	SetPort (oldPort);}