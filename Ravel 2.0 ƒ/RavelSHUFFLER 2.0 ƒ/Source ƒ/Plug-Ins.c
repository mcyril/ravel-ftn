#include <string.h>//#include "Ravel_FTN.h"#include "ravel_msg_base.h"#include "ravel_tmp_base.h"#include "Ravel_Prefs.h"#include "Toss.h"#include "Scan.h"#include "PascalStr.h"#include "myEnv.h"//#include "BaseManager.h"#include "Flavor.h"#include "NetMailRoute.h"#include "Exports.h"#include "pktparse.h"#include "stringutl.h"#include "Purge.h"#include "Linker.h"#include "Pack.h"#include "nodelist.h"#include "AreaUtils.h"#include "Attaches.h"#include "ZipIt.h"#include "Pathes.h"#include "log.h"#include "busy.h"#include "Plug-Ins.h"extern	homeHndl		homesystem;			//	¥	Home system structextern	mailPrefHndl	mailHndl;			//	¥	Netmail structextern	short			AreasNumber;		//	¥	Areas structs listextern	areaPrefHndl	*areasHndls;extern	short			GroupsNumber;		//	¥	AreaGroups structs listextern	groupPrefHndl	*groupsHndls;extern	short			NodesNumber;		//	¥	Linked Nodes structs listextern	nodePrefHndl	*nodesHndls;extern	routeHndl		Routing;extern	Str255			NodeLists;		plugsChainPtr	plugsChain = NULL;		PlugsControlPtr	pluginscontrol = NULL;#if defined(powerc) || defined(__powerc)		PlugsControlPtr	pluginscontrolppc = NULL;#endifenum {	uppPlugEntryProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(Ptr))),		uppCB_v_v_ProcInfo = kThinkCStackBased,	uppCB_v_lllb_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(4, SIZE_CODE(sizeof(Boolean))),	uppCB_l_lll_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long))),	uppCB_l_bblll_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(4, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(5, SIZE_CODE(sizeof(long))),	uppCB_l_l_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long))),	uppCB_v_llllb_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(4, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(5, SIZE_CODE(sizeof(Boolean))),	uppCB_s_s_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(short)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(short))),	uppCB_b_v_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(Boolean))),	uppCB_b_ll_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long))),	uppCB_b_lll_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long))),	uppCB_v_lll_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long))),	uppCB_b_lb_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(Boolean))),	uppCB_b_lls_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(short))),	uppCB_l_v_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(long))),	uppCB_v_l_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long))),	uppCB_v_cl_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(char)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long))),	uppCB_l_ll_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long))),	uppCB_l_ls_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(short))),	uppCB_b_l_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long))),	uppCB_v_lb_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(Boolean))),	uppCB_v_ll_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long))),	uppCB_v_llb_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(Boolean))),	uppCB_v_lllllb_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(4, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(5, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(6, SIZE_CODE(sizeof(Boolean))),	uppCB_v_llll_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(4, SIZE_CODE(sizeof(long))),	uppCB_v_slllll_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(short)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(4, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(5, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(6, SIZE_CODE(sizeof(long))),	uppCB_s_lll_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(short)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long))),	uppCB_s_l_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(short)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long))),	uppCB_s_ll_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(short)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long))),	uppCB_s_sb_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(short)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(Boolean))),	uppCB_v_s_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(short))),	uppCB_v_f_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(float))),	uppCB_l_bbllll_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(4, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(5, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(6, SIZE_CODE(sizeof(long)))};void	DoSlice (void);OSErr	FindAProcess (OSType typeToFind, OSType creatorToFind, ProcessSerialNumberPtr processSN);void	InitProgress (float howmuch);void	DrawProgress (long i);void	putProgressName (Str255 name);void	UpdatePreference_Links (void);void	UpdatePreference_Areas (void);static long _x_printaddr ( addr *f, char *_ftmp ){	return (long)printaddr ( f, _ftmp );}static long _x_FindRouteTo ( addr *Addr ){	return (long)FindRouteTo ( Addr );}static long _x_obtainHBase (void){	return (long)obtainHBase ();}static long _x_ClonePktMsg(pktmsg *m){	return (long)ClonePktMsg(m);}static long _x_printmask ( addr *f, char *_ftmp ){	return (long)printmask ( f, _ftmp );}void PreparePlugsStructure (void){	if (!pluginscontrol)	{		pluginscontrol = (PlugsControlPtr) NewPtrClear (sizeof (PlugsControl));		if (!pluginscontrol)		{			putlog ( lgALRT, "Not enough memory for init plugsÉ" );			ExitToShell ();		}	}#if defined(powerc) || defined(__powerc)	if (!pluginscontrolppc)	{		pluginscontrolppc = (PlugsControlPtr) NewPtrClear (sizeof (PlugsControl));		if (!pluginscontrolppc)		{			putlog ( lgALRT, "Not enough memory for init plugsÉ" );			ExitToShell ();		}	}#endif	pluginscontrol->apiRev = kCurrentPlugAPI;		pluginscontrol->Preferences.homesystem = homesystem;		//	Home system struct			pluginscontrol->Preferences.mailHndl = mailHndl;			//	Netmail struct			pluginscontrol->Preferences.AreasNumber = AreasNumber;		//	Areas structs list	pluginscontrol->Preferences.areasHndls = areasHndls;			pluginscontrol->Preferences.GroupsNumber = GroupsNumber;	//	AreaGroups structs list	pluginscontrol->Preferences.groupsHndls = groupsHndls;			pluginscontrol->Preferences.NodesNumber = NodesNumber;		//	Linked Nodes structs list	pluginscontrol->Preferences.nodesHndls = nodesHndls;			pluginscontrol->Preferences.Routing = Routing;				//	Routing	pluginscontrol->Preferences.BundlesPath = workPath;			//	working folder for bundling outbound	pluginscontrol->Preferences.OutboundPath = outboundPath;	//	outbound folder	pluginscontrol->Preferences.InboundPath = inboundPath;		//	inbound folder	pluginscontrol->Preferences.BasePath = basePath;			//	base storage folder	pluginscontrol->Preferences.TempPath = tempPath;			//	temp folder (fe. for unpacking)	pluginscontrol->Preferences.NodeLists = NodeLists;			//	Nodelist path	pluginscontrol->Preferences.LogPath = logPath;				//	Log path	pluginscontrol->CallPlugIns = CallPlugIns;	pluginscontrol->CallNamedPlugIns = CallNamedPlugIns;	pluginscontrol->CallArchiverPlugIns = CallArchiverPlugIns;	pluginscontrol->ResolveMessage = ResolveMessage;	pluginscontrol->ExportEchoes = ExportEchoes;	pluginscontrol->RouteMessage = RouteMessage;	pluginscontrol->CreateFoldersChain = CreateFoldersChain;	pluginscontrol->FlavorMessage = FlavorMessage;	pluginscontrol->parse_kludges = parse_kludges;	pluginscontrol->msgbase_create_unique_name = msgbase_create_unique_name;	pluginscontrol->msgbase_open = msgbase_open;	pluginscontrol->msgbase_open_idx = msgbase_open_idx;	pluginscontrol->msgbase_close = msgbase_close;	pluginscontrol->msgbase_read_atom = msgbase_read_atom;	pluginscontrol->msgbase_write_atom = msgbase_write_atom;	pluginscontrol->msgbase_getnummsg = msgbase_getnummsg;	pluginscontrol->msgbase_setnummsg = msgbase_setnummsg;	pluginscontrol->msgbase_getlastread = msgbase_getlastread;	pluginscontrol->msgbase_setlastread = msgbase_setlastread;	pluginscontrol->msgbase_getdirty = msgbase_getdirty;	pluginscontrol->msgbase_setdirty = msgbase_setdirty;	pluginscontrol->msgbase_read_message = msgbase_read_message;	pluginscontrol->msgbase_append_message = msgbase_append_message;	pluginscontrol->msgbase_ftn_date = msgbase_ftn_date;	pluginscontrol->msgbase_scanforme = msgbase_scanforme;	pluginscontrol->msgbase_scanunread = msgbase_scanunread;	pluginscontrol->msgbase_allread = msgbase_allread;	pluginscontrol->msgbase_prep_reply = msgbase_prep_reply;	pluginscontrol->msgbase_prep_msgid = msgbase_prep_msgid;	pluginscontrol->msgbase_new_msgid = msgbase_new_msgid;	pluginscontrol->msgbase_insert_message = msgbase_insert_message;	pluginscontrol->msgbase_delete_message = msgbase_delete_message;	pluginscontrol->FreePktMsg = FreePktMsg;	pluginscontrol->tmpbase_open = tmpbase_open;	pluginscontrol->tmpbase_add = tmpbase_add;	pluginscontrol->tmpbase_close = tmpbase_close;	pluginscontrol->putlog = _putlog;	pluginscontrol->parseaddr = parseaddr;	pluginscontrol->printaddr = _x_printaddr;	pluginscontrol->FindAProcess = FindAProcess;	pluginscontrol->Slice = DoSlice;	pluginscontrol->_Toss = Toss;	pluginscontrol->_Scan = Scan;	pluginscontrol->_NetPack = NetPack;	pluginscontrol->_Purge = PurgeDestructive;	pluginscontrol->_Pack = Pack;	pluginscontrol->_Link = MsgLink;	pluginscontrol->InitProgress = InitProgress;	pluginscontrol->DrawProgress = DrawProgress;	pluginscontrol->putProgressName = putProgressName;	pluginscontrol->GetNodeInfo = GetNodeInfo;	pluginscontrol->GetNameFromAddr = GetNameFromAddr;	pluginscontrol->GetInfoFromAddr = GetInfoFromAddr;	pluginscontrol->IsNodelistOK = yep;	pluginscontrol->LookForAreaNumber = LookForAreaNumber;	pluginscontrol->LookForLinkNumber = LookForLinkNumber;	pluginscontrol->cmp2addrs = cmp2addrs;	pluginscontrol->addrInmask = addrInmask;	pluginscontrol->IsItMyAddr = IsItMyAddr;	pluginscontrol->FindRouteTo = _x_FindRouteTo;	pluginscontrol->FindRouteToN = FindRouteToN;	pluginscontrol->add_to_other = add_to_other;	pluginscontrol->get_flo_pathname = get_flo_pathname;	pluginscontrol->bsy_check = bsy_check;	pluginscontrol->bsy_raise = bsy_raise;	pluginscontrol->bsy_clear = bsy_clear;	pluginscontrol->base_bsy_check = base_bsy_check;	pluginscontrol->base_bsy_raise = base_bsy_raise;	pluginscontrol->base_bsy_clear = base_bsy_clear;	pluginscontrol->_PurgeNonDstr = Purge;					//	call non destructive PURGE command	pluginscontrol->obtainHBase = _x_obtainHBase;				//	get handle to current opened msgbase index	pluginscontrol->_Undel = Undel;	pluginscontrol->Resolver = Resolver;	pluginscontrol->UpdatePreference_Links = UpdatePreference_Links;	pluginscontrol->UpdatePreference_Areas = UpdatePreference_Areas;	pluginscontrol->ExportEchoesOnlyTo = ExportEchoesOnlyTo;//	apiRev = 0x8002	pluginscontrol->parsemask = parsemask;	pluginscontrol->ClonePktMsg = _x_ClonePktMsg;	pluginscontrol->printmask = _x_printmask;#if defined(powerc) || defined(__powerc)		BlockMove(pluginscontrol, pluginscontrolppc, sizeof(PlugsControl));		(ProcPtr) pluginscontrol->CallPlugIns =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) CallPlugIns, uppCB_l_lll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->CallNamedPlugIns = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) CallNamedPlugIns, uppCB_l_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->CallArchiverPlugIns =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) CallArchiverPlugIns, uppCB_l_bblll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->ResolveMessage =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) ResolveMessage, uppCB_v_llb_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->ExportEchoes =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) ExportEchoes, uppCB_v_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->RouteMessage =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) RouteMessage, uppCB_v_lb_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->CreateFoldersChain =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) CreateFoldersChain, uppCB_v_lllllb_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->FlavorMessage =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) FlavorMessage, uppCB_v_lllb_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->parse_kludges =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) parse_kludges, uppCB_v_slllll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_create_unique_name =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_create_unique_name, uppCB_v_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_open =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_open, uppCB_s_sb_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_open_idx =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_open_idx, uppCB_s_sb_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_close =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_close, uppCB_v_s_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_read_atom =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_read_atom, uppCB_b_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_write_atom =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_write_atom, uppCB_b_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_getnummsg =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_getnummsg, uppCB_l_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_setnummsg =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_setnummsg, uppCB_v_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_getlastread =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_getlastread, uppCB_l_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_setlastread =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_setlastread, uppCB_v_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_getdirty =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_getdirty, uppCB_l_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_setdirty =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_setdirty, uppCB_v_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_read_message =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_read_message, uppCB_b_lls_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_append_message =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_append_message, uppCB_b_lb_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_ftn_date =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_ftn_date, uppCB_v_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_scanforme =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_scanforme, uppCB_b_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_scanunread =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_scanunread, uppCB_l_ls_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_allread =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_allread, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_prep_reply =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_prep_reply, uppCB_v_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_prep_msgid =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_prep_msgid, uppCB_v_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_new_msgid =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_new_msgid, uppCB_l_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_insert_message =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_insert_message, uppCB_v_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_delete_message =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_delete_message, uppCB_v_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->FreePktMsg =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) FreePktMsg, uppCB_v_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->tmpbase_open =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) tmpbase_open, uppCB_b_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->tmpbase_add =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) tmpbase_add, uppCB_s_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->tmpbase_close =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) tmpbase_close, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->putlog =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) _putlog, uppCB_v_cl_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->parseaddr =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) parseaddr, uppCB_s_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->printaddr =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) _x_printaddr, uppCB_l_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->FindAProcess =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) FindAProcess, uppCB_s_lll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->Slice =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) DoSlice, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->_Toss =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) Toss, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->_Scan =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) Scan, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->_NetPack =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) NetPack, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->_Purge =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) PurgeDestructive, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->_Pack = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) Pack, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->_Link =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) MsgLink, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->InitProgress =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) InitProgress, uppCB_v_f_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->DrawProgress =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) DrawProgress, uppCB_v_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->putProgressName =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) putProgressName, uppCB_v_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->GetNodeInfo =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) GetNodeInfo, uppCB_b_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->GetNameFromAddr = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) GetNameFromAddr, uppCB_b_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->GetInfoFromAddr = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) GetInfoFromAddr, uppCB_b_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->IsNodelistOK = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) yep, uppCB_b_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->LookForAreaNumber = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) LookForAreaNumber, uppCB_s_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->LookForLinkNumber = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) LookForLinkNumber, uppCB_s_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->cmp2addrs = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) cmp2addrs, uppCB_b_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->addrInmask =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) addrInmask, uppCB_b_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->IsItMyAddr = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) IsItMyAddr, uppCB_b_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->FindRouteTo = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) _x_FindRouteTo, uppCB_l_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->FindRouteToN =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) FindRouteToN, uppCB_s_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->add_to_other = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) add_to_other, uppCB_v_llll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->get_flo_pathname = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) get_flo_pathname, uppCB_b_lll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->bsy_check = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) bsy_check, uppCB_b_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->bsy_raise = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) bsy_raise, uppCB_b_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->bsy_clear = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) bsy_clear, uppCB_v_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->base_bsy_check = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) base_bsy_check, uppCB_b_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->base_bsy_raise = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) base_bsy_raise, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->base_bsy_clear = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) base_bsy_clear, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->_PurgeNonDstr = 					//	call non destructive PURGE command		(ProcPtr) NewRoutineDescriptor ((ProcPtr) Purge, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->obtainHBase =				//	get handle to current opened msgbase index		(ProcPtr) NewRoutineDescriptor ((ProcPtr) _x_obtainHBase, uppCB_l_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->_Undel = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) Undel, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->Resolver = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) Resolver, uppCB_v_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->UpdatePreference_Links = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) UpdatePreference_Links, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->UpdatePreference_Areas =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) UpdatePreference_Areas, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->ExportEchoesOnlyTo = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) ExportEchoesOnlyTo, uppCB_v_lll_ProcInfo, GetCurrentISA ());//	apiRev = 0x8002	(ProcPtr) pluginscontrol->parsemask =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) parsemask, uppCB_s_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->ClonePktMsg = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) _x_ClonePktMsg, uppCB_l_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->printmask =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) _x_printmask, uppCB_l_ll_ProcInfo, GetCurrentISA ());#endif}void LookForPlugIns (void){	short			mdir;						// working directory reference numberÉ	CInfoPBRec		cipbr;						/* local pb */	HFileInfo		*fpb = (HFileInfo *)&cipbr;	/* to pointers */	short			rc, idx, err;	Str32			filename;	short			oldResFile = CurResFile (), plugResFile;	Str255			plugPath, mItem;	char			**q;	plugsChainPtr	plug;	Handle			h;	MenuHandle		theMenu;	PlugsControlPtr	pc;			if ( ( mdir = myOpenWD ( "\p:Plug-Ins:" ) ) == 0 )	{		putlog ( lgALRT, "Unable to open Plugs directory" );		return;	}	fpb->ioNamePtr = filename;	fpb->ioVRefNum = mdir;// ¥ Killing loop...	for ( idx=1; ; idx++)	{											/* indexing loop */		fpb->ioDirID = 0L;						/* must set on each loop */		fpb->ioFDirIndex = idx;		filename[0] = 0;		rc = PBGetCatInfoSync (&cipbr);		if (rc)			break;								/* exit when no more entries */		if (  !(fpb->ioFlAttrib & 16) &&				fpb->ioFlFndrInfo.fdType == 'Plug' &&				fpb->ioFlFndrInfo.fdCreator == 'RvlS' )		{			Boolean	ppc_plug;						ppc_plug = false;			pStrConc ( "\p:Plug-Ins:", filename, plugPath );			plugResFile = OpenResFile (plugPath);						while (plugResFile != -1)			{				UseResFile (plugResFile);				#if defined(powerc) || defined(__powerc)				h = Get1Resource ( 'PwPC', 0 );				if (h == NULL)					h = Get1Resource ( 'Code', 0 );				else						ppc_plug = true;#else				h = Get1Resource ( 'Code', 0 );#endif				if (!h)				{					CloseResFile (plugResFile);					break;				}								DetachResource (h);				MoveHHi (h);				HLock (h);								CloseResFile (plugResFile);								if (!plugsChain)				{					plugsChain = (plugsChainPtr) NewPtrClear (sizeof (plugsChainType));					plug = plugsChain;				}				else				{					plug->nextPlug = (plugsChainPtr) NewPtrClear (sizeof (plugsChainType));					plug = plug->nextPlug;				}								plug->nextPlug = NULL;				plug->H_Storage = h;				plug->failed = false;#if defined(powerc) || defined(__powerc)				plug->connID = NULL;				if (ppc_plug)				{					Str255	errName;									err = GetMemFragment(*h, GetHandleSize(h), filename, kLoadCFrag, &plug->connID, (Ptr *)&plug->plugEntry, errName);					if (err != noErr)					{						putlog ('!', "PPC Plug-In %#s failed to load with error [%d] %#s", filename, (int)err, errName);						plug->failed = true;					}					pc = pluginscontrolppc;				}				else				{					(char *) plug->plugEntry = (char *)						NewRoutineDescriptor ((ProcPtr) *h, uppPlugEntryProcInfo, kM68kISA);					pc = pluginscontrol;				}#else				(char *) plug->plugEntry = *h;				pc = pluginscontrol;#endif				pStrCopy (plugPath, plug->thisplug);//				pStrCopy (plugPath, pc->thisplugPath);				pc->thisplugPath = plug->thisplug;								pc->opCode = plugWelcome;								if (!plug->failed)				{#if defined(powerc) || defined(__powerc)					if (plug->connID)						plug->plugEntry (pc);					else						CallUniversalProc ((RoutineDescriptor *) plug->plugEntry, uppPlugEntryProcInfo, pc);#else					plug->plugEntry (pc);#endif					plug->opCodes = pc->retCode;				}				else					plug->opCodes = 0;								if (plug->opCodes)				{					if (plug->opCodes & plugCompExtr)					{						plug->misc.arc.archiveType = pc->misc.arc.archiveType;						plug->misc.arc.archiveAction = pc->misc.arc.archiveAction;					}					else					{	//					strncpy (plug->misc.customName, pc->misc.plugInvokeName, 8);	//	¥	obtain names here if custom presents						if ((plug->opCodes & plugCustomLaunch) && (plug->opCodes & plugCustomNames))						{							pc->opCode = plugCustomNames;						#if defined(powerc) || defined(__powerc)							if (plug->connID)								plug->plugEntry (pc);							else								CallUniversalProc ((RoutineDescriptor *) plug->plugEntry, uppPlugEntryProcInfo, pc);	#else							plug->plugEntry (pc);	#endif							if (pc->retCode != plugRetNoError)								plug->opCodes &= ~(plugCustomLaunch | plugCustomNames);							else							{	//	¥	Full menu here																q = pc->misc.names.plugInvokeNames;								theMenu = GetMenu ( 4 );								while (*q)								{									strcpy ((char *) &mItem[1], *q);									mItem[0] = strlen ((char *) &mItem[1]);																		AppendMenu (theMenu, mItem);																		q++;								}																					//			GetMenuItemText (theMenu, menuItem, DoItName);							}						}						else							plug->opCodes &= ~(plugCustomLaunch | plugCustomNames);					}				}				else				{#if defined(powerc) || defined(__powerc)					if (plug->connID)						CloseConnection(&plug->connID);					else						DisposeRoutineDescriptor ((RoutineDescriptor *) plug->plugEntry);#endif					plug->failed = true;					DisposeHandle(plug->H_Storage);				}				break;			}		}	}	myCloseWD ( mdir );		UseResFile (oldResFile);}void DisposPlugIns (void){	plugsChainPtr	plug, plug1;	PlugsControlPtr	pc;	if (plugsChain)	{		plug = plugsChain;				while (plug)		{			if (!plug->failed)			{#if defined(powerc) || defined(__powerc)				if (plug->connID)					pc = pluginscontrolppc;				else					pc = pluginscontrol;#else				pc = pluginscontrol;#endif//				pStrCopy (plug->thisplug, pc->thisplugPath);				pc->thisplugPath = plug->thisplug;				pc->opCode = plugSuicide;			#if defined(powerc) || defined(__powerc)				if (plug->connID)				{					plug->plugEntry (pc);					CloseConnection(&plug->connID);				}				else				{					CallUniversalProc ((RoutineDescriptor *) plug->plugEntry, uppPlugEntryProcInfo, pc);					DisposeRoutineDescriptor ((RoutineDescriptor *) plug->plugEntry);				}#else				plug->plugEntry (pc);#endif				DisposeHandle(plug->H_Storage);			}			plug1 = plug->nextPlug;			DisposePtr((Ptr)plug);			plug = plug1;		}	}	#if defined(powerc) || defined(__powerc)#endif}long CallPlugIns (long opcode, pktmsg *msg, long secondary){	plugsChainPtr	plug;	PlugsControlPtr	pc;	if (plugsChain)	{		plug = plugsChain;				while (plug)		{#if defined(powerc) || defined(__powerc)			if (plug->connID)				pc = pluginscontrolppc;			else				pc = pluginscontrol;#else			pc = pluginscontrol;#endif			if (opcode & plug->opCodes)			{//				pStrCopy (plug->thisplug, pc->thisplugPath);				pc->thisplugPath = plug->thisplug;								pc->opCode = opcode;								if ((opcode & plugMisc) != 0L)					pc->retCode = secondary;								pc->messageIn = msg;#if defined(powerc) || defined(__powerc)				if (plug->connID)					plug->plugEntry (pc);				else					CallUniversalProc ((RoutineDescriptor *) plug->plugEntry, uppPlugEntryProcInfo, pc);#else				plug->plugEntry (pc);#endif				if (pc->retCode)					return pc->retCode;			}			plug = plug->nextPlug;		}	}	return plugRetContinue;	}long CallNamedPlugIns (StringPtr name){	plugsChainPtr	plug;	PlugsControlPtr	pc;	name[name[0]+1] = 0;	plug = plugsChain;		while (plug)	{#if defined(powerc) || defined(__powerc)		if (plug->connID)			pc = pluginscontrolppc;		else			pc = pluginscontrol;#else		pc = pluginscontrol;#endif		if ((plug->opCodes & plugCustomLaunch) != 0)		{			pc->thisplugPath = plug->thisplug;			pc->opCode = plugCustomLaunch;			memcpy (pc->misc.plugInvokeName, (char *) &name[1], __min(15, name[0]));			pc->misc.plugInvokeName[__min(15, name[0])] = 0;			#if defined(powerc) || defined(__powerc)			if (plug->connID)				plug->plugEntry (pc);			else				CallUniversalProc ((RoutineDescriptor *) plug->plugEntry, uppPlugEntryProcInfo, pc);#else			plug->plugEntry (pc);#endif			if (pc->retCode != plugRetWrongCustom)				break;		}				plug = plug->nextPlug;	}}long CallArchiverPlugIns (Boolean Compress, Boolean Append, long Method, FSSpecPtr srcSpec, FSSpecPtr dstSpec){	plugsChainPtr	plug;	long			what = (Compress) ? arcCompress : arcExpand;	PlugsControlPtr	pc;	if (plugsChain)	{		plug = plugsChain;				while (plug)		{#if defined(powerc) || defined(__powerc)			if (plug->connID)				pc = pluginscontrolppc;			else				pc = pluginscontrol;#else			pc = pluginscontrol;#endif			if ((plug->opCodes & plugCompExtr) &&				(plug->misc.arc.archiveType & Method) &&				(plug->misc.arc.archiveAction & what))			{//				pStrCopy (plug->thisplug, pc->thisplugPath);				pc->thisplugPath = plug->thisplug;								pc->opCode = plugCompExtr;								pc->misc.arc.archiveType = Method;				pc->misc.arc.archiveAction = ((Compress) ? arcCompress : arcExpand) |																((Append) ? arcAppend : 0L);								pc->source = srcSpec;				pc->destination = (dstSpec) ? dstSpec : srcSpec;//¥				pc->archiveName = ArchName;				#if defined(powerc) || defined(__powerc)				if (plug->connID)					plug->plugEntry (pc);				else					CallUniversalProc ((RoutineDescriptor *) plug->plugEntry, uppPlugEntryProcInfo, pc);#else				plug->plugEntry (pc);#endif								return pc->retCode;			}			plug = plug->nextPlug;		}	}	return plugFatalArch;}