#include "ravel_msg_base.h"#include "Ravel_Prefs.h"#include "pktparse.h"#include "Purge.h"#include "log.h"extern	short			AreasNumber;		//	е	Areas structs listextern	areaPrefHndl	*areasHndls;extern	mailPrefHndl	mailHndl;			//	е	Netmail structvoid	DoSlice (void);void	InitProgress ( float );void	DrawProgress ( long );void	putProgressName (Str255 name);void Purge (void){	unsigned long	nowis, addon;	long			i, j, amm, msgs = 0;	msgbase_atom	Atom;	GetDateTime ( &nowis );//ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее	for ( i = 0; i <= AreasNumber+1; i++ )	{		if (i > 0 && i <= AreasNumber && ((*areasHndls[i-1])->areaflags & AREA_PASSTROUGH))			continue;		putProgressName ((i == AreasNumber+1) ? "\pBadMail" : ((i) ? (*areasHndls[i-1])->areaName : "\pNetMail"));		DoSlice ();		if ( msgbase_open_idx (i, true) == i )		{			if (amm = msgbase_getnummsg ())			{				InitProgress ( (float) amm );				addon = 60L*60L*24L* ((i == AreasNumber+1) ? 7 : ((i) ? (*areasHndls[i-1])->purger : (*mailHndl)->purger));							for (j=0; j<amm; j++)				{					if (!msgbase_read_atom ( j, &Atom ))						break;									if (!(j & 7))					{						DoSlice ();					}										DrawProgress (j);					if (Atom.base_flags & ATOM_LOCKED)						continue;										if ((((unsigned long)Atom.stored_time)+addon) < nowis)					{						msgbase_delete_message (j, ATOM_DELETED);						amm = msgbase_getnummsg ();						msgs++;						j--;					}					else						break;				}			}						msgbase_close (CLOSE_UPDATE);		}	}	InitProgress ( 1.0 );	putlog (lgNOPE, " ");	putlog (lgNOPE, "Removed:      %5ld", msgs);//ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее}void PurgeDestructive (void){	unsigned long	nowis, addon;	long			i, j, jj, amm, msgs = 0;	msgbase_atom	Atom;	GetDateTime ( &nowis );//ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее	for ( i = 0; i <= AreasNumber+1; i++ )	{		if (i > 0 && i <= AreasNumber && ((*areasHndls[i-1])->areaflags & AREA_PASSTROUGH))			continue;		putProgressName ((i == AreasNumber+1) ? "\pBadMail" : ((i) ? (*areasHndls[i-1])->areaName : "\pNetMail"));		DoSlice ();		if ( msgbase_open_idx (i, true) == i )		{			if (amm = msgbase_getnummsg ())			{				InitProgress ( (float) amm );				addon = 60L*60L*24L* ((i == AreasNumber+1) ? 7 : ((i) ? (*areasHndls[i-1])->purger : (*mailHndl)->purger));							for (j=0; j<amm; j++)				{					if (!msgbase_read_atom ( j, &Atom ))						break;									if (!(j & 7))					{						DoSlice ();					}										DrawProgress (j);					if (Atom.base_flags & ATOM_LOCKED)						continue;										Atom.msg_reply_prev = -1;					Atom.msg_reply_next = -1;										if ((((unsigned long)Atom.stored_time)+addon) < nowis)					{						Atom.base_flags |= ATOM_DELETED;											jj = msgbase_getdirty ();												if (jj != -1)						{							if (j < jj)								msgbase_setdirty (jj - 1);						}						msgbase_write_atom (j, &Atom);						msgbase_setnummsg (--amm);						msgs++;						j--;					}					else						msgbase_write_atom (j, &Atom);				}			}						msgbase_close (CLOSE_UPDATE);		}	}	InitProgress ( 1.0 );	putlog (lgNOPE, " ");	putlog (lgNOPE, "Expired msgs: %5ld", msgs);//ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее}void Undel (void){	long			i, msgs = 0;	//ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее	for ( i = 0; i <= AreasNumber+1; i++ )	{		if (i > 0 && i <= AreasNumber && ((*areasHndls[i-1])->areaflags & AREA_PASSTROUGH))			continue;		putProgressName ((i == AreasNumber+1) ? "\pBadMail" : ((i) ? (*areasHndls[i-1])->areaName : "\pNetMail"));		DoSlice ();		if ( msgbase_open_idx (i, true) == i )		{			msgs += msgbase_getnummsg ();			msgbase_undelete ();			msgs -= msgbase_getnummsg ();						msgbase_close (CLOSE_UPDATE);		}	}	putlog (lgNOPE, " ");	putlog (lgNOPE, "Restored:     %5ld", -msgs);//ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее}