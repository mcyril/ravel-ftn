/*•••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••	Copyright © 1996-1997 Wicked Cyril		При использовании исходных текстов SDK указание Copyright © 1996 Wicked Cyril		обязательно.		Так же при генерации писем обязательно упоминание название пакета Ravel в tearline.				Ravel SDK поставляется в виде "as is". Автор не несет ответственности за		несовместимость Plug-Ins в будущих версиях RavelSHUFFLER при использовании		undewater приемов программирования.				Не существует НИКАКОЙ документации по Ravel SDK.		Так же автор пока отказался от распространения исходных текстов не только работы		с базой сообщений, но и старых релизов RavelQUILL.  •••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••*/#include <string.h>#include <stdio.h>#include <A4Stuff.h>#include "ravel_msg_base.h"#include "Ravel_Prefs.h"#include "PascalStr.h"#include "Ravel_PlugIns.h"typedef struct _badStruct {	short	procede;	Ptr		msgtext;	addr	badAddr;	char	badName[64];} badType;typedef struct _badList {	short	bads;	badType	bad[];	} *badTypePtr;static char *greate1 = "Dear ";static char *greate2 = "!\xD\xDMessage from you is very undesirable at this station. Please don't distrub SysOp - you're in Twit Master's black list.\xDThank you for understanding.\xD\xD--- TwitMaster 0.0.9b for Ravel\xD";static char	*mnt[12] = { "Jan", "Feb", "Mar",						 "Apr", "May", "Jun",						 "Jul", "Aug", "Sep",						 "Oct", "Nov", "Dec" };badTypePtr	badList;void main (PlugsControlPtr plugcontrol){	Boolean		res;	short		ownFile, oldRes, i;	Handle		h;	EnterCodeResource ();	pktmsg		*m;	DateTimeRec	dtr;	char		stemp[128];	switch (plugcontrol->opCode)	{	case plugWelcome:		//	StartUp call of plug-ins. We make order and init. prefs.				res = false;		oldRes = CurResFile ();				ownFile = OpenRFPerm ( plugcontrol->thisplugPath, 0, fsRdPerm );		if (ownFile != -1)		{			UseResFile (ownFile);						h = Get1Resource ( 'pref', 0 );			if (h)			{				DetachResource (h);				MoveHHi (h);				HLock (h);				badList = (badTypePtr) *h;/*				for (i=0; i<badList->bads; i++)				{					if (badList->bad[i].msgtext)												}*/				res = true;			}						UseResFile (oldRes);			CloseResFile (ownFile);		}				plugcontrol->misc.plugInvokeName[0] = 0;					//	no custom call - no name		plugcontrol->retCode = (res) ? plugTossMsgMail : 0;	//	intercept it if success				if (res)			plugcontrol->putlog ('=', "<Twit Master> Installed.");		break;			case plugTossMsgMail:	//	We ordered only one call - on toss netmail message to _this_ system				plugcontrol->retCode = plugRetContinue;				for (i=0; i<badList->bads; i++)			if ( (badList->bad[i].badAddr.zone == -1 ||				  badList->bad[i].badAddr.zone == (plugcontrol->messageIn)->from.zone) &&				 (badList->bad[i].badAddr.net == -1 ||				  badList->bad[i].badAddr.net == (plugcontrol->messageIn)->from.net) &&				 (badList->bad[i].badAddr.node == -1 ||				  badList->bad[i].badAddr.node == (plugcontrol->messageIn)->from.node) &&				 (badList->bad[i].badAddr.point == -1 ||				  badList->bad[i].badAddr.point == (plugcontrol->messageIn)->from.point) &&				 (badList->bad[i].badName[0] == 0 ||				 	!strcmp (badList->bad[i].badName, (plugcontrol->messageIn)->fromname)) )			{				char	tmp[1024];								sprintf(tmp, "<Twit Master> Message from %s (%s) rejected.",					(plugcontrol->messageIn)->fromname,					plugcontrol->printaddr (&(plugcontrol->messageIn)->from, stemp));				plugcontrol->putlog ('=', tmp);								if (badList->bad[i].procede & 0xFF00)				{					m = (pktmsg *) NewPtr (sizeof (pktmsg));					m->from = (plugcontrol->messageIn)->to;					m->to = (plugcontrol->messageIn)->from;					m->reply = (plugcontrol->messageIn)->from;					m->reply_num = (plugcontrol->messageIn)->msgid_num;					m->msgid_num = plugcontrol->msgbase_new_msgid();					m->area[0] = 0;					m->flags = MSGPRIVATE | ((plugcontrol->messageIn)->flags & 0x80000000);	// | MSGKILL;										strcpy (m->fromname, "TwitMaster");					strcpy (m->toname, (plugcontrol->messageIn)->fromname);					strcpy (m->subj, "Your netmail has been rejected.");										GetTime ( &dtr );										dtr.year %= 100;					sprintf ( m->date, "%.2d %s %.2d  %.2d:%.2d:%.2d",									dtr.day, mnt[dtr.month-1], dtr.year, dtr.hour, dtr.minute, dtr.second );							//			Debugger ();										m->seenby.nets = NULL;					m->seenby.nodes = NULL;					m->seenby.items = 0;					m->path.nets = NULL;					m->path.nodes = NULL;					m->path.items = 0;					m->text = NewHandle (0);										PtrAndHand ( greate1, m->text, strlen (greate1) );					PtrAndHand ( m->toname, m->text, strlen (m->toname) );					PtrAndHand ( greate2, m->text, strlen (greate2) );					SetHandleSize (m->text, GetHandleSize (m->text) + 1);					(*(m->text))[GetHandleSize (m->text) - 1] = 0;										plugcontrol->RouteMessage (m, false);					plugcontrol->FreePktMsg (m);				}								switch (badList->bad[i].procede & 0x00FF)				{				case 0:				case 1:									break;								case 2:										plugcontrol->add_to_other (plugcontrol->messageIn, "BADAREA", NULL, "Debugging mirror");										break;				}								plugcontrol->retCode = ((badList->bad[i].procede & 0x00FF) == 1) ? plugRetContinue : plugRetDropMessage;				break;			}		break;		case plugSuicide:		//	Destructive call of plug-ins.			break;			default:				//	We're ignoring all other opCodes (by the way, it's impossible calls)			plugcontrol->retCode = plugRetContinue;		break;	}	ExitCodeResource ();	}