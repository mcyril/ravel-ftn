/*•••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••	Copyright © 1996-1997 Cyril Moorzin		При использовании исходных текстов SDK указание Copyright © 1996 Cyril Moorzin		обязательно.		Так же при генерации писем обязательно упоминание название пакета Ravel в tearline.				Ravel SDK поставляется в виде "as is". Автор не несет ответственности за		несовместимость Plug-Ins в будущих версиях RavelSHUFFLER при использовании		undewater приемов программирования.				Не существует НИКАКОЙ документации по Ravel SDK.		Так же автор пока отказался от распространения исходных текстов не только работы		с базой сообщений, но и старых релизов RavelQUILL.  •••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••••*/#include <string.h>#include <stdio.h>#include <A4Stuff.h>#include "ravel_msg_base.h"#include "Ravel_Prefs.h"#include "PascalStr.h"#include "Ravel_PlugIns.h"static char *greate = "Your message has been successfuly received.\xD";static char *greate1 = "Your message has been routed via this system.\xD";static char *tln = "\xD--- " SHUFFLERNAME " " RAVELVERS "\xD";		char	*rrqtext = NULL;		char	*arqtext = NULL;void ReadTemplates (StringPtr prefname);void main (PlugsControlPtr plugcontrol){	Boolean		res;	short		ownFile, oldRes, i;	Handle		h;	pktmsg		*m;	DateTimeRec	dtr;	char		stemp[64], stemp1[64], stmp[128];	Str255		plugcfg;	EnterCodeResource ();	switch (plugcontrol->opCode)	{	case plugWelcome:		//	StartUp call of plug-ins. We make order and init. prefs.		plugcontrol->retCode = plugTossMsgMail | plugTossMsgMailTrs;		plugcontrol->putlog ('=', "<RRq " RAVELISA "> Installed.");				pStrCopy (plugcontrol->thisplugPath, plugcfg);		pStrConc (plugcfg, "\p.cfg", plugcfg);		ReadTemplates (plugcfg);		break;			case plugTossMsgMail:	//	We ordered only one call - on toss netmail message to _this_ system				plugcontrol->retCode = plugRetContinue;		if ((plugcontrol->messageIn)->flags & MSGRRREQ)		{			sprintf (stmp, "<RRq> Return receipt for message from %s (%s).",				(plugcontrol->messageIn)->fromname,				plugcontrol->printaddr (&(plugcontrol->messageIn)->from, stemp) );			plugcontrol->putlog ('=', stmp);			m = (pktmsg *) NewPtrClear (sizeof (pktmsg));			m->from = (plugcontrol->messageIn)->to;			m->to = (plugcontrol->messageIn)->from;			plugcontrol->msgbase_prep_msgid (m);			plugcontrol->msgbase_prep_reply (plugcontrol->messageIn, m);			m->area[0] = 0;			m->flags = MSGPRIVATE;						strcpy (m->fromname, "RavelSHUFFLER");			strcpy (m->toname, (plugcontrol->messageIn)->fromname);			strcpy (m->subj, "Return receipt.");						plugcontrol->msgbase_ftn_date (m->date, NULL);			m->seenby.nets = NULL;			m->seenby.nodes = NULL;			m->seenby.items = 0;			m->path.nets = NULL;			m->path.nodes = NULL;			m->path.items = 0;			m->text = NewHandle (0);						if (!rrqtext)				PtrAndHand ( greate, m->text, strlen (greate) );			else				PtrAndHand ( rrqtext, m->text, strlen (rrqtext) );			PtrAndHand ( tln, m->text, strlen (tln) + 1 );						plugcontrol->RouteMessage (m, false);			plugcontrol->FreePktMsg (m);		}		/*		break;		*/		//	FALL THROUGH	case plugTossMsgMailTrs:		plugcontrol->retCode = plugRetContinue;		if ((plugcontrol->messageIn)->flags & MSGAREQ)		{			sprintf (stmp, "<RRq> Audit request for message from %s (%s) to %s (%s).",				(plugcontrol->messageIn)->fromname,				plugcontrol->printaddr (&(plugcontrol->messageIn)->from, stemp),				(plugcontrol->messageIn)->toname,				plugcontrol->printaddr (&(plugcontrol->messageIn)->to, stemp1));			plugcontrol->putlog ('=', stmp);			m = (pktmsg *) NewPtrClear (sizeof (pktmsg));			m->from = (plugcontrol->messageIn)->to;			m->to = (plugcontrol->messageIn)->from;			plugcontrol->msgbase_prep_msgid (m);			plugcontrol->msgbase_prep_reply (plugcontrol->messageIn, m);			m->area[0] = 0;			m->flags = MSGPRIVATE;						strcpy (m->fromname, "RavelSHUFFLER");			strcpy (m->toname, (plugcontrol->messageIn)->fromname);			strcpy (m->subj, "Audit request receipt.");						plugcontrol->msgbase_ftn_date (m->date, NULL);			m->seenby.nets = NULL;			m->seenby.nodes = NULL;			m->seenby.items = 0;			m->path.nets = NULL;			m->path.nodes = NULL;			m->path.items = 0;			m->text = NewHandle (0);						if (!arqtext)				PtrAndHand ( greate1, m->text, strlen (greate1) );			else				PtrAndHand ( arqtext, m->text, strlen (arqtext) );						PtrAndHand ( tln, m->text, strlen (tln) + 1 );			plugcontrol->RouteMessage (m, false);			plugcontrol->FreePktMsg (m);		}		break;		case plugSuicide:		//	Destructive call of plug-ins.			DisposePtr (rrqtext);		DisposePtr (arqtext);		break;			default:				//	We're ignoring all other opCodes (by the way, it's impossible calls)			plugcontrol->retCode = plugRetContinue;		break;	}	ExitCodeResource ();	}