//	¥	py_ftnaddr.c//	Ext. Python with definition of ftnaddr type#include "py_ftnaddr.h"#include "py_ftnmask.h"#include <extras.h>static voidftnaddr_dealloc(PyFtnAddrObject *v){	PyObject_Del(v);}static intftnaddr_compare(PyFtnAddrObject *v, PyFtnAddrObject *w){#if PYTRACK_SHUFFLER	return gPC->cmp2addrs(&v->address.ad, &w->address.ad) ? 0 : 1;#endif#if PYTRACK_STANDALONE	if ( v->address.ad.zone == w->address.ad.zone &&		 v->address.ad.net == w->address.ad.net &&		 v->address.ad.node == w->address.ad.node &&		 v->address.ad.point == w->address.ad.point )		return 0;	else		return 1;#endif}static intftnaddr_print(PyFtnAddrObject *v, FILE *fp, int flags)     /* flags -- not used but required by interface */{	char	temp[128];		fprintf(fp, printaddr(&v->address.ad, temp));	return 0;}static PyObject *ftnaddr_repr(PyFtnAddrObject *v){	char	temp[128];	printaddr(&v->address.ad, temp);	return PyString_FromString(temp);}static intftnaddr_init(PyFtnAddrObject *v, PyObject *args, PyObject *kwds){	v->address.ad.zone = -1;	v->address.ad.net = -1;	v->address.ad.node = -1;	v->address.ad.point = -1;	v->address.domain[0] = 0;	return 0;}static PyObject *ftnaddr_valid(PyFtnAddrObject *v, PyObject *arg){	long res = 0;		res =  (v->address.ad.zone > 0 &&			v->address.ad.net > 0 &&			v->address.ad.node > 0 &&			v->address.ad.point >= 0) ?  1 : 0;	return PyInt_FromLong(res);}static PyMethodDef ftnaddro_methods[] = {	{"valid",			(PyCFunction)ftnaddr_valid,	METH_NOARGS},	{NULL,		NULL}		/* sentinel */};static PyObject *ftnaddr_getattr(PyFtnAddrObject *v, char *name){	if (strcmp(name, "zone") == 0)		return PyInt_FromLong(v->address.ad.zone);	else if (strcmp(name, "net") == 0)		return PyInt_FromLong(v->address.ad.net);	else if (strcmp(name, "node") == 0)		return PyInt_FromLong(v->address.ad.node);	else if (strcmp(name, "point") == 0)		return PyInt_FromLong(v->address.ad.point);	else if (strcmp(name, "domain") == 0)		return PyString_FromStringAndSize((char *)&v->address.domain[1], v->address.domain[0]);	else		return Py_FindMethod(ftnaddro_methods, (PyObject *)v, name);	return NULL;}static intftnaddr_setattr(PyFtnAddrObject *v, char *name, PyObject *content){	int res = -1;	if(PyInt_Check(content))	{		long val = PyInt_AsLong(content);				if (strcmp(name, "zone") == 0)		{			v->address.ad.zone = val;			res = 0;		}		else if (strcmp(name, "net") == 0)		{			v->address.ad.net = val;			res = 0;		}		else if (strcmp(name, "node") == 0)		{			v->address.ad.node = val;			res = 0;		}		else if (strcmp(name, "point") == 0)		{			v->address.ad.point = val;			res = 0;		}	}	else if(PyString_Check(content))	{		if (strcmp(name, "domain") == 0)		{			memcpy(&v->address.domain[1],					PyString_AsString(content),						v->address.domain[0] = __min(31,PyString_Size(content)));			res = 0;		}	}	return res;}static PyFtnAddrObject *ftnaddr_new_ex(void){	PyFtnAddrObject *res = PyObject_New(PyFtnAddrObject, &PyFtnAddr_Type);	if (res != NULL)		PyFtnAddr_Type.tp_init((PyObject *)res, NULL, NULL);	return res;}static PyFtnAddrObject *ftnaddr_new_string(char *string){	PyFtnAddrObject *res = ftnaddr_new_ex();	if (res != NULL)	{		res->address.ad.point = 0;		parseaddr(&res->address.ad, string);	}	return res;}static PyObject *ftnaddr_new(PyTypeObject *type, PyObject *args, PyObject *kwds){	PyObject *x = NULL;	if (type != &PyFtnAddr_Type)		return NULL;	if (args)		if (!PyArg_ParseTuple(args, "|O:ftnaddr", &x))			return NULL;	if (x == NULL)		return (PyObject *)ftnaddr_new_ex();	if (PyString_Check(x))		return (PyObject *)ftnaddr_new_string(PyString_AS_STRING(x));	if (PyObject_TypeCheck(x, &PyFtnAddr_Type))	{		PyFtnAddrObject *res = ftnaddr_new_ex();		if (res != NULL)		{			res->address.ad = ((PyFtnAddrObject *)x)->address.ad;		}				return (PyObject *)res;	}	if (PyObject_TypeCheck(x, &PyFtnMask_Type))	{		PyFtnAddrObject *res = ftnaddr_new_ex();		if (res != NULL)		{			res->address.ad = ((PyFtnMaskObject *)x)->mask;		}				return (PyObject *)res;	}		return NULL;}PyTypeObject PyFtnAddr_Type = {	PyObject_HEAD_INIT(&PyType_Type)	0,	"ftnaddr",	sizeof(PyFtnAddrObject),	0,	(destructor)ftnaddr_dealloc,						/* tp_dealloc */	(printfunc)ftnaddr_print,						/* tp_print */	(getattrfunc)ftnaddr_getattr,						/* tp_getattr */	(setattrfunc)ftnaddr_setattr,						/* tp_setattr */	(cmpfunc)ftnaddr_compare,						/* tp_compare */	(reprfunc)ftnaddr_repr,						/* tp_repr */	0,					/* tp_as_number */	0,					/* tp_as_sequence */	0,					/* tp_as_mapping */	0,					/* tp_hash */	0,					/* tp_call */	0,					/* tp_str */	0,					/* tp_getattro */	0,					/* tp_setattro */	0,					/* tp_as_buffer */	Py_TPFLAGS_DEFAULT | Py_TPFLAGS_BASETYPE,						/* tp_flags */	0,					/* tp_doc */	0,					/* tp_traverse */	0,					/* tp_clear */	0,					/* tp_richcompare */	0,					/* tp_weaklistoffset */	0,					/* tp_iter */	0,					/* tp_iternext */	0,					/* tp_methods */	0,					/* tp_members */	0,					/* tp_getset */	0,					/* tp_base */	0,					/* tp_dict */	0,					/* tp_descr_get */	0,					/* tp_descr_set */	0,					/* tp_dictoffset */	(initproc)ftnaddr_init,						/* tp_init */	0,					/* tp_alloc */	ftnaddr_new,		/* tp_new */};static PyObject *meth_ftnaddr_new(PyObject *self, PyObject *args){	return ftnaddr_new(&PyFtnAddr_Type, args, NULL);}static PyMethodDef ftnaddr_methods[] = {	{"new",		meth_ftnaddr_new,		METH_VARARGS},	{NULL,		NULL}		/* sentinel */};#pragma mark -DL_EXPORT(PyObject *)initftnaddr(void){	/* Initialize the type of the new type object here; doing it here	 * is required for portability to Windows without requiring C++. */	PyFtnAddr_Type.ob_type = &PyType_Type;	/* Create the module and add the functions */	return Py_InitModule("ftnaddr", ftnaddr_methods);}PyObject *PyFtnAddr_New(PyObject *args){	return ftnaddr_new(&PyFtnAddr_Type, args, NULL);}PyObject *PyFtnAddr_NewStr(char *str){	return (PyObject *)ftnaddr_new_string(str);}PyObject *PyFtnAddr_NewAddr(addr *address){	PyFtnAddrObject *res = ftnaddr_new_ex();	if(res)		res->address.ad = *address;	return (PyObject *)res;}