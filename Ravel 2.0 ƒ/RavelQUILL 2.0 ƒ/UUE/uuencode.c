#include <string.h>#include <stdio.h>#include "hqx.h"#define SUMSIZE 64  /* 6 bits */#define ENC(c) ((c) ? ((c) & 077) + ' ': '`')long	totalsize=0;	/* Used to count the file size because ftell() does							not return sane results for pipes *//* * output one group of 3 bytes, pointed at by p, on file f. * return the checksum increment. */static short outdec (char *p, char **q){	short	c1, c2, c3, c4;	c1 = *p >> 2;	c2 = (*p << 4) & 060 | (p[1] >> 4) & 017;	c3 = (p[1] << 2) & 074 | (p[2] >> 6) & 03;	c4 = p[2] & 077;//	putc(ENC(c1), f);	*(*q)++ = ENC(c1);//	putc(ENC(c2), f);	*(*q)++ = ENC(c2);//	putc(ENC(c3), f);	*(*q)++ = ENC(c3);//	putc(ENC(c4), f);	*(*q)++ = ENC(c4);	return((p[0]+p[1]+p[2]) % SUMSIZE);}/* * copy from in to out, encoding as you go along. */static OSErr encode (short refnum, HQXSink dst, long refcon){	char	buf[80], buff[128], *p;	short	i, n, checksum, err;	long	count;	for (;;)	{		/* 1 (up to) 45 character line */				p = buff;				count = 45;		err = FSRead (refnum, &count, buf);		n = count;		if (err == -39)		/* eofErr on Macintosh    */			err = 0;		/* no error on any system */		if (err != noErr)			n = err;//		putc(ENC(n), out);		*p++ = ENC(n);				checksum = 0;		for (i=0; i<n; i += 3)		    checksum = (checksum + outdec(&buf[i], &p)) % SUMSIZE;//		putc(ENC(checksum), out);//		*p++ = ENC(checksum);//		putc('\n', out);		*p++ = '\r';		*p++ = 0;		dst (buff, strlen (buff), refcon);				if (n <= 0)			break;	}}OSErr UUEncode (StringPtr name, short vol, long dir, HQXSink dst, long refcon){	short	mode, err, refnum;	char	buff[128];	mode = 0644;	    /* Default permissions */	err = HOpenDF (vol, dir, name, fsRdPerm, &refnum);	GetEOF (refnum, &totalsize);	if (err != noErr)		return err;	sprintf (buff, "\rbegin %o %#s\r", mode, name);	dst (buff, strlen (buff), refcon);		encode (refnum, dst, refcon);	sprintf (buff, "end\r");	dst (buff, strlen (buff), refcon);	sprintf (buff, "size %ld\r", totalsize);	dst (buff, strlen (buff), refcon);	FSClose (refnum);	return noErr;}