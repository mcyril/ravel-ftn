#include <string.h>//#include "Ravel_FTN.h"#include "ravel_msg_base.h"#include "ravel_tmp_base.h"#include "Ravel_Prefs.h"#include "PascalStr.h"#include "myEnv.h"#include "stringutl.h"#include "nodelist.h"#include "AreaUtils.h"#include "Pathes.h"#include "log.h"#include "Plug-Ins.h"#include "pktparse.h"#include "TE32K.h"#include "PopUpLib.h"#include "myTEdit.h"#include "CommonData.h"#include "WindowsList.h"extern	homeHndl		homesystem;			//	¥	Home system structextern	mailPrefHndl	mailHndl;			//	¥	Netmail structextern	short			AreasNumber;		//	¥	Areas structs listextern	areaPrefHndl	*areasHndls;extern	Str255			nodePath;		plugsChainPtr	plugsChain = NULL;		PlugsQControlPtr	pluginscontrol = NULL;#if defined(powerc) || defined(__powerc)		PlugsQControlPtr	pluginscontrolppc = NULL;#endifenum {	uppPlugEntryProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(Ptr))),		uppCB_v_v_ProcInfo = kThinkCStackBased,	uppCB_v_lllb_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(4, SIZE_CODE(sizeof(Boolean))),	uppCB_l_lll_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long))),	uppCB_l_bblll_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(4, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(5, SIZE_CODE(sizeof(long))),	uppCB_l_l_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long))),	uppCB_v_llllb_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(4, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(5, SIZE_CODE(sizeof(Boolean))),	uppCB_s_s_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(short)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(short))),	uppCB_b_v_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(Boolean))),	uppCB_b_ll_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long))),	uppCB_b_lll_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long))),	uppCB_v_lll_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long))),	uppCB_b_lb_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(Boolean))),	uppCB_b_lls_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(short))),	uppCB_l_v_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(long))),	uppCB_v_l_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long))),	uppCB_v_cl_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(char)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long))),	uppCB_l_ll_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long))),	uppCB_l_ls_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(short))),	uppCB_b_l_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long))),	uppCB_v_lb_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(Boolean))),	uppCB_v_ll_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long))),	uppCB_v_llb_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(Boolean))),	uppCB_v_lllllb_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(4, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(5, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(6, SIZE_CODE(sizeof(Boolean))),	uppCB_v_llll_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(4, SIZE_CODE(sizeof(long))),	uppCB_v_slllll_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(short)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(4, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(5, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(6, SIZE_CODE(sizeof(long))),	uppCB_s_lll_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(short)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long))),	uppCB_s_l_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(short)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long))),	uppCB_s_ll_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(short)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(long))),	uppCB_s_sb_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(short)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(Boolean))),	uppCB_v_s_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(short))),	uppCB_v_f_ProcInfo = kThinkCStackBased		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(float))),	uppCB_l_bbllll_ProcInfo = kThinkCStackBased		 | RESULT_SIZE(SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(1, SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(2, SIZE_CODE(sizeof(Boolean)))		 | STACK_ROUTINE_PARAMETER(3, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(4, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(5, SIZE_CODE(sizeof(long)))		 | STACK_ROUTINE_PARAMETER(6, SIZE_CODE(sizeof(long)))};void	DoSlice (void);OSErr	FindAProcess (OSType typeToFind, OSType creatorToFind, ProcessSerialNumberPtr processSN);short	LookForAreaNumber ( char *AreaName );void	UpdatePreference_Links (void);void	UpdatePreference_Areas (void);Boolean	PrepareUnlock();void	PerformUnlock();void	SimulateScanComplete();static void _putlog ( char status, char *loginfo ){	putlog (status, "%s", loginfo);}static long _x_printaddr ( addr *f, char *_ftmp ){	return (long)printaddr ( f, _ftmp );}static long _x_FindRouteTo ( addr *Addr ){	return (long)FindRouteTo ( Addr );}static long _x_obtainHBase (void){	return (long)obtainHBase ();}void PreparePlugsStructure (void){	if (!pluginscontrol)	{		pluginscontrol = (PlugsQControlPtr) NewPtrClear (sizeof (PlugsQControl));		if (!pluginscontrol)		{			putlog ( lgALRT, "Not enough memory for init plugsÉ" );			ExitToShell ();		}	}#if defined(powerc) || defined(__powerc)	if (!pluginscontrolppc)	{		pluginscontrolppc = (PlugsQControlPtr) NewPtrClear (sizeof (PlugsQControl));		if (!pluginscontrolppc)		{			putlog ( lgALRT, "Not enough memory for init plugsÉ" );			ExitToShell ();		}	}#endif	pluginscontrol->apiRev = kCurrentQPlugAPI;		pluginscontrol->Preferences.homesystem = homesystem;		//	Home system struct			pluginscontrol->Preferences.mailHndl = mailHndl;			//	Netmail struct			pluginscontrol->Preferences.AreasNumber = AreasNumber;		//	Areas structs list	pluginscontrol->Preferences.areasHndls = areasHndls;			pluginscontrol->Preferences.BundlesPath = workPath;			//	working folder for bundling outbound	pluginscontrol->Preferences.OutboundPath = outboundPath;	//	outbound folder	pluginscontrol->Preferences.InboundPath = inboundPath;		//	inbound folder	pluginscontrol->Preferences.BasePath = basePath;			//	base storage folder	pluginscontrol->Preferences.TempPath = tempPath;			//	temp folder (fe. for unpacking)	pluginscontrol->Preferences.NodeLists = nodePath;			//	Nodelist path	pluginscontrol->Preferences.LogPath = logPath;				//	Log path	pluginscontrol->CallPlugIns = CallPlugIns;	pluginscontrol->CallNamedPlugIns = CallNamedPlugIns;	pluginscontrol->msgbase_create_unique_name = msgbase_create_unique_name;	pluginscontrol->msgbase_open = msgbase_open;	pluginscontrol->msgbase_open_idx = msgbase_open_idx;	pluginscontrol->msgbase_close = msgbase_close;	pluginscontrol->msgbase_read_atom = msgbase_read_atom;	pluginscontrol->msgbase_write_atom = msgbase_write_atom;	pluginscontrol->msgbase_getnummsg = msgbase_getnummsg;	pluginscontrol->msgbase_setnummsg = msgbase_setnummsg;	pluginscontrol->msgbase_getlastread = msgbase_getlastread;	pluginscontrol->msgbase_setlastread = msgbase_setlastread;	pluginscontrol->msgbase_getdirty = msgbase_getdirty;	pluginscontrol->msgbase_setdirty = msgbase_setdirty;	pluginscontrol->msgbase_read_message = msgbase_read_message;	pluginscontrol->msgbase_append_message = msgbase_append_message;	pluginscontrol->msgbase_ftn_date = msgbase_ftn_date;	pluginscontrol->msgbase_scanforme = msgbase_scanforme;	pluginscontrol->msgbase_scanunread = msgbase_scanunread;	pluginscontrol->msgbase_allread = msgbase_allread;	pluginscontrol->msgbase_prep_reply = msgbase_prep_reply;	pluginscontrol->msgbase_prep_msgid = msgbase_prep_msgid;	pluginscontrol->msgbase_new_msgid = msgbase_new_msgid;	pluginscontrol->msgbase_insert_message = msgbase_insert_message;	pluginscontrol->msgbase_delete_message = msgbase_delete_message;	pluginscontrol->FreePktMsg = FreePktMsg;	pluginscontrol->tmpbase_open = tmpbase_open;	pluginscontrol->tmpbase_add = tmpbase_add;	pluginscontrol->tmpbase_close = tmpbase_close;	pluginscontrol->putlog = _putlog;	pluginscontrol->parseaddr = parseaddr;	pluginscontrol->printaddr = _x_printaddr;	pluginscontrol->FindAProcess = FindAProcess;	pluginscontrol->Slice = DoSlice;	pluginscontrol->GetNodeInfo = GetNodeInfo;	pluginscontrol->GetNameFromAddr = GetNameFromAddr;	pluginscontrol->GetInfoFromAddr = GetInfoFromAddr;	pluginscontrol->IsNodelistOK = yep;//	call-back routines set//	apiRev == 0x8003	pluginscontrol->PrepareUnlock = PrepareUnlock;	pluginscontrol->PerformUnlock = PerformUnlock;	pluginscontrol->SimulateScanComplete = SimulateScanComplete;//	GUI will be implemented in 0x8004	pluginscontrol->getFrontWindowType = getFrontWindowType;	pluginscontrol->sendCommandToWindow = sendCommandToWindow;#if defined(powerc) || defined(__powerc)		BlockMove(pluginscontrol, pluginscontrolppc, sizeof(PlugsQControl));		(ProcPtr) pluginscontrol->CallPlugIns =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) CallPlugIns, uppCB_l_lll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->CallNamedPlugIns = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) CallNamedPlugIns, uppCB_l_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_create_unique_name =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_create_unique_name, uppCB_v_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_open =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_open, uppCB_s_sb_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_open_idx =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_open_idx, uppCB_s_sb_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_close =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_close, uppCB_v_s_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_read_atom =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_read_atom, uppCB_b_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_write_atom =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_write_atom, uppCB_b_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_getnummsg =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_getnummsg, uppCB_l_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_setnummsg =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_setnummsg, uppCB_v_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_getlastread =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_getlastread, uppCB_l_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_setlastread =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_setlastread, uppCB_v_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_getdirty =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_getdirty, uppCB_l_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_setdirty =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_setdirty, uppCB_v_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_read_message =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_read_message, uppCB_b_lls_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_append_message =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_append_message, uppCB_b_lb_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_ftn_date =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_ftn_date, uppCB_v_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_scanforme =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_scanforme, uppCB_b_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_scanunread =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_scanunread, uppCB_l_ls_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_allread =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_allread, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_prep_reply =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_prep_reply, uppCB_v_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_prep_msgid =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_prep_msgid, uppCB_v_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_new_msgid =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_new_msgid, uppCB_l_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_insert_message =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_insert_message, uppCB_v_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->msgbase_delete_message =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) msgbase_delete_message, uppCB_v_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->FreePktMsg =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) FreePktMsg, uppCB_v_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->tmpbase_open =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) tmpbase_open, uppCB_b_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->tmpbase_add =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) tmpbase_add, uppCB_s_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->tmpbase_close =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) tmpbase_close, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->putlog =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) _putlog, uppCB_v_cl_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->parseaddr =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) parseaddr, uppCB_s_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->printaddr =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) _x_printaddr, uppCB_l_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->FindAProcess =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) FindAProcess, uppCB_s_lll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->Slice =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) DoSlice, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->GetNodeInfo =		(ProcPtr) NewRoutineDescriptor ((ProcPtr) GetNodeInfo, uppCB_b_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->GetNameFromAddr = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) GetNameFromAddr, uppCB_b_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->GetInfoFromAddr = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) GetInfoFromAddr, uppCB_b_ll_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->IsNodelistOK = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) yep, uppCB_b_v_ProcInfo, GetCurrentISA ());//	call-back routines set//	apiRev == 0x8003	(ProcPtr) pluginscontrol->PrepareUnlock = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) PrepareUnlock, uppCB_b_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->PerformUnlock = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) PerformUnlock, uppCB_v_v_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->SimulateScanComplete = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) SimulateScanComplete, uppCB_v_v_ProcInfo, GetCurrentISA ());//	GUI will be implemented in 0x8004	(ProcPtr) pluginscontrol->getFrontWindowType = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) getFrontWindowType, uppCB_l_l_ProcInfo, GetCurrentISA ());	(ProcPtr) pluginscontrol->sendCommandToWindow = 		(ProcPtr) NewRoutineDescriptor ((ProcPtr) sendCommandToWindow, uppCB_l_lll_ProcInfo, GetCurrentISA ());#endif}void LookForPlugIns (void){	short			mdir;						// working directory reference numberÉ	CInfoPBRec		cipbr;						/* local pb */	HFileInfo		*fpb = (HFileInfo *)&cipbr;	/* to pointers */	short			rc, idx, err;	Str32			filename;	short			oldResFile = CurResFile (), plugResFile;	Str255			plugPath, mItem;	char			**q;	plugsChainPtr	plug;	Handle			h;	MenuHandle		theMenu;	PlugsQControlPtr	pc;			if ( ( mdir = myOpenWD ( "\p:Plug-Ins:" ) ) == 0 )	{		putlog ( lgALRT, "Unable to open Plugs directory" );		return;	}	fpb->ioNamePtr = filename;	fpb->ioVRefNum = mdir;// ¥ Killing loop...	for ( idx=1; ; idx++)	{											/* indexing loop */		fpb->ioDirID = 0L;						/* must set on each loop */		fpb->ioFDirIndex = idx;		filename[0] = 0;		rc = PBGetCatInfoSync (&cipbr);		if (rc)			break;								/* exit when no more entries */		if (  !(fpb->ioFlAttrib & 16) &&				fpb->ioFlFndrInfo.fdType == 'Plug' &&				fpb->ioFlFndrInfo.fdCreator == 'RvlQ' )		{			Boolean	ppc_plug;						ppc_plug = false;			pStrConc ( "\p:Plug-Ins:", filename, plugPath );			plugResFile = OpenResFile (plugPath);						while (plugResFile != -1)			{				UseResFile (plugResFile);				#if defined(powerc) || defined(__powerc)				h = Get1Resource ( 'PwPC', 0 );				if (h == NULL)					h = Get1Resource ( 'Code', 0 );				else						ppc_plug = true;#else				h = Get1Resource ( 'Code', 0 );#endif				if (!h)				{					CloseResFile (plugResFile);					break;				}								DetachResource (h);				MoveHHi (h);				HLock (h);								CloseResFile (plugResFile);								if (!plugsChain)				{					plugsChain = (plugsChainPtr) NewPtrClear (sizeof (plugsChainType));					plug = plugsChain;				}				else				{					plug->nextPlug = (plugsChainPtr) NewPtrClear (sizeof (plugsChainType));					plug = plug->nextPlug;				}								plug->nextPlug = NULL;				plug->H_Storage = h;#if defined(powerc) || defined(__powerc)				plug->connID = NULL;				if (ppc_plug)				{					Str255	errName;									err = GetMemFragment(*h, GetHandleSize(h), filename, kLoadCFrag, &plug->connID, (Ptr *)&plug->plugEntry, errName);					pc = pluginscontrolppc;				}				else				{					(char *) plug->plugEntry = (char *)						NewRoutineDescriptor ((ProcPtr) *h, uppPlugEntryProcInfo, kM68kISA);					pc = pluginscontrol;				}#else				(char *) plug->plugEntry = *h;				pc = pluginscontrol;#endif				pStrCopy (plugPath, plug->thisplug);//				pStrCopy (plugPath, pc->thisplugPath);				pc->thisplugPath = plug->thisplug;								pc->opCode = plugWelcome;				#if defined(powerc) || defined(__powerc)				if (plug->connID)					plug->plugEntry (pc);				else					CallUniversalProc ((RoutineDescriptor *) plug->plugEntry, uppPlugEntryProcInfo, pc);#else				plug->plugEntry (pc);#endif				plug->opCodes = pc->retCode;								{//					strncpy (plug->misc.customName, pc->misc.plugInvokeName, 8);//	¥	obtain names here if custom presents					if ((plug->opCodes & plugCustomLaunch) && (plug->opCodes & plugCustomNames))					{						pc->opCode = plugCustomNames;				#if defined(powerc) || defined(__powerc)						if (plug->connID)							plug->plugEntry (pc);						else							CallUniversalProc ((RoutineDescriptor *) plug->plugEntry, uppPlugEntryProcInfo, pc);#else						plug->plugEntry (pc);#endif						if (pc->retCode != plugRetNoError)							plug->opCodes &= ~(plugCustomLaunch | plugCustomNames);						else						{//	¥	Full menu here														q = pc->misc.names.plugInvokeNames;							theMenu = GetMenu ( 263 );							while (*q)							{								strcpy ((char *) &mItem[1], *q);								mItem[0] = strlen ((char *) &mItem[1]);																AppendMenu (theMenu, mItem);																q++;							}																		//			GetMenuItemText (theMenu, menuItem, DoItName);						}					}					else						plug->opCodes &= ~(plugCustomLaunch | plugCustomNames);				}								break;			}		}	}	myCloseWD ( mdir );		UseResFile (oldResFile);}void DisposPlugIns (void){	plugsChainPtr	plug, plug1;	PlugsQControlPtr	pc;	if (plugsChain)	{		plug = plugsChain;				while (plug)		{#if defined(powerc) || defined(__powerc)			if (plug->connID)				pc = pluginscontrolppc;			else				pc = pluginscontrol;#else			pc = pluginscontrol;#endif//			pStrCopy (plug->thisplug, pc->thisplugPath);			pc->thisplugPath = plug->thisplug;			pc->opCode = plugSuicide;			#if defined(powerc) || defined(__powerc)			if (plug->connID)			{				plug->plugEntry (pc);				CloseConnection(&plug->connID);			}			else			{				CallUniversalProc ((RoutineDescriptor *) plug->plugEntry, uppPlugEntryProcInfo, pc);				DisposeRoutineDescriptor ((RoutineDescriptor *) plug->plugEntry);			}#else			plug->plugEntry (pc);#endif			DisposeHandle(plug->H_Storage);			plug1 = plug->nextPlug;			DisposePtr((Ptr)plug);			plug = plug1;		}	}	#if defined(powerc) || defined(__powerc)#endif}long CallPlugIns (long opcode, pktmsg *msg, long secondary){	plugsChainPtr	plug;	PlugsQControlPtr	pc;	if (plugsChain)	{		plug = plugsChain;				while (plug)		{#if defined(powerc) || defined(__powerc)			if (plug->connID)				pc = pluginscontrolppc;			else				pc = pluginscontrol;#else			pc = pluginscontrol;#endif			if (opcode & plug->opCodes)			{//				pStrCopy (plug->thisplug, pc->thisplugPath);				pc->thisplugPath = plug->thisplug;								pc->opCode = opcode;								if ((opcode & plugMisc) != 0L)					pc->retCode = secondary;								pc->messageIn = msg;#if defined(powerc) || defined(__powerc)				if (plug->connID)					plug->plugEntry (pc);				else					CallUniversalProc ((RoutineDescriptor *) plug->plugEntry, uppPlugEntryProcInfo, pc);#else				plug->plugEntry (pc);#endif				if (pc->retCode)					return pc->retCode;			}			plug = plug->nextPlug;		}	}	return plugRetContinue;	}long CallParmPlugIns (long opcode, pktmsg *msg, long buffsize, long *actualsize, char *databuff, long secondary){	plugsChainPtr	plug;	PlugsQControlPtr	pc;	if (plugsChain)	{		plug = plugsChain;				while (plug)		{#if defined(powerc) || defined(__powerc)			if (plug->connID)				pc = pluginscontrolppc;			else				pc = pluginscontrol;#else			pc = pluginscontrol;#endif			if (opcode & plug->opCodes)			{//				pStrCopy (plug->thisplug, pc->thisplugPath);				pc->thisplugPath = plug->thisplug;								pc->opCode = opcode;								if ((opcode & plugMisc) != 0L)					pc->retCode = secondary;								pc->messageIn = msg;				pc->misc.string.stringBuffSize = buffsize;				pc->misc.string.stringBuff = databuff;#if defined(powerc) || defined(__powerc)				if (plug->connID)					plug->plugEntry (pc);				else					CallUniversalProc ((RoutineDescriptor *) plug->plugEntry, uppPlugEntryProcInfo, pc);#else				plug->plugEntry (pc);#endif				if (pc->retCode)				{					*actualsize = pc->misc.string.stringActualSize;					return pc->retCode;				}			}			plug = plug->nextPlug;		}	}	return plugRetContinue;	}long CallNamedPlugIns (StringPtr name){	plugsChainPtr	plug;	PlugsQControlPtr	pc;	name[name[0]+1] = 0;	plug = plugsChain;		while (plug)	{#if defined(powerc) || defined(__powerc)		if (plug->connID)			pc = pluginscontrolppc;		else			pc = pluginscontrol;#else		pc = pluginscontrol;#endif		if ((plug->opCodes & plugCustomLaunch) != 0)		{			pc->thisplugPath = plug->thisplug;			pc->opCode = plugCustomLaunch;			memcpy (pc->misc.plugInvokeName, (char *) &name[1], __min(15, name[0]));			pc->misc.plugInvokeName[__min(15, name[0])] = 0;			#if defined(powerc) || defined(__powerc)			if (plug->connID)				plug->plugEntry (pc);			else				CallUniversalProc ((RoutineDescriptor *) plug->plugEntry, uppPlugEntryProcInfo, pc);#else			plug->plugEntry (pc);#endif			if (pc->retCode != plugRetWrongCustom)				break;		}				plug = plug->nextPlug;	}}