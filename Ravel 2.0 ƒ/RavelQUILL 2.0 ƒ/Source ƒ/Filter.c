#include <string.h>#include "ravel_msg_base.h"#include "Ravel_Prefs.h"#include "stringutl.h"#include "PascalStr.h"#include "Filter.h"Boolean	needfilter;Str255	replyaddr;extern	short			AreasNumber;		//	¥	Areas structs listextern	areaPrefHndl	*areasHndls;void callFilter ( Handle text ){	unsigned char	*s, *t;//	if (needfilter)//		return;	HLock (text);	s = (unsigned char *) *text;	t = (unsigned char *) *text;		while (*s)	{		if ((*s == 0x01 || !strncmp ((char *) s, "SEEN-BY: ", 9)) && !needfilter)		{			while (*s && *s != 0x0D)				s++;						if (*s == 0x0D)				s++;		}		else		{			while (*s && *s != 0x0D)			{				if (*s < 0x20 && *s > 0x09)					*t = ' ';				else					*t = *s;				s++;				t++;			}						if (*s == 0x0D)			{				*t = *s;				s++;				t++;			}		}	}		*t = 0;	HUnlock (text);	SetHandleSize ( text, strlen (*text) + 1 );	HLock (text);}void forwardFilter (Handle text){	Ptr		s = *text;	while (*s)	{		if (*s == 0x01)		{			*s = '@';			s++;						while (*s && *s != 0x0D)				s++;						if (*s == 0x0D)				s++;		}		else		{			if ( !strncmp ( s, "--- ", 4 ) || !strncmp ( s, "---\r", 4 ))				memcpy ( s, "-+", 2 );			else				if ( !strncmp ( s, " * Origin: ", 11 ) )					memcpy ( s, " +", 2 );				else					if (!strncmp (s, "SEEN-BY: ", 9))		//	SEEN-BY:						memcpy ( s, "SEEN+", 5 );			while (*s && *s != 0x0D)				s++;						if (*s == 0x0D)				s++;		}	}}void parseForInternetReply ( Handle text, char *toname, addr *to ){	Ptr		s = *text;	short	i;	Str255	stemp;			stemp[0] = 0;	replyaddr[0] = 0;		while (*s)	{		if (*s == 0x01)		{			if ( !strncmp ( "\1REPLYTO ", s, 9) )			{				s += 9;								i = parseaddr ( to, s );								s += i;			//	+1;		//		stemp[0] = 0;								i = 1;				while ( *s != 0x0D )				{					if (*s != ' ')					{						stemp[i] = *s;						i++;					}										s++;				}								stemp[0] = i-1;			}			else				if ( !strncmp ( "\1REPLYADDR ", s, 11) )				{					s += 11;										i = 1;					while ( *s != 0x0D )					{						replyaddr[i] = *s;						s++;						i++;					}										replyaddr[0] = i-1;				}				else					if ( !strncmp ( "\1REPLYTO: ", s, 10) )					{						s += 10;												i = parseaddr ( to, s );												s += i;			//	+1;				//		stemp[0] = 0;												i = 1;						while ( *s != 0x0D )						{							if (*s != ' ')							{								stemp[i] = *s;								i++;							}														s++;						}												stemp[0] = i-1;					}					else						if ( !strncmp ( "\1REPLYADDR: ", s, 12) )						{							s += 12;														i = 1;							while ( *s != 0x0D )							{								replyaddr[i] = *s;								s++;								i++;							}														replyaddr[0] = i-1;						}						else							if ( !strncmp ( "Reply-To: ", s, 10) )							{								s += 10;																i = 1;								while ( *s != 0x0D )								{									stemp[i] = *s;									s++;									i++;								}																stemp[0] = i-1;							}						while (*s && *s != 0x0D)				s++;						if (*s == 0x0D)				s++;		}		else		{			while (*s && *s != 0x0D)				s++;						if (*s == 0x0D)				s++;		}	}		if (stemp[0])	{		stemp[stemp[0]+1] = 0;		strncpy ( toname, (char *) &stemp[1], MName );			if (!pStrComp (stemp, replyaddr))			replyaddr[0] = 0;	}}short parseForCC (Handle text){	Str255	area;	Ptr		s = *text, q;	short	i;		q = (char *)&area[1];	area[0] = 0;		while (*s)	{		if (*s == 0x01)		{			if ( !strncmp ( "\1AREA: ", s, 7) )			{				s += 7;								i = 0;				while ( *s && *s != 0x0D && i < 254)				{					*q++ = *s++;					i++;				}								*q = 0;				area[0] = strlen ((char *)&area[1]);								break;			}						while (*s && *s != 0x0D)				s++;						if (*s == 0x0D)				s++;		}		else			break;	}		if (area[0])	{		for ( i = 0; i < AreasNumber; i++ )			if ( !pStrComp ( (*areasHndls[i])->areaName, area ) )				break;		return ( i == AreasNumber ) ? -1 : i+1;	}		return -1;}