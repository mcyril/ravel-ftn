#include <string.h>#include <stdio.h>#include "PascalStr.h"//#include "Ravel_FTN.h"#include "ravel_msg_base.h"#include "Ravel_Prefs.h"#include "Preferences.h"#include "key.h"Str255			Pathes[6];Str255			nodePath;Str255			ShufflerPathName;homeHndl		homesystem;			//	•	Home system structmailPrefHndl	mailHndl;			//	•	Netmail structshort			AreasNumber;		//	•	Areas structs listareaPrefHndl	*areasHndls;Boolean ReadPreference (void){	Handle	h;	short	prefResNum = OpenResFile ( prefFile );	short	oldResNum = CurResFile ();	Boolean	res = FALSE;	short	i, j;	Str255	temp;	FSSpec	spec;	long	dummy;		if ( prefResNum == -1 )		return res;	UseResFile ( prefResNum );	h = Get1Resource ('VERS', 0);	if (!h || **h != 2)		return res;		ReleaseResource (h);		do {	//•	Get Shuffler PathName			h = Get1Resource ( 'STR ', 100 );		pStrCopy ( (h) ? (unsigned char *) *h : "\p:RavelSHUFFLER", ShufflerPathName );		ReleaseResource (h);				if (!ShufflerPathName[0])			pStrCopy ( "\p:RavelSHUFFLER", ShufflerPathName );		//•	Get pathes…			if ( Get1Resource ( 'STR#', PathID ) && !LMGetResErr () )		{					for ( i = 0; i < _logPath; i++ )			{				GetIndString ( Pathes[i], PathID, i+1 );				Pathes[i][Pathes[i][0]+1] = 0;			}				//•	Check/Create all folders…				for ( i = 0; i < _basePath; i++ )			{				pStrCopy ( Pathes[i], temp );	//			temp[0]--;								if ( FSMakeFSSpec ( 0, 0, temp, &spec ) == fnfErr )				{					if ( DirCreate ( 0, 0, temp, &dummy ) )						return FALSE;				}			}		}		else			break;		//•	NodeList path			GetIndString ( nodePath, PathID, 7 );	//•	Get home system info…			if ( (h = Get1Resource ( homeRes, 0 )) != NULL )		{			DetachResource ( h );			MoveHHi ( h );			HLock ( h );		}		else			break;				homesystem = (homeHndl) h;	//•	Get netmail desc…			if ( (h = Get1Resource ( mailRes, 0 )) != NULL )		{			DetachResource ( h );			MoveHHi ( h );			HLock ( h );		}		else			break;				mailHndl = (mailPrefHndl) h;	//•	Get areas desc…			AreasNumber = Count1Resources ( areasRes );		areasHndls = (areaPrefHndl *) NewPtr ( AreasNumber * sizeof (Handle) );				for ( i = 1, j = 0; ; i++ )			if ( (h = Get1Resource ( areasRes, i )) != NULL )			{				DetachResource ( h );				MoveHHi ( h );				HLock ( h );					//•	Ignore all pass-through echoes								if ((((*((areaPrefHndl) h))->areaflags) & AREA_PASSTROUGH) != 0)				{					AreasNumber--;					DisposeHandle (h);				}				else					areasHndls[j++] = (areaPrefHndl) h;			}			else				break;		if ( j != AreasNumber )			break;#ifndef LITE#ifdef PROTECTED		h = Get1Resource ( 'TEXT', 0 );		if (h)			DetachResource (h);				keyHandle = h;#endif#endif				res = TRUE;	} while (0);	UseResFile ( oldResNum );	CloseResFile ( prefResNum );	return res;}void KillPreference (void){	short	i;//•	Get pathes…	//	no destruction//•	Get home system info…	DisposeHandle ( (Handle) homesystem );//•	Get netmail desc…	DisposeHandle ( (Handle) mailHndl );//•	Get areas desc…	for (i=0; i<AreasNumber; i++)		DisposeHandle ( (Handle) areasHndls[i] );		DisposePtr ( (Ptr) areasHndls);#ifndef LITE#ifdef PROTECTED	if (keyHandle)		DisposeHandle ( keyHandle );#endif#endif}