#include <Sound.h>#include <stdio.h>#include <string.h>#include "TE32K.h"/*ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее*///#include "Ravel_FTN.h"#include "ravel_msg_base.h"#include "Ravel_Prefs.h"#include "Preferences.h"#include "pktparse.h"#include "rPrinting.h"//#include "BaseManager.h"#include "nodelist.h"/*ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее*/#include "PascalStr.h"#include "stringutl.h"#include "DialogLib.h"#include "WSubjects.h"#include "WView.h"#include "WEdit.h"#include "WASelect.h"#include "WNodes.h"#include "WFind.h"#include "WAddressee.h"#include "NodeCookie.h"#include "PopUpLib.h"#include "myTEdit.h"#include "CommonData.h"#include "WindowsList.h"#include "Filter.h"#include "multisaver.h"#include "SoundLib.h"/*ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее*/#include "Templates.h"#include "rMenus.h"/*ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее*/void		DeleteMark (long area, long message);extern	short	viewFont;extern	Handle	*markArray;extern	Cursor	crs[3];extern	short	crsI;extern	Boolean	respondcfm;typedef struct _wloc {	Point	topleft;	short	bottom;	} wloc;#if defined(powerc) || defined(__powerc)	extern	UniversalProcPtr	uupMyAlertProc;#else	pascal Boolean myAlertProc ( DialogPtr theDialog, EventRecord *theEvent, short *itemHit );#endifstatic	Rect	originalView = {0,0,0,0};//static	char	*toolargemsg = "This message too large to display.\rThough, you can export it.";static	char	*greate_1 = "Message from you has been read by SysOp\xD";//static	char	*greate_2 = "\xD--- " QUILLNAME " " RAVELVERS " " RAVELISA " " RAVELBUILD " for Macintosh\xD";#ifndef LITEstatic	char	*greate_2 = "\xD--- " QUILLNAME " " RAVELVERS " " RAVELISA " for Macintosh\xD";#elsestatic	char	*greate_2 = "\xD--- " QUILLNAME " " RAVELVERS " for Macintosh\xD";#endif		Handle	selection_to_reply = NULL;static ControlHandle InsertOneButton (DialogPtr dialog, short ID, short pos, short vpos){	Rect			cRect;	SetRect (&cRect, pos, vpos, 0, 0);		return NewControl (						dialog,						&cRect,						"\p",						true,						ID,						0,						1000,						(128 << 4),						0					);}static void InsertButtons (commonDataPtr common){	ControlHandle	cHandle;	short			r = (common->cMsgView.dialog)->portRect.right - 5;	short			iType;	Handle			iHandle;	Rect			iRect, rView;	GetDialogItem ( common->cMsgView.dialog, miBar, &iType, &iHandle, &rView );		rView.top += 3;		cHandle = InsertOneButton (common->cMsgView.dialog, btIDSend, r - btWidth * 1, rView.top);	common->cMsgView.controlsArray[btSend] = cHandle;	r -= 5;	cHandle = InsertOneButton (common->cMsgView.dialog, btIDRRead, r - btWidth * 2, rView.top);	common->cMsgView.controlsArray[btRRead] = cHandle;	cHandle = InsertOneButton (common->cMsgView.dialog, btIDLRead, r - btWidth * 3, rView.top);	common->cMsgView.controlsArray[btLRead] = cHandle;	cHandle = InsertOneButton (common->cMsgView.dialog, btIDHRead, r - btWidth * 4, rView.top);	common->cMsgView.controlsArray[btHRead] = cHandle;	r -= 5;	cHandle = InsertOneButton (common->cMsgView.dialog, btIDTRight, r - btWidth * 5, rView.top);	common->cMsgView.controlsArray[btTRight] = cHandle;	cHandle = InsertOneButton (common->cMsgView.dialog, btIDTLeft, r - btWidth * 6, rView.top);	common->cMsgView.controlsArray[btTLeft] = cHandle;	cHandle = InsertOneButton (common->cMsgView.dialog, btIDTHome, r - btWidth * 7, rView.top);	common->cMsgView.controlsArray[btTHome] = cHandle;	r -= 5;	cHandle = InsertOneButton (common->cMsgView.dialog, btIDRight, r - btWidth * 8, rView.top);	common->cMsgView.controlsArray[btRight] = cHandle;	cHandle = InsertOneButton (common->cMsgView.dialog, btIDLeft, r - btWidth * 9, rView.top);	common->cMsgView.controlsArray[btLeft] = cHandle;	cHandle = InsertOneButton (common->cMsgView.dialog, btIDNew, 4 + btWidth * 0, rView.top);	common->cMsgView.controlsArray[btNew] = cHandle;	cHandle = InsertOneButton (common->cMsgView.dialog, btIDReplyQ, 4 + btWidth * 1, rView.top);	common->cMsgView.controlsArray[btReplyQ] = cHandle;	cHandle = InsertOneButton (common->cMsgView.dialog, btIDReply, 4 + btWidth * 2, rView.top);	common->cMsgView.controlsArray[btReply] = cHandle;	cHandle = InsertOneButton (common->cMsgView.dialog, btIDEdit, 4 + btWidth * 3, rView.top);	common->cMsgView.controlsArray[btEdit] = cHandle;	cHandle = InsertOneButton (common->cMsgView.dialog, btIDKill, 4 + btWidth * 4, rView.top);	common->cMsgView.controlsArray[btKill] = cHandle;		r = (common->cMsgView.dialog)->portRect.right - 5;	GetDialogItem ( common->cMsgView.dialog, miStatus, &iType, &iHandle, &rView );	rView.top += 2;		cHandle = InsertOneButton (common->cMsgView.dialog, btIDUMarked, r - btWidthS * 1, rView.top);	common->cMsgView.controlsArray[btMarked] = cHandle;	cHandle = InsertOneButton (common->cMsgView.dialog, btIDULocked, r - btWidthS * 2, rView.top);	common->cMsgView.controlsArray[btLocked] = cHandle;	cHandle = InsertOneButton (common->cMsgView.dialog, btIDUKludge, r - btWidthS * 3, rView.top);	common->cMsgView.controlsArray[btKludge] = cHandle;	cHandle = InsertOneButton (common->cMsgView.dialog, btIDUPgf, r - btWidthS * 4, rView.top);	common->cMsgView.controlsArray[btPgf] = cHandle;}static void DisposeButtons (commonDataPtr common){	short	i;			for (i = 0; i < 20; i++)		if (common->cMsgView.controlsArray[i])		{			DisposeControl (common->cMsgView.controlsArray[i]);			common->cMsgView.controlsArray[i] = NULL;		}}static void HiliteButton (commonDataPtr common, long mask){	short	i;			for (i = 0; i < 20; i++)		if (common->cMsgView.controlsArray[i])			HiliteControl (common->cMsgView.controlsArray[i], (mask & (1L << i)) ? 0 : 255);}static short LocateButton (commonDataPtr common, ControlHandle whichControl){	short	i;			for (i = 0; i < 20; i++)		if (common->cMsgView.controlsArray[i] == whichControl)			return i;	return -1;}static void DrawContents (commonDataPtr common){	short		iType;	Handle		iHandle;	Rect		iRect, rView;	LongRect	rlView;	Str63		stemp, temp;	char		ttt[128];	SetPort (common->cMsgView.dialog);	GetDialogItem ( common->cMsgView.dialog, miBody, &iType, &iHandle, &rView );	MoveTo (0, rView.top - 1);	LineTo ((common->cMsgView.dialog)->portRect.right, rView.top - 1);	//	GetDialogItem ( common->cMsgView.dialog, miFlags, &iType, &iHandle, &rView );//	MoveTo (0, rView.top - 1);//	LineTo ((common->cMsgView.dialog)->portRect.right, rView.top - 1);		GetDialogItem ( common->cMsgView.dialog, miBar, &iType, &iHandle, &rView );	MoveTo (0, rView.top - 1);	LineTo ((common->cMsgView.dialog)->portRect.right, rView.top - 1);	MoveTo (0, rView.bottom);	LineTo ((common->cMsgView.dialog)->portRect.right, rView.bottom);		if (common->cMsgView.MessageBody)	{		TextFace (condense);		flags_to_string ( (common->cMsgView.MessageBody)->flags, ttt );		GetDialogItem ( common->cMsgView.dialog, miFlags, &iType, &iHandle, &rView );		TETextBox ( ttt, strlen (ttt), &rView, teForceLeft );		TextFace (0);	}}static void InitContents (windowsQElPtr dialogInfo, long base, long message, Boolean needlook){	short			iType;	Handle			iHandle;	Rect			iRect, rView;	char			ttt[128];	RGBColor		color, color1;	Str255			stemp, temp;	long			nm, mask;	msgbase_atom	Atom;		LongRect		tlRect;	Rect			tRect;		Boolean			cfm_needed, pured;	GetBackColor (&color1);	cfm_needed = false;	pured = false;	GetDialogItem ( (dialogInfo->common)->cMsgView.dialog, 12, &iType, &iHandle, &rView );	SetDialogItemText (iHandle, "\pSubj:");//	if (base == AreasNumber+1)//		OpenBase ( BADAREA, true );//	else//		OpenBase (base, true);	msgbase_open_idx (base, true);	(dialogInfo->common)->cMsgView.message_total = msgbase_getnummsg ();	mask = (base != AreasNumber+1) ? (1L << btNew) : 0;		(dialogInfo->common)->cMsgView.currentTE = 0;		if ((dialogInfo->common)->cMsgView.MessageBody)	{		FreePktMsg ( (dialogInfo->common)->cMsgView.MessageBody );		(dialogInfo->common)->cMsgView.MessageBody = NULL;	}	pStrCopy ((base == 0L) ? "\pNETMAIL" :				(base == AreasNumber+1) ? "\pBADMAIL" :					(*areasHndls[base-1])->areaName, stemp);		if (msgbase_getnummsg ())		NumToString (message+1, temp);	else		pStrCopy ("\pEmpty", temp);		pStrConc (stemp, "\p: ", stemp);	pStrConc (stemp, temp, stemp);	SetWTitle (dialogInfo->dialog, stemp);	if (nm = (dialogInfo->common)->cMsgView.message_total)	{		mask |= ((message != 0) ? (1L << btLeft) : 0) |				((message != nm - 1) ? (1L << btRight) : 0) |				((base != AreasNumber+1) ? (1L << btReplyQ) : 0) |				((base != AreasNumber+1) ? (1L << btReply) : 0) |				(1L << btKill) |				(1L << btRRead) |				(1L << btLRead) |				(1L << btHRead) |				(1L << btLocked) |				(1L << btKludge) |				(1L << btPgf) |				(1L << btMarked);//		if (message == GetLastRead ())//			pStrCopy ("\p\xA5", stemp);//		else//			pStrCopy ("\p ", stemp);//		//		NumToString (message + 1, temp);//		pStrConc ( stemp, temp, stemp );		if ( msgbase_read_atom ( message, &Atom ) )		{			if (Atom.base_flags & ATOM_WASREAD)				pStrCopy ("\p ", stemp);			else			{				pured = true;				pStrCopy ("\p\xA5", stemp);			}						if (needlook && (Atom.base_flags & ATOM_WASREAD) == 0)			{				Atom.base_flags |= ATOM_WASREAD;				msgbase_write_atom ( message, &Atom );				if ((Atom.flags & MSGCFM) != 0 && (Atom.flags & MSGLOCAL) == 0 && !base && respondcfm)					cfm_needed = true;			}			else				needlook = false;						NumToString (message + 1, temp);			pStrConc ( stemp, temp, stemp );			SetControlValue ( (dialogInfo->common)->cMsgView.controlsArray[btLocked],					(Atom.base_flags & ATOM_LOCKED) ? btIDLocked : btIDULocked);						SetControlValue ( (dialogInfo->common)->cMsgView.controlsArray[btMarked],					((*markArray[(dialogInfo->common)->cMsgView.area_number])						[(dialogInfo->common)->cMsgView.message_number]) ?							btIDMarked : btIDUMarked);						SetControlValue ( (dialogInfo->common)->cMsgView.controlsArray[btKludge],					(!needfilter) ? btIDKludge : btIDUKludge);			SetControlValue ( (dialogInfo->common)->cMsgView.controlsArray[btPgf],					(!needpgf) ? btIDPgf : btIDUPgf);			mask |= (Atom.flags & MSGLOCAL) ? (1L << btEdit) : 0;						if (Atom.msg_reply_prev != -1 )			{				pStrConc ( stemp, "\p-", stemp );				NumToString (Atom.msg_reply_prev + 1, temp );				pStrConc ( stemp, temp, stemp );								mask |= (1L << btTLeft) |						(1L << btTHome);			}			if (Atom.msg_reply_next != -1 )			{				pStrConc ( stemp, "\p+", stemp );				NumToString (Atom.msg_reply_next + 1, temp );				pStrConc ( stemp, temp, stemp );				mask |= (1L << btTRight);			}			pStrConc ( stemp, "\p of ", stemp );			NumToString (nm + ((cfm_needed) ? 1 : 0), temp);			pStrConc ( stemp, temp, stemp );			GetDialogItem ( (dialogInfo->common)->cMsgView.dialog, miMsgNum, &iType, &iHandle, &rView );			SetDialogItemText (iHandle, stemp);		}//	CFM responder		if (msgbase_read_message ( message, &(dialogInfo->common)->cMsgView.MessageBody, READMODE_TEXT | READMODE_REPLY ))		{//е			if (cfm_needed)			{				pktmsg		*m;										m = (pktmsg *) NewPtrClear (sizeof (pktmsg));								m->from = ((dialogInfo->common)->cMsgView.MessageBody)->to;				m->to = ((dialogInfo->common)->cMsgView.MessageBody)->from;				m->base_flags = 0;								m->storedtime = 0;				m->msgid_num = 0;				msgbase_prep_msgid (m);				msgbase_prep_reply (m, (dialogInfo->common)->cMsgView.MessageBody);				m->area[0] = 0;				m->flags = MSGPRIVATE | MSGLOCAL;								strcpy (m->fromname, ((dialogInfo->common)->cMsgView.MessageBody)->toname);				strcpy (m->toname, ((dialogInfo->common)->cMsgView.MessageBody)->fromname);				strcpy (m->subj, "Confirm receipt.");								msgbase_ftn_date (m->date, NULL);								m->seenby.nets = NULL;				m->seenby.nodes = NULL;				m->seenby.items = 0;				m->path.nets = NULL;				m->path.nodes = NULL;				m->path.items = 0;				m->msg_reply_prev = message;				m->msg_reply_next = -1;								m->text = NewHandle (0);				if (!receiptText)				{					PtrAndHand ( greate_1, m->text, strlen (greate_1)+1 );				}				else				{					PtrAndHand ( receiptText, m->text, strlen (receiptText) );				}				PtrAndHand ( greate_2, m->text, strlen (greate_2)+1 );								msgbase_append_message (m, true);				FreePktMsg (m);				(dialogInfo->common)->cMsgView.message_total = msgbase_getnummsg ();			}			color.red = color.green = color.blue = 0xFFFF;			RGBBackColor(&color);			LongRectToRect (&(*((*((dialogInfo->common)->cMsgView.bodytext))->bodytext))->viewRect, &tRect);			EraseRect (&tRect);			if (needfilter && ((dialogInfo->common)->cMsgView.MessageBody->flags & MSGLOCAL) != 0)			{				iHandle = NewHandle (0);								if ((dialogInfo->common)->cMsgView.MessageBody->msgid_str)				{					sprintf (ttt, "\1MSGID: %s\r", (dialogInfo->common)->cMsgView.MessageBody->msgid_str);					PtrAndHand (ttt, iHandle, strlen (ttt));				}				if ((dialogInfo->common)->cMsgView.MessageBody->reply_str)				{					sprintf (ttt, "\1REPLY: %s\r", (dialogInfo->common)->cMsgView.MessageBody->reply_str);					PtrAndHand (ttt, iHandle, strlen (ttt));				}								HandAndHand (((dialogInfo->common)->cMsgView.MessageBody)->text, iHandle);				HLock (iHandle);								TE32KSetText (*iHandle, strlen (*iHandle), (*((dialogInfo->common)->cMsgView.bodytext))->bodytext);				DisposeHandle (iHandle);			}			else			{				callFilter (((dialogInfo->common)->cMsgView.MessageBody)->text);				HLock (((dialogInfo->common)->cMsgView.MessageBody)->text);					//			if (strlen (*((dialogInfo->common)->cMsgView.MessageBody)->text) <= 0x7F00)	//			{					TE32KSetText (*((dialogInfo->common)->cMsgView.MessageBody)->text,								strlen (*((dialogInfo->common)->cMsgView.MessageBody)->text),									(*((dialogInfo->common)->cMsgView.bodytext))->bodytext);	//			}	//			else	//			{	//				TE32KSetText (toolargemsg, strlen (toolargemsg),	//								(*((dialogInfo->common)->cMsgView.bodytext))->bodytext);	//			}				HUnlock (((dialogInfo->common)->cMsgView.MessageBody)->text);			}			SetControlMaximum ((*((dialogInfo->common)->cMsgView.bodytext))->scroll, 0);			SetControlValue ((*((dialogInfo->common)->cMsgView.bodytext))->scroll, 0);						(*((*((dialogInfo->common)->cMsgView.bodytext))->bodytext))->destRect =				(*((*((dialogInfo->common)->cMsgView.bodytext))->bodytext))->viewRect;						myTEScrollRedraw ((dialogInfo->common)->cMsgView.bodytext);			TE32KSetText (((dialogInfo->common)->cMsgView.MessageBody)->fromname,						strlen (((dialogInfo->common)->cMsgView.MessageBody)->fromname),							(dialogInfo->common)->cMsgView.te.named.from);			TE32KSetText (((dialogInfo->common)->cMsgView.MessageBody)->toname,						strlen (((dialogInfo->common)->cMsgView.MessageBody)->toname),							(dialogInfo->common)->cMsgView.te.named.to);						if (pured)			{				strcpy ( &ttt[1], (dialogInfo->common)->cMsgView.MessageBody->toname );				ttt[0] = strlen ( &ttt[1] );				if (myname ((StringPtr) ttt))					CallASndPlay (128);			}						(*(dialogInfo->common)->cMsgView.te.named.subj)->txFont =				(((dialogInfo->common)->cMsgView.MessageBody)->flags & MSGFILE) ? 4 : viewFont;			TE32KSetText (((dialogInfo->common)->cMsgView.MessageBody)->subj,						strlen (((dialogInfo->common)->cMsgView.MessageBody)->subj),							(dialogInfo->common)->cMsgView.te.named.subj);						if ((((dialogInfo->common)->cMsgView.MessageBody)->flags & (MSGFILE | MSGFREQ)) != 0)			{				GetDialogItem ( (dialogInfo->common)->cMsgView.dialog, 12, &iType, &iHandle, &rView );				SetDialogItemText (iHandle, "\pFile:");			}						TE32KSetText (((dialogInfo->common)->cMsgView.MessageBody)->date,						strlen (((dialogInfo->common)->cMsgView.MessageBody)->date),							(dialogInfo->common)->cMsgView.te.named.date);			printaddr (&((dialogInfo->common)->cMsgView.MessageBody)->from, ttt);			TE32KSetText (ttt, strlen (ttt), (dialogInfo->common)->cMsgView.te.named.fromaddr);			if (!base)			{				printaddr (&((dialogInfo->common)->cMsgView.MessageBody)->to, ttt);				TE32KSetText (ttt, strlen (ttt), (dialogInfo->common)->cMsgView.te.named.toaddr);			}			//			color.red = color.green = color.blue = 50000;			RGBBackColor(&color1);		}	}	else	{		GetDialogItem ( (dialogInfo->common)->cMsgView.dialog, miMsgNum, &iType, &iHandle, &rView );		SetDialogItemText (iHandle, "\p");/*		GetDialogItem ( (dialogInfo->common)->cMsgView.dialog, miOfNum, &iType, &iHandle, &rView );		SetDialogItemText (iHandle, "\p");		GetDialogItem ( (dialogInfo->common)->cMsgView.dialog, miOf, &iType, &iHandle, &rView );		SetDialogItemText (iHandle, "\p");*/		TE32KSetText ("", 0, (dialogInfo->common)->cMsgView.te.named.from);		TE32KSetText ("", 0, (dialogInfo->common)->cMsgView.te.named.to);		TE32KSetText ("", 0, (dialogInfo->common)->cMsgView.te.named.subj);		TE32KSetText ("", 0, (dialogInfo->common)->cMsgView.te.named.date);		TE32KSetText ("", 0, (dialogInfo->common)->cMsgView.te.named.fromaddr);		if (!base)			TE32KSetText ("", 0, (dialogInfo->common)->cMsgView.te.named.toaddr);		TE32KSetText ("", 0, (*((dialogInfo->common)->cMsgView.bodytext))->bodytext);	}	HiliteButton (dialogInfo->common, mask);	InvalRect (&(dialogInfo->dialog)->portRect);	msgbase_close ((needlook) ? CLOSE_UPDATE : CLOSE_ONLY);		if (needlook)	{		if (!cfm_needed)			Broadcast (wtSubjects, broadRedrawCell, base, message);		else			Broadcast (wtSubjects, broadAppendCell, base, 0);		Broadcast (wtAreasList, broadRedrawCell, base, 0);	}	TE32KDeactivate ((dialogInfo->common)->cMsgView.te.named.to);	TE32KDeactivate ((dialogInfo->common)->cMsgView.te.named.from);				if (!(dialogInfo->common)->cMsgView.area_number)		TE32KDeactivate ((dialogInfo->common)->cMsgView.te.named.toaddr);				TE32KDeactivate ((dialogInfo->common)->cMsgView.te.named.fromaddr);	TE32KDeactivate ((dialogInfo->common)->cMsgView.te.named.subj);	TE32KDeactivate ((dialogInfo->common)->cMsgView.te.named.date);}#define	MDate			20#define	MName			36#define	MSubject		72static void AdjustFields (DialogPtr dialog, myTE32KHandle bodytext){	FontInfo	fInfo;	short		iType, wSpace;	Handle		iHandle;	Rect		rView;		short		hStep, nextHPos, nextVPos;	TextFont (viewFont);	TextSize (viewSize);	GetFontInfo (&fInfo);	wSpace = CharWidth (' ');	hStep = fInfo.ascent + fInfo.descent + 5;	GetDialogItem ( dialog, miFrom, &iType, &iHandle, &rView );	nextVPos = rView.top;	nextHPos = rView.left;	SetRect (&rView, nextHPos, nextVPos, nextHPos + /*fInfo.widMax*/ wSpace * MName, nextVPos + hStep - 5);	SetDialogItem ( dialog, miFrom, iType, iHandle, &rView );	nextHPos = rView.right + 5;	GetDialogItem ( dialog, 10, &iType, &iHandle, &rView );	SetRect (&rView, rView.left, nextVPos+fInfo.descent, rView.right, nextVPos+fInfo.descent+(rView.bottom-rView.top));	SetDialogItem ( dialog, 10, iType, iHandle, &rView );	GetDialogItem ( dialog, miAka, &iType, &iHandle, &rView );	SetRect (&rView, nextHPos, nextVPos, nextHPos + /*fInfo.widMax*/ wSpace * MAddr, nextVPos + hStep - 5);	SetDialogItem ( dialog, miAka, iType, iHandle, &rView );	nextHPos = rView.right + 5;	GetDialogItem ( dialog, miDate, &iType, &iHandle, &rView );	SetRect (&rView, nextHPos, nextVPos, nextHPos + /*fInfo.widMax*/ wSpace * MDate, nextVPos + hStep - 5);	SetDialogItem ( dialog, miDate, iType, iHandle, &rView );	nextVPos += hStep;		GetDialogItem ( dialog, miTo, &iType, &iHandle, &rView );	nextHPos = rView.left;	SetRect (&rView, nextHPos, nextVPos, nextHPos + /*fInfo.widMax*/ wSpace * MName, nextVPos + hStep - 5);	SetDialogItem ( dialog, miTo, iType, iHandle, &rView );	nextHPos = rView.right + 5;		GetDialogItem ( dialog, 11, &iType, &iHandle, &rView );	SetRect (&rView, rView.left, nextVPos+fInfo.descent, rView.right, nextVPos+fInfo.descent+(rView.bottom-rView.top));	SetDialogItem ( dialog, 11, iType, iHandle, &rView );	GetDialogItem ( dialog, miToAd, &iType, &iHandle, &rView );	SetRect (&rView, nextHPos, nextVPos, nextHPos + /*fInfo.widMax*/ wSpace * MAddr, nextVPos + hStep - 5);	SetDialogItem ( dialog, miToAd, iType, iHandle, &rView );	nextHPos = rView.right + 5;	GetDialogItem ( dialog, miFlags, &iType, &iHandle, &rView );	SetRect (&rView, nextHPos, nextVPos, nextHPos + /*fInfo.widMax*/ wSpace * MDate, nextVPos + hStep - 5);	SetDialogItem ( dialog, miFlags, iType, iHandle, &rView );	nextVPos += hStep;	GetDialogItem ( dialog, miSubj, &iType, &iHandle, &rView );	SetRect (&rView, rView.left, nextVPos, rView.left + /*fInfo.widMax*/ wSpace * MSubject, nextVPos + hStep - 5);	SetDialogItem ( dialog, miSubj, iType, iHandle, &rView );	GetDialogItem ( dialog, 12, &iType, &iHandle, &rView );	SetRect (&rView, rView.left, nextVPos+fInfo.descent, rView.right, nextVPos+fInfo.descent+(rView.bottom-rView.top));	SetDialogItem ( dialog, 12, iType, iHandle, &rView );	nextVPos += hStep;	GetDialogItem ( dialog, miBody, &iType, &iHandle, &rView );	SetRect (&rView, rView.left, nextVPos, rView.right, rView.bottom);	SetDialogItem ( dialog, miBody, iType, iHandle, &rView );	(*((*bodytext)->bodytext))->destRect.top = nextVPos+2;	(*((*bodytext)->bodytext))->viewRect.top = nextVPos+2;}static void AdjustWinSize (myTE32KHandle bodytext, short max){	short		iType, ii, dummy, neww, newh, newc;	Handle		iHandle;	Rect		iRect, rView, rDataBnds;//	FontInfo	fInfo;		GetDialogItem ( (*bodytext)->dialog, miBody, &iType, &iHandle, &rView );	newc = (*((*bodytext)->bodytext))->lineHeight;	TextFont (viewFont);	TextSize (viewSize);//	GetFontInfo (&fInfo);	//	neww = 2 + 81 * fInfo.widMax + 2 + 15;	neww = 2 + 81 * CharWidth (' ') + 2 + 15;	newh = 4 + rView.top + (((max - rView.top - 4) / newc) * newc);		SizeWindow ( (*bodytext)->dialog, neww, newh, true);	myTESize (bodytext);	originalView.bottom = newh;}void WViewEventProcessor (EventRecord *event, windowsQElPtr dialogInfo, long info){	DialogPtr	dialog;	myTE32KHandle	bodytext;	RGBColor	color, color1;	short		iType, ii, dummy, neww, newh, newc, menuItem;	Handle		iHandle, htmp;	Rect		iRect, rView, rDataBnds;	Point		cellSize, theCell;	Point		where;			long		lSizeVH, mn, ctemp, ltemp, iii;		Str255		stemp;	Str63		stmp;		char		key, tmp[64];		short		iPartCode, iCtlPart;		WStateData	*WStDat;	MenuHandle	hMenu;		windowsQElPtr	dInfo;	WindowPtr		window;		commonDataPtr	pcommon;	ControlHandle	whichCtl;//	PopUpMenuHandle	popup, popupa;	msgbase_atom	Atom, Atom1;	GrafPtr			oldPort;	LongRect		tlRect;	Rect			tRect;	addr			tempaddr;	switch (info & 0xFFFF)	{	case actionSetSize:				originalView.left = ((wloc *) event)->topleft.h;		originalView.top = ((wloc *) event)->topleft.v;		originalView.bottom = ((wloc *) event)->bottom;				break;		case actionGetSize:				((wloc *) event)->topleft.h = originalView.left;		((wloc *) event)->topleft.v = originalView.top;		((wloc *) event)->bottom = originalView.bottom;				break;		case actionCreate://		if ((short) event == AreasNumber+1)//			OpenBase ( BADAREA, true );//		else//			OpenBase ((short) event, true);		msgbase_open_idx ((short) event, true);		if (((long) dialogInfo) < 0)			*((long *) &dialogInfo) = msgbase_getlastread ();		if (dInfo = windowsOpened (wtMsgView, (long) event, (long) dialogInfo))		{			msgbase_close (CLOSE_ONLY);			SelectWindow (dInfo->dialog);			break;		}				dialog = GetNewDialog (128 + wtMsgView, NULL, (WindowPtr) -1);		((WindowPeek)dialog)->windowKind = myKind;		SetPort ( dialog );		if (originalView.bottom)		{			if (!SuchWindow (wtMsgView) || qd.screenBits.bounds.bottom - originalView.top - 20 < originalView.bottom)			{				if (!originalView.top)				{					originalView.top = (*(((WindowPeek)dialog)->contRgn))->rgnBBox.top;					originalView.left = (*(((WindowPeek)dialog)->contRgn))->rgnBBox.left;	//				originalView.bottom = dialog->portRect.bottom;					originalView.top = LMGetMBarHeight () * 2;				}			}			else			{				originalView.left += 20;				originalView.top += 20;			}		}		else		{			originalView = (*(((WindowPeek)dialog)->contRgn))->rgnBBox;			originalView.bottom = dialog->portRect.bottom;			originalView.top = LMGetMBarHeight () * 2;		}				MoveWindow (dialog, originalView.left, originalView.top, false);		SizeWindow (dialog, dialog->portRect.right, originalView.bottom, false);		TextFont (viewFont);		TextSize (viewSize);				GetDialogItem ( dialog, miBody, &iType, &iHandle, &rView );		bodytext = myTENew (dialog, &rView, true, true, true);		AdjustFields (dialog, bodytext);		AdjustWinSize (bodytext, dialog->portRect.bottom);		//		popup = InitPopUp (dialog, 500, miFlagPopUp, 1, "\pFlags", 0, NULL);//		DrawPopUp (popup);//		HilitePopUp (popup, false);		//		popupa = InitPopUp (dialog, 501, miAka, 1, "\p", 2, NULL);//		DrawPopUp (popupa);//		HilitePopUp (popupa, false);				WStDat = (WStateData *) *((WindowPeek) dialog)->dataHandle;				SetRect (&(WStDat->stdState),			WStDat->stdState.left + dialog->portRect.left,			WStDat->stdState.top + dialog->portRect.top,			WStDat->stdState.left + dialog->portRect.right,			qd.screenBits.bounds.bottom);		pcommon = (commonDataPtr) NewPtrClear (sizeof (commonMsgView));				pcommon->cMsgView.dialog = dialog;		pcommon->cMsgView.bodytext = bodytext;//		pcommon->cMsgView.flagsPopUp = popup;//		pcommon->cMsgView.AkaPopUp = popupa;		pcommon->cMsgView.area_number = (long) event;		pcommon->cMsgView.message_number = (long) dialogInfo;		pcommon->cMsgView.message_total = msgbase_getnummsg ();		pcommon->cMsgView.MessageBody = NULL;				pcommon->cMsgView.te.named.from = littleTENew (dialog, miFrom, true, true);		pcommon->cMsgView.te.named.fromaddr = littleTENew (dialog, miAka, true, true);		pcommon->cMsgView.te.named.to = littleTENew (dialog, miTo, true, true);				if (!event)			pcommon->cMsgView.te.named.toaddr = littleTENew (dialog, miToAd, true, true);				pcommon->cMsgView.te.named.subj = littleTENew (dialog, miSubj, true, true);		pcommon->cMsgView.te.named.date = littleTENew (dialog, miDate, true, true);				InsertButtons (pcommon);				windowsAdd (dialog, wtMsgView, pcommon, WViewEventProcessor, WViewDialogProcessor);		dInfo = windowsLookUp (dialog);				SetWRefCon (dialog, (long) dInfo);		dInfo->inFront = true;		ShowWindow ( dialog );//		DrawDialog ( dialog );				msgbase_close (CLOSE_ONLY);				InitContents (dInfo, (long) event, (long) dialogInfo, true);				WViewEventProcessor (NULL, dInfo, ((long) inMenuBar << 16) | mouseDown);		break;	case actionClose:		originalView = (*(((WindowPeek)(dialogInfo->dialog))->contRgn))->rgnBBox;		originalView.bottom = (dialogInfo->dialog)->portRect.bottom;		DisposeButtons (dialogInfo->common);				myTEDispose ((dialogInfo->common)->cMsgView.bodytext);		TE32KDispose ((dialogInfo->common)->cMsgView.te.named.from);		TE32KDispose ((dialogInfo->common)->cMsgView.te.named.fromaddr);		TE32KDispose ((dialogInfo->common)->cMsgView.te.named.to);		if (!(dialogInfo->common)->cMsgView.area_number)			TE32KDispose ((dialogInfo->common)->cMsgView.te.named.toaddr);		TE32KDispose ((dialogInfo->common)->cMsgView.te.named.subj);		TE32KDispose ((dialogInfo->common)->cMsgView.te.named.date);		if ((dialogInfo->common)->cMsgView.MessageBody)		{			FreePktMsg ( (dialogInfo->common)->cMsgView.MessageBody );			(dialogInfo->common)->cMsgView.MessageBody = NULL;		}		DisposePtr ((Ptr) dialogInfo->common);		DisposeDialog (dialogInfo->dialog);		windowsKill (dialogInfo->dialog);				break;		case actionActive:			SetPort (dialogInfo->dialog);//		DrawOnlyGrowIcon (dialogInfo->dialog);		//		Debugger ();				GetBackColor (&color1);		color.red = color.green = color.blue = 0xFFFF;		RGBBackColor(&color);		MoveControl ((*((dialogInfo->common)->cMsgView.bodytext))->scroll,			(*(*((dialogInfo->common)->cMsgView.bodytext))->bodytext)->viewRect.right + ((dialogInfo->inFront) ? 2 : 17),			(*(*((dialogInfo->common)->cMsgView.bodytext))->bodytext)->viewRect.top - 3);		if (dialogInfo->inFront)		{//			TE32KActivate ((dialogInfo->common)->cMsgView.te.named.to);//			TE32KActivate ((dialogInfo->common)->cMsgView.te.named.from);			//			if (!(dialogInfo->common)->cMsgView.area_number)//				TE32KActivate ((dialogInfo->common)->cMsgView.te.named.toaddr);			//			TE32KActivate ((dialogInfo->common)->cMsgView.te.named.fromaddr);//			TE32KActivate ((dialogInfo->common)->cMsgView.te.named.subj);//			TE32KActivate ((dialogInfo->common)->cMsgView.te.named.date);			TE32KActivate ((*(dialogInfo->common)->cMsgView.bodytext)->bodytext);		}		else		{//			TE32KDeactivate ((dialogInfo->common)->cMsgView.te.named.to);//			TE32KDeactivate ((dialogInfo->common)->cMsgView.te.named.from);			//			if (!(dialogInfo->common)->cMsgView.area_number)//				TE32KDeactivate ((dialogInfo->common)->cMsgView.te.named.toaddr);			//			TE32KDeactivate ((dialogInfo->common)->cMsgView.te.named.fromaddr);//			TE32KDeactivate ((dialogInfo->common)->cMsgView.te.named.subj);//			TE32KDeactivate ((dialogInfo->common)->cMsgView.te.named.date);			TE32KDeactivate ((*(dialogInfo->common)->cMsgView.bodytext)->bodytext);		}//		color.red = color.green = color.blue = 50000;		RGBBackColor(&color1);		break;	case actionBroadcast:			GetPort (&oldPort);		SetPort (dialogInfo->dialog);				switch (((BroadcastRecPtr) event)->synctype)		{		case msgCmdGetMessage:			{				WinComPtr	wcp = (WinComPtr)((BroadcastRecPtr) event)->param[0];				if ((dialogInfo->common)->cMsgView.message_total > 0)				{					wcp->arg.MSG->msg = (dialogInfo->common)->cMsgView.MessageBody;					wcp->result = 0;				}				else					wcp->result = -1; 			}			break;		case msgCmdGetMessageNum:			{				WinComPtr	wcp = (WinComPtr)((BroadcastRecPtr) event)->param[0];				wcp->result = (dialogInfo->common)->cMsgView.message_number; 			}			break;				case teCmdGetFieldID:			{				WinComPtr	wcp = (WinComPtr)((BroadcastRecPtr) event)->param[0];				wcp->arg.TEC->fieldnumber = (dialogInfo->common)->cMsgView.currentTE;				wcp->result = 0;			}			break;				case teCmdGetText:			{				WinComPtr	wcp = (WinComPtr)((BroadcastRecPtr) event)->param[0];							if ((dialogInfo->common)->cMsgView.currentTE == wcp->arg.TEC->fieldnumber)				{					TECommand	tec = wcp->arg.TEC;					TE32KHandle	te = (tec->fieldnumber) ?									(dialogInfo->common)->cMsgView.te.array[tec->fieldnumber-1] :									(*(dialogInfo->common)->cMsgView.bodytext)->bodytext;					long		frompos, topos, actual;										frompos = __max(0, tec->frompos);					topos = __min((*te)->teLength, tec->topos);					actual = __min(tec->textlen, topos - frompos);					if (actual > 0)					{						HLock((*te)->hText);						memcpy(tec->text, *(*te)->hText, actual);						HUnlock((*te)->hText);						tec->textlen = actual;						wcp->result = 0;					}					else						wcp->result = -1;				}				else					wcp->result = -1;			}			break;		case teCmdGetSelection:			{				WinComPtr	wcp = (WinComPtr)((BroadcastRecPtr) event)->param[0];							if ((dialogInfo->common)->cMsgView.currentTE == wcp->arg.TEC->fieldnumber)				{					TECommand	tec = wcp->arg.TEC;					TE32KHandle	te = (tec->fieldnumber) ?									(dialogInfo->common)->cMsgView.te.array[tec->fieldnumber-1] :									(*(dialogInfo->common)->cMsgView.bodytext)->bodytext;									tec->frompos = (*te)->selStart;					tec->topos = (*te)->selEnd;					wcp->result = 0;				}				else					wcp->result = -1;			}			break;				case teCmdSelectText:			{				WinComPtr	wcp = (WinComPtr)((BroadcastRecPtr) event)->param[0];							if ((dialogInfo->common)->cMsgView.currentTE == wcp->arg.TEC->fieldnumber)				{					TECommand	tec = wcp->arg.TEC;					TE32KHandle	te = (tec->fieldnumber) ?									(dialogInfo->common)->cMsgView.te.array[tec->fieldnumber-1] :									(*(dialogInfo->common)->cMsgView.bodytext)->bodytext;					GetBackColor (&color1);					color.red = color.green = color.blue = 0xFFFF;					RGBBackColor(&color);					TE32KSetSelect (tec->frompos, tec->topos, te);//					color.red = color.green = color.blue = 50000;					RGBBackColor(&color1);					wcp->result = 0;				}				else					wcp->result = -1;			}			break;				case teCmdScrollToVisible:			{				WinComPtr	wcp = (WinComPtr)((BroadcastRecPtr) event)->param[0];							if ((dialogInfo->common)->cMsgView.currentTE == 0 &&					(dialogInfo->common)->cMsgView.currentTE == wcp->arg.TEC->fieldnumber)				{					TECommand	tec = wcp->arg.TEC;					TE32KHandle	te = (*(dialogInfo->common)->cMsgView.bodytext)->bodytext;					GetBackColor (&color1);					color.red = color.green = color.blue = 0xFFFF;					RGBBackColor(&color);					TE32KSelView (te);					if (tec->fieldnumber == 0)						AdjustV ((*(dialogInfo->common)->cMsgView.bodytext)->scroll,									(*(dialogInfo->common)->cMsgView.bodytext)->bodytext, false);//					color.red = color.green = color.blue = 50000;					RGBBackColor(&color1);					wcp->result = 0;				}				else					wcp->result = -1;			}			break;				case broadClose:					WViewEventProcessor (NULL, dialogInfo, actionClose);			break;				case broadRedrawCell:					if (((BroadcastRecPtr) event)->area != (dialogInfo->common)->cMsgView.area_number)				break;			InitContents (dialogInfo,				(dialogInfo->common)->cMsgView.area_number,				(dialogInfo->common)->cMsgView.message_number, true);			break;				case broadSyncCellLR:			if (((BroadcastRecPtr) event)->area != (dialogInfo->common)->cMsgView.area_number)				break;			(dialogInfo->common)->cMsgView.message_number = ((BroadcastRecPtr) event)->message;						InitContents (dialogInfo,				(dialogInfo->common)->cMsgView.area_number,				(dialogInfo->common)->cMsgView.message_number, true);			break;					case broadDeleteCell:					if (((BroadcastRecPtr) event)->area != (dialogInfo->common)->cMsgView.area_number)				break;						(dialogInfo->common)->cMsgView.message_total = ((BroadcastRecPtr) event)->message;						if ((dialogInfo->common)->cMsgView.message_total)			{				if ((dialogInfo->common)->cMsgView.message_number >=					(dialogInfo->common)->cMsgView.message_total)					if ((dialogInfo->common)->cMsgView.message_number)						(dialogInfo->common)->cMsgView.message_number--;			}			else				(dialogInfo->common)->cMsgView.message_number = 0;			InitContents (dialogInfo,				(dialogInfo->common)->cMsgView.area_number,				(dialogInfo->common)->cMsgView.message_number, true);	//	was false			break;					case broadAppendCell:					if (((BroadcastRecPtr) event)->area != (dialogInfo->common)->cMsgView.area_number)				break;			InitContents (dialogInfo,				(dialogInfo->common)->cMsgView.area_number,				(dialogInfo->common)->cMsgView.message_number, true);			break;		}				SetPort (oldPort);				break;		case actionMenu:		SetPort (dialogInfo->dialog);		menuItem = (info >> 16) & 0xFF;				switch ((info >> 24) & 0xFF)		{		case fileM:					switch (menuItem)			{			case fExport:								SaveMessagesToFile ((dialogInfo->common)->cMsgView.area_number,									(dialogInfo->common)->cMsgView.message_number, 0);				break;						case fPost:				if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);					Broadcast (wtMsgEdit, editPost,							(dialogInfo->common)->cMsgView.area_number, 0);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);				}								break;							case fPrint:			#ifndef LITE				DoPrintOneMessage ((dialogInfo->common)->cMsgView.MessageBody);#endif				break;			}						break;				case editM:					switch (menuItem)			{			case iFind:							HiliteMenu (0);				FindInit (dialogInfo, (dialogInfo->common)->cMsgView.area_number,							(dialogInfo->common)->cMsgView.message_number);				break;							case iFindNext:							HiliteMenu (0);				FindNextNext (dialogInfo, (dialogInfo->common)->cMsgView.area_number,							(dialogInfo->common)->cMsgView.message_number);				break;							case iCopy:								if ((dialogInfo->common)->cMsgView.currentTE)					TE32KCopyToScrap ((dialogInfo->common)->cMsgView.te.array[(dialogInfo->common)->cMsgView.currentTE-1]);				else					if ((*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart !=						(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selEnd)					TE32KCopyToScrap ((*(dialogInfo->common)->cMsgView.bodytext)->bodytext);							break;			}			break;		case msgM:					switch (menuItem)			{			case mEdit:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);					Broadcast (wtMsgEdit, editEdit,							(dialogInfo->common)->cMsgView.area_number,							(dialogInfo->common)->cMsgView.message_number);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);				}								break;							case mDelete:							if (windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))				{					CallASndPlay (129);					break;				}				#if defined(powerc) || defined(__powerc)				ii = Alert (501, uupMyAlertProc);#else				ii = Alert (501, myAlertProc);#endif							if (ii == 2)					break;//				if ((dialogInfo->common)->cMsgView.area_number == AreasNumber+1)//					OpenBase ( BADAREA, true );//				else//					OpenBase ((dialogInfo->common)->cMsgView.area_number, true);				msgbase_open_idx ((dialogInfo->common)->cMsgView.area_number, true);				DeleteMark ((dialogInfo->common)->cMsgView.area_number,							(dialogInfo->common)->cMsgView.message_number);				msgbase_delete_message ((dialogInfo->common)->cMsgView.message_number, ATOM_DELETED);				if ((dialogInfo->common)->cMsgView.message_number >=					(dialogInfo->common)->cMsgView.message_total-1)					(dialogInfo->common)->cMsgView.message_number--;								(dialogInfo->common)->cMsgView.message_total = msgbase_getnummsg ();				msgbase_close (CLOSE_UPDATE);				Broadcast (wtMsgView, broadDeleteCell,						(dialogInfo->common)->cMsgView.area_number,						(dialogInfo->common)->cMsgView.message_total);				Broadcast (wtSubjects, broadDeleteCell,						(dialogInfo->common)->cMsgView.area_number,						(dialogInfo->common)->cMsgView.message_number);				Broadcast (wtAreasList, broadRedrawCell,					(dialogInfo->common)->cMsgView.area_number, 0);/*								if (msgbase_read_atom ((dialogInfo->common)->cMsgView.message_number, &Atom))				{					Atom.base_flags = ATOM_DELETED;					msgbase_write_atom ((dialogInfo->common)->cMsgView.message_number, &Atom);									DeleteMark ((dialogInfo->common)->cMsgView.area_number,								(dialogInfo->common)->cMsgView.message_number);					msgbase_setnummsg (msgbase_getnummsg () - 1);										if ((dialogInfo->common)->cMsgView.message_number >=						(dialogInfo->common)->cMsgView.message_total-1)						(dialogInfo->common)->cMsgView.message_number--;										(dialogInfo->common)->cMsgView.message_total = msgbase_getnummsg ();					msgbase_close (CLOSE_UPDATE);					Broadcast (wtMsgView, broadDeleteCell,							(dialogInfo->common)->cMsgView.area_number,							(dialogInfo->common)->cMsgView.message_total);//							(dialogInfo->common)->cMsgView.message_number);					Broadcast (wtSubjects, broadDeleteCell,							(dialogInfo->common)->cMsgView.area_number,							(dialogInfo->common)->cMsgView.message_number);					Broadcast (wtAreasList, broadRedrawCell,						(dialogInfo->common)->cMsgView.area_number, 0);				}				else					msgbase_close (CLOSE_ONLY);*/								break;			case mNew:				if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);					Broadcast (wtMsgEdit, editNew,							(dialogInfo->common)->cMsgView.area_number, 0);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);				}								break;			case mReplyQ:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))				{					if ((*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart <								(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selEnd)					{						selection_to_reply = NewHandleClear ((*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selEnd -											(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart + 2);						MoveHHi (selection_to_reply);						HLock (selection_to_reply);						HLock ((*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->hText);						BlockMove (*(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->hText +										(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart,										*selection_to_reply, (*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selEnd -											(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart);					}									WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);					Broadcast (wtMsgEdit, editReplyQ,							(dialogInfo->common)->cMsgView.area_number,							(dialogInfo->common)->cMsgView.message_number);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);				}								break;			case mReply:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);					Broadcast (wtMsgEdit, editReply,							(dialogInfo->common)->cMsgView.area_number,							(dialogInfo->common)->cMsgView.message_number);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);				}								break;			case mCommentQ:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))				{					if ((*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart <								(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selEnd)					{						selection_to_reply = NewHandleClear ((*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selEnd -											(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart + 2);						MoveHHi (selection_to_reply);						HLock (selection_to_reply);						HLock ((*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->hText);						BlockMove (*(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->hText +										(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart,										*selection_to_reply, (*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selEnd -											(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart);					}									WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);					Broadcast (wtMsgEdit, editCommentQ,							(dialogInfo->common)->cMsgView.area_number,							(dialogInfo->common)->cMsgView.message_number);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);				}								break;			case mComment:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);					Broadcast (wtMsgEdit, editComment,							(dialogInfo->common)->cMsgView.area_number,							(dialogInfo->common)->cMsgView.message_number);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);				}								break;			case mForward:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number,											(windowsQElPtr) (dialogInfo->common)->cMsgView.message_number, actionCreate);					WASelectEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, (windowsQElPtr) mForward, actionCreate);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);				}								break;			case mReplyQto:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))				{					if ((*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart <								(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selEnd)					{						selection_to_reply = NewHandleClear ((*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selEnd -											(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart + 2);						MoveHHi (selection_to_reply);						HLock (selection_to_reply);						HLock ((*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->hText);						BlockMove (*(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->hText +										(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart,										*selection_to_reply, (*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selEnd -											(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart);					}									WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number,											(windowsQElPtr) (dialogInfo->common)->cMsgView.message_number, actionCreate);					WASelectEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, (windowsQElPtr) mReplyQto, actionCreate);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);				}								break;			case mReplyto:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number,											(windowsQElPtr) (dialogInfo->common)->cMsgView.message_number, actionCreate);					WASelectEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, (windowsQElPtr) mReplyto, actionCreate);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);				}								break;			case mCommentQto:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))				{					if ((*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart <								(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selEnd)					{						selection_to_reply = NewHandleClear ((*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selEnd -											(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart + 2);						MoveHHi (selection_to_reply);						HLock (selection_to_reply);						HLock ((*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->hText);						BlockMove (*(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->hText +										(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart,										*selection_to_reply, (*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selEnd -											(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart);					}									WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number,											(windowsQElPtr) (dialogInfo->common)->cMsgView.message_number, actionCreate);					WASelectEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, (windowsQElPtr) mCommentQto, actionCreate);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);				}								break;			case mCommentto:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number,											(windowsQElPtr) (dialogInfo->common)->cMsgView.message_number, actionCreate);					WASelectEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, (windowsQElPtr) mCommentto, actionCreate);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);				}								break;			}						break;				case nodeM:			switch (menuItem)			{			case nBrowse:								if ((dialogInfo->common)->cMsgView.MessageBody)				{					if ((dialogInfo->common)->cMsgView.area_number)						tempaddr = ((dialogInfo->common)->cMsgView.MessageBody)->from;					else						if ((dialogInfo->common)->cMsgView.currentTE == 3 ||							(dialogInfo->common)->cMsgView.currentTE == 4)							tempaddr = ((dialogInfo->common)->cMsgView.MessageBody)->to;						else							tempaddr = ((dialogInfo->common)->cMsgView.MessageBody)->from;					if (tempaddr.point)						iii = 3;					else						if (tempaddr.node)							iii = 2;						else							if (tempaddr.net)								iii = 1;							else								iii = 0;					WNodeEventProcessor ((EventRecord *) iii, (windowsQElPtr) &tempaddr, actionCreate);				}				else					WNodeEventProcessor ((EventRecord *) 2L, (windowsQElPtr) &(*homesystem)->mainAddr.ad, actionCreate);				break;						case nWhoIs:							if ((dialogInfo->common)->cMsgView.area_number)					WhoIs (&((dialogInfo->common)->cMsgView.MessageBody)->from);				else					if ((dialogInfo->common)->cMsgView.currentTE == 3 ||						(dialogInfo->common)->cMsgView.currentTE == 4)						WhoIs (&((dialogInfo->common)->cMsgView.MessageBody)->to);					else						WhoIs (&((dialogInfo->common)->cMsgView.MessageBody)->from);				break;			case nNotepad:							WAddresseeEventProcessor ((EventRecord *) 1L, NULL, actionCreate);				break;			}						break;		case windowM:					switch (menuItem)			{			case wSubjects:								WSubjectsEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number,					(windowsQElPtr) (dialogInfo->common)->cMsgView.message_number, actionCreate);				break;			}						break;		}		break;		case actionOpen:			break;		case mouseDown:		if ((info >> 16) != inMenuBar)			where = event->where;		switch (info >> 16)		{		case inMenuBar:					recalcWindowMenu ();						SetPt (&theCell, 0, 0);					hMenu = GetMenuHandle (fileM + 256);			(*hMenu)->enableFlags = 1L | (1L << fQuit) | (1L << fClose) | (1L << fPageSetup);			if ((dialogInfo->common)->cMsgView.area_number != AreasNumber+1)				(*hMenu)->enableFlags |= (1L << fPost);						if ((dialogInfo->common)->cMsgView.message_total)#ifndef LITE				(*hMenu)->enableFlags |= (1L << fExport) | (1L << fPrint);#else				(*hMenu)->enableFlags |= (1L << fExport);#endif			hMenu = GetMenuHandle (editM + 256);			(*hMenu)->enableFlags = 1L | (1L << iUserName) | (1L << iOrigin) |										(1L << iShowKludges) | (1L << iShowPgf);			if ((dialogInfo->common)->cMsgView.message_total)				(*hMenu)->enableFlags |= (1L << iFind) | (1L << iFindNext); 			if ((dialogInfo->common)->cMsgView.currentTE ||				(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart !=					(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selEnd)				(*hMenu)->enableFlags |= (1L << iCopy);						hMenu = GetMenuHandle (msgM + 256);			(*hMenu)->enableFlags = 1L |				(((dialogInfo->common)->cMsgView.area_number != AreasNumber+1) ? (1L << mNew) : 0);						if ((dialogInfo->common)->cMsgView.message_total)				(*hMenu)->enableFlags |=							(1L << mReplyto) |							(1L << mReplyQto) |							(1L << mForward) |							(((dialogInfo->common)->cMsgView.area_number != AreasNumber+1 &&								(dialogInfo->common)->cMsgView.area_number) ?											(1L << mComment) : 0) |							(((dialogInfo->common)->cMsgView.area_number != AreasNumber+1 &&								(dialogInfo->common)->cMsgView.area_number) ?											(1L << mCommentQ) : 0) |							(((dialogInfo->common)->cMsgView.area_number != AreasNumber+1 &&								(dialogInfo->common)->cMsgView.area_number) ?											(1L << mCommentto) : 0) |							(((dialogInfo->common)->cMsgView.area_number != AreasNumber+1 &&								(dialogInfo->common)->cMsgView.area_number) ?											(1L << mCommentQto) : 0) |							(((dialogInfo->common)->cMsgView.area_number != AreasNumber+1) ?											(1L << mReply) : 0) |							(((dialogInfo->common)->cMsgView.area_number != AreasNumber+1) ?											(1L << mReplyQ) : 0);			if ((dialogInfo->common)->cMsgView.message_total &&				!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))				(*hMenu)->enableFlags |= (1L << mDelete);						if ((dialogInfo->common)->cMsgView.message_total &&				(dialogInfo->common)->cMsgView.area_number != AreasNumber+1 &&				((dialogInfo->common)->cMsgView.MessageBody)->flags & MSGLOCAL)				(*hMenu)->enableFlags |=							(1L << mEdit);			hMenu = GetMenuHandle (nodeM + 256);			(*hMenu)->enableFlags = 0;						if (padname[0])				(*hMenu)->enableFlags |= (1L | (1L << nNotepad));						if (yep ())			{				(*hMenu)->enableFlags |= 1L | (1L << nBrowse);				if ((dialogInfo->common)->cMsgView.message_total)					(*hMenu)->enableFlags |= (1L << nWhoIs);			}			hMenu = GetMenuHandle (shuffleM + 256);			(*hMenu)->enableFlags = -1L;			hMenu = GetMenuHandle (windowM + 256);			if (((WindowPeek)(dialogInfo->dialog))->windowKind != myKind_top)			{				(*hMenu)->enableFlags = -1L;			}			else				(*hMenu)->enableFlags = 0;			DrawMenuBar ();			break;		case inContent:					FindWindow (event->where, &window);						if (window != FrontWindow ())			{				if (((WindowPeek)FrontWindow ())->windowKind == myKind_top)					SysBeep (10);				else					SelectWindow (window);			}			else			{				SetPort (dialogInfo->dialog);				GlobalToLocal (&where);						//	е	Check in bodytext								ii = (dialogInfo->common)->cMsgView.currentTE;								if (!myTEMouseDown ((dialogInfo->common)->cMsgView.bodytext, where, event->modifiers))				{					iCtlPart = FindControl (where, dialogInfo->dialog, &whichCtl);										if (iCtlPart)					{						iPartCode = TrackControl (whichCtl, where, NULL);												if (iPartCode)						{							switch (LocateButton (dialogInfo->common, whichCtl))							{							case btKill:															if (windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))								{									CallASndPlay (129);									break;								}#if defined(powerc) || defined(__powerc)								ii = Alert (501, uupMyAlertProc);#else								ii = Alert (501, myAlertProc);#endif															if (ii == 2)									break;								//								if ((dialogInfo->common)->cMsgView.area_number == AreasNumber+1)//									OpenBase ( BADAREA, true );//								else//									OpenBase ((dialogInfo->common)->cMsgView.area_number, true);								msgbase_open_idx ((dialogInfo->common)->cMsgView.area_number, true);																DeleteMark ((dialogInfo->common)->cMsgView.area_number,										(dialogInfo->common)->cMsgView.message_number);								msgbase_delete_message ((dialogInfo->common)->cMsgView.message_number, ATOM_DELETED);								if ((dialogInfo->common)->cMsgView.message_number >=									(dialogInfo->common)->cMsgView.message_total-1)									(dialogInfo->common)->cMsgView.message_number--;																(dialogInfo->common)->cMsgView.message_total = msgbase_getnummsg ();								msgbase_close (CLOSE_UPDATE);								Broadcast (wtMsgView, broadDeleteCell,										(dialogInfo->common)->cMsgView.area_number,										(dialogInfo->common)->cMsgView.message_total);								Broadcast (wtSubjects, broadDeleteCell,										(dialogInfo->common)->cMsgView.area_number,										(dialogInfo->common)->cMsgView.message_number);								Broadcast (wtAreasList, broadRedrawCell,									(dialogInfo->common)->cMsgView.area_number, 0);/*								if (msgbase_read_atom ((dialogInfo->common)->cMsgView.message_number, &Atom))								{									Atom.base_flags = ATOM_DELETED;									msgbase_write_atom ((dialogInfo->common)->cMsgView.message_number, &Atom);																	DeleteMark ((dialogInfo->common)->cMsgView.area_number,											(dialogInfo->common)->cMsgView.message_number);									msgbase_setnummsg (msgbase_getnummsg () - 1);																		if ((dialogInfo->common)->cMsgView.message_number >=										(dialogInfo->common)->cMsgView.message_total-1)										(dialogInfo->common)->cMsgView.message_number--;																		(dialogInfo->common)->cMsgView.message_total = msgbase_getnummsg ();									msgbase_close (CLOSE_UPDATE);									Broadcast (wtMsgView, broadDeleteCell,											(dialogInfo->common)->cMsgView.area_number,											(dialogInfo->common)->cMsgView.message_total);									Broadcast (wtSubjects, broadDeleteCell,											(dialogInfo->common)->cMsgView.area_number,											(dialogInfo->common)->cMsgView.message_number);									Broadcast (wtAreasList, broadRedrawCell,										(dialogInfo->common)->cMsgView.area_number, 0);								}								else									msgbase_close (CLOSE_ONLY);*/								break;							case btNew:																if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))								{									WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);									Broadcast (wtMsgEdit, editNew,											(dialogInfo->common)->cMsgView.area_number, 0);								}								else								{									CallASndPlay (129);									WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);								}																break;														case btReplyQ:															if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))								{									if ((*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart <												(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selEnd)									{										selection_to_reply = NewHandleClear ((*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selEnd -															(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart + 2);										MoveHHi (selection_to_reply);										HLock (selection_to_reply);										HLock ((*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->hText);										BlockMove (*(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->hText +														(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart,														*selection_to_reply, (*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selEnd -															(*(*(dialogInfo->common)->cMsgView.bodytext)->bodytext)->selStart);									}									WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);									Broadcast (wtMsgEdit, editReplyQ,											(dialogInfo->common)->cMsgView.area_number,											(dialogInfo->common)->cMsgView.message_number);								}								else								{									CallASndPlay (129);									WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);								}																break;														case btReply:															if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))								{									WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);									Broadcast (wtMsgEdit, editReply,											(dialogInfo->common)->cMsgView.area_number,											(dialogInfo->common)->cMsgView.message_number);								}								else								{									CallASndPlay (129);									WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);								}																break;														case btEdit:															if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))								{									WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);									Broadcast (wtMsgEdit, editEdit,											(dialogInfo->common)->cMsgView.area_number,											(dialogInfo->common)->cMsgView.message_number);								}								else								{									CallASndPlay (129);									WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cMsgView.area_number, 0, actionCreate);								}																break;														case btLocked://								if ((dialogInfo->common)->cMsgView.area_number == AreasNumber+1)//									OpenBase ( BADAREA, true );//								else//									OpenBase ((dialogInfo->common)->cMsgView.area_number, true);								msgbase_open_idx ((dialogInfo->common)->cMsgView.area_number, true);								if ( msgbase_read_atom ( (dialogInfo->common)->cMsgView.message_number, &Atom ) )								{									Atom.base_flags ^= ATOM_LOCKED;									msgbase_write_atom ( (dialogInfo->common)->cMsgView.message_number, &Atom );									SetControlValue ( (dialogInfo->common)->cMsgView.controlsArray[btLocked],											(Atom.base_flags & ATOM_LOCKED) ? btIDLocked : btIDULocked);									msgbase_close (CLOSE_UPDATE);																		Broadcast (wtSubjects, broadRedrawCell,										(dialogInfo->common)->cMsgView.area_number,										(dialogInfo->common)->cMsgView.message_number);								}								else									msgbase_close (CLOSE_ONLY);																break;														case btMarked:																(*markArray[(dialogInfo->common)->cMsgView.area_number])									[(dialogInfo->common)->cMsgView.message_number] ^= 0xFF,																SetControlValue ( (dialogInfo->common)->cMsgView.controlsArray[btMarked],										((*markArray[(dialogInfo->common)->cMsgView.area_number])											[(dialogInfo->common)->cMsgView.message_number]) ?												btIDMarked : btIDUMarked);								Broadcast (wtSubjects, broadRedrawCell,									(dialogInfo->common)->cMsgView.area_number,									(dialogInfo->common)->cMsgView.message_number);								break;															case btKludge:																needfilter = !needfilter;								hMenu = GetMenu (editM + 256);								CheckItem (hMenu, iShowKludges, needfilter);																SetControlValue ( (dialogInfo->common)->cMsgView.controlsArray[btKludge],										(!needfilter) ? btIDKludge : btIDUKludge);								for (ii = 0; ii <= AreasNumber+1; ii++)									Broadcast (wtMsgView, broadRedrawCell, ii, 0);								break;															case btPgf:																needpgf = !needpgf;								hMenu = GetMenu (editM + 256);								CheckItem (hMenu, iShowPgf, needpgf);																SetControlValue ( (dialogInfo->common)->cMsgView.controlsArray[btPgf],										(!needpgf) ? btIDPgf : btIDUPgf);								for (ii = 0; ii <= AreasNumber+1; ii++)									Broadcast (wtMsgView, broadRedrawCell, ii, 0);								break;															case btLeft:								InitContents (dialogInfo,										(dialogInfo->common)->cMsgView.area_number,										--(dialogInfo->common)->cMsgView.message_number, true);								break;							case btRight:															InitContents (dialogInfo,										(dialogInfo->common)->cMsgView.area_number,										++(dialogInfo->common)->cMsgView.message_number, true);								break;							case btTHome://								if ((dialogInfo->common)->cMsgView.area_number == AreasNumber+1)//									OpenBase ( BADAREA, true );//								else//									OpenBase ((dialogInfo->common)->cMsgView.area_number, true);								msgbase_open_idx ((dialogInfo->common)->cMsgView.area_number, true);								ltemp = (dialogInfo->common)->cMsgView.message_number;								ctemp = -1;																while (ltemp != -1)								{									if ( msgbase_read_atom ( ltemp, &Atom ) )									{										ctemp = ltemp;										ltemp = Atom.msg_reply_prev;									}									else										break;								}																msgbase_close (CLOSE_ONLY);													if (ctemp != -1 && ctemp != (dialogInfo->common)->cMsgView.message_number)								{									(dialogInfo->common)->cMsgView.message_number = ctemp;									InitContents (dialogInfo,										(dialogInfo->common)->cMsgView.area_number,										(dialogInfo->common)->cMsgView.message_number, true);								}								break;							case btTLeft:							//								if ((dialogInfo->common)->cMsgView.area_number == AreasNumber+1)//									OpenBase ( BADAREA, true );//								else//									OpenBase ((dialogInfo->common)->cMsgView.area_number, true);								msgbase_open_idx ((dialogInfo->common)->cMsgView.area_number, true);								if ( msgbase_read_atom ( (dialogInfo->common)->cMsgView.message_number, &Atom ) )								{									msgbase_close (CLOSE_ONLY);									if (Atom.msg_reply_prev != -1)									{										(dialogInfo->common)->cMsgView.message_number = Atom.msg_reply_prev;										InitContents (dialogInfo,											(dialogInfo->common)->cMsgView.area_number,											(dialogInfo->common)->cMsgView.message_number, true);									}								}								else									msgbase_close (CLOSE_ONLY);															break;							case btTRight:							//								if ((dialogInfo->common)->cMsgView.area_number == AreasNumber+1)//									OpenBase ( BADAREA, true );//								else//									OpenBase ((dialogInfo->common)->cMsgView.area_number, true);								msgbase_open_idx ((dialogInfo->common)->cMsgView.area_number, true);								if ( msgbase_read_atom ( (dialogInfo->common)->cMsgView.message_number, &Atom ) )								{									msgbase_close (CLOSE_ONLY);															if (Atom.msg_reply_next != -1)									{										(dialogInfo->common)->cMsgView.message_number = Atom.msg_reply_next;										InitContents (dialogInfo,											(dialogInfo->common)->cMsgView.area_number,											(dialogInfo->common)->cMsgView.message_number, true);									}								}								else									msgbase_close (CLOSE_ONLY);															break;															case btLRead:							//								if ((dialogInfo->common)->cMsgView.area_number == AreasNumber+1)//									OpenBase ( BADAREA, true );//								else//									OpenBase ((dialogInfo->common)->cMsgView.area_number, true);								msgbase_open_idx ((dialogInfo->common)->cMsgView.area_number, true);								ltemp = msgbase_scanunread ((dialogInfo->common)->cMsgView.message_number, -1);																if ((dialogInfo->common)->cMsgView.message_number > ltemp)								{									(dialogInfo->common)->cMsgView.message_number = ltemp;										InitContents (dialogInfo,											(dialogInfo->common)->cMsgView.area_number,											(dialogInfo->common)->cMsgView.message_number, true);								}								else									CallASndPlay (132);																msgbase_close (CLOSE_ONLY);															break;							case btRRead:							//								if ((dialogInfo->common)->cMsgView.area_number == AreasNumber+1)//									OpenBase ( BADAREA, true );//								else//									OpenBase ((dialogInfo->common)->cMsgView.area_number, true);								msgbase_open_idx ((dialogInfo->common)->cMsgView.area_number, true);								ltemp = msgbase_scanunread ((dialogInfo->common)->cMsgView.message_number, 1);																if ((dialogInfo->common)->cMsgView.message_number < ltemp)								{									(dialogInfo->common)->cMsgView.message_number = ltemp;										InitContents (dialogInfo,											(dialogInfo->common)->cMsgView.area_number,											(dialogInfo->common)->cMsgView.message_number, true);								}								else									CallASndPlay (132);																msgbase_close (CLOSE_ONLY);															break;							case btHRead:							//								if ((dialogInfo->common)->cMsgView.area_number == AreasNumber+1)//									OpenBase ( BADAREA, true );//								else//									OpenBase ((dialogInfo->common)->cMsgView.area_number, true);								msgbase_open_idx ((dialogInfo->common)->cMsgView.area_number, true);								ltemp = msgbase_scanunread (0, 0);																if ((dialogInfo->common)->cMsgView.message_number != ltemp)								{									(dialogInfo->common)->cMsgView.message_number = ltemp;										InitContents (dialogInfo,											(dialogInfo->common)->cMsgView.area_number,											(dialogInfo->common)->cMsgView.message_number, true);								}								else									CallASndPlay (132);																msgbase_close (CLOSE_ONLY);															break;							}						}											break;					}					else					{						GetDialogItem (dialogInfo->dialog, miFrom, &iType, &iHandle, &iRect);						if (PtInRect (where, &iRect))						{							(dialogInfo->common)->cMsgView.currentTE = 1;						}						else						{							GetDialogItem (dialogInfo->dialog, miAka, &iType, &iHandle, &iRect);							if (PtInRect (where, &iRect))							{								(dialogInfo->common)->cMsgView.currentTE = 2;							}							else							{								GetDialogItem (dialogInfo->dialog, miTo, &iType, &iHandle, &iRect);								if (PtInRect (where, &iRect))								{									(dialogInfo->common)->cMsgView.currentTE = 3;								}								else								{									GetDialogItem (dialogInfo->dialog, miToAd, &iType, &iHandle, &iRect);									if (PtInRect (where, &iRect))									{										(dialogInfo->common)->cMsgView.currentTE =											((dialogInfo->common)->cMsgView.area_number == 0) ? 4 : 0;									}									else									{										GetDialogItem (dialogInfo->dialog, miSubj, &iType, &iHandle, &iRect);										if (PtInRect (where, &iRect))										{											(dialogInfo->common)->cMsgView.currentTE = 5;										}										else										{											(dialogInfo->common)->cMsgView.currentTE = 0;										}									}								}							}						}					}				}				else					(dialogInfo->common)->cMsgView.currentTE = 0;								GetBackColor (&color1);				color.red = color.green = color.blue = 0xFFFF;				RGBBackColor(&color);				if ((dialogInfo->common)->cMsgView.currentTE != ii)				{					if (ii > 0)					{						TE32KDeactivate ((dialogInfo->common)->cMsgView.te.array[ii-1]);						LongRectToRect (&(*(dialogInfo->common)->cMsgView.te.array[ii-1])->viewRect, &rView);						InsetRect (&rView, -2, -2);						InvalRect (&rView);					}										if ((dialogInfo->common)->cMsgView.currentTE > 0)					{						TE32KActivate ((dialogInfo->common)->cMsgView.te.array[(dialogInfo->common)->cMsgView.currentTE-1]);						LongRectToRect (&(*(dialogInfo->common)->cMsgView.te.array[(dialogInfo->common)->cMsgView.currentTE-1])->viewRect, &rView);						InsetRect (&rView, -2, -2);						InvalRect (&rView);					}				}								for (iPartCode=0; iPartCode<5; iPartCode++)				{					TE32KSetSelect (0, (iPartCode+1 == (dialogInfo->common)->cMsgView.currentTE) ? 0x7FFF : 0,								(dialogInfo->common)->cMsgView.te.array[iPartCode]);				}								if ((dialogInfo->common)->cMsgView.currentTE)				{					TE32KAutoView (false, (*(dialogInfo->common)->cMsgView.bodytext)->bodytext);					TE32KSetSelect (0, 0, (*(dialogInfo->common)->cMsgView.bodytext)->bodytext);					TE32KAutoView (true, (*(dialogInfo->common)->cMsgView.bodytext)->bodytext);				}				//				color.red = color.green = color.blue = 50000;				RGBBackColor(&color1);			}			break;		case inZoomIn:		case inZoomOut:			SetPort (dialogInfo->dialog);			if (TrackBox (dialogInfo->dialog, event->where, info >> 16))			{				SetPort (dialogInfo->dialog);				ZoomWindow (dialogInfo->dialog, info >> 16, true);//				AdjustFields (dialogInfo->dialog, (dialogInfo->common)->cMsgView.bodytext);				AdjustWinSize ((dialogInfo->common)->cMsgView.bodytext, (dialogInfo->dialog)->portRect.bottom);				EraseRect (&(dialogInfo->dialog)->portRect);				GetBackColor (&color1);				color.red = color.green = color.blue = 0xFFFF;				RGBBackColor(&color);				LongRectToRect (&(*((*((dialogInfo->common)->cMsgView.bodytext))->bodytext))->viewRect, &tRect);				EraseRect (&tRect);//				color.red = color.green = color.blue = 50000;				RGBBackColor(&color1);				originalView = (*(((WindowPeek)(dialogInfo->dialog))->contRgn))->rgnBBox;				originalView.bottom = (dialogInfo->dialog)->portRect.bottom;				InvalRect (&(dialogInfo->dialog)->portRect);			}			break;				case inGoAway:					if (TrackGoAway (dialogInfo->dialog, event->where))				if (event->modifiers & optionKey)					Broadcast (wtMsgView, broadClose, 0, 0);				else					WViewEventProcessor (event, dialogInfo, actionClose);						break;		case inDrag:			FindWindow (event->where, &window);						if (window != FrontWindow ())			{				if (((WindowPeek)FrontWindow ())->windowKind == myKind_top)					SysBeep (10);				else					SelectWindow (window);			}			else			{				DragWindow ( dialogInfo->dialog, event->where, &qd.screenBits.bounds );				originalView = (*(((WindowPeek)(dialogInfo->dialog))->contRgn))->rgnBBox;				originalView.bottom = (dialogInfo->dialog)->portRect.bottom;			}						break;		case inGrow:					SetPort (dialogInfo->dialog);			GetDialogItem ( dialogInfo->dialog, miBody, &iType, &iHandle, &rView );						rDataBnds.top = rView.top + 10 * (*((*((dialogInfo->common)->cMsgView.bodytext))->bodytext))->lineHeight;			rDataBnds.bottom = qd.screenBits.bounds.bottom;			rDataBnds.left = (dialogInfo->dialog)->portRect.right;			rDataBnds.right = (dialogInfo->dialog)->portRect.right + 1;			SetPort (dialogInfo->dialog);			lSizeVH = GrowWindow ( dialogInfo->dialog, event->where, &rDataBnds );						if (lSizeVH)			{				SizeWindow (dialogInfo->dialog, LoWord (lSizeVH), HiWord (lSizeVH), true);//				AdjustFields (dialogInfo->dialog, (dialogInfo->common)->cMsgView.bodytext);				AdjustWinSize ((dialogInfo->common)->cMsgView.bodytext, HiWord (lSizeVH));				EraseRect (&(dialogInfo->dialog)->portRect);				GetBackColor (&color1);				color.red = color.green = color.blue = 0xFFFF;				RGBBackColor(&color);				LongRectToRect (&(*((*((dialogInfo->common)->cMsgView.bodytext))->bodytext))->viewRect, &tRect);				EraseRect (&tRect);//				color.red = color.green = color.blue = 50000;				RGBBackColor(&color1);				InvalRect (&(dialogInfo->dialog)->portRect);			}						break;		}			break;		case keyDown:	case autoKey:				SetPort (dialogInfo->dialog);		key = event->message & 0xFF;				if ((event->message & 0xFF00) == 0x7C00 && (event->modifiers & optionKey))			goto next;				if ((event->message & 0xFF00) == 0x7B00 && (event->modifiers & optionKey))			if (event->modifiers & shiftKey)				if (event->modifiers & controlKey)					goto first;				else					goto reply_exact;			else				goto reply;		switch (key)		{		case HelpKey:					if (!(dialogInfo->common)->cMsgView.message_total)				break;			if ((dialogInfo->common)->cMsgView.area_number)				WhoIs (&((dialogInfo->common)->cMsgView.MessageBody)->from);			else				if ((dialogInfo->common)->cMsgView.currentTE == 3 ||					(dialogInfo->common)->cMsgView.currentTE == 4)					WhoIs (&((dialogInfo->common)->cMsgView.MessageBody)->to);				else					WhoIs (&((dialogInfo->common)->cMsgView.MessageBody)->from);			break;				case DeleteFwdKey:					if (!(dialogInfo->common)->cMsgView.message_total)				break;			if (windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))			{				CallASndPlay (129);				break;			}			#if defined(powerc) || defined(__powerc)			ii = Alert (501, uupMyAlertProc);#else			ii = Alert (501, myAlertProc);#endif					if (ii == 2)				break;					msgbase_open_idx ((dialogInfo->common)->cMsgView.area_number, true);			DeleteMark ((dialogInfo->common)->cMsgView.area_number,						(dialogInfo->common)->cMsgView.message_number);			msgbase_delete_message ((dialogInfo->common)->cMsgView.message_number, ATOM_DELETED);			if ((dialogInfo->common)->cMsgView.message_number >=				(dialogInfo->common)->cMsgView.message_total-1)				(dialogInfo->common)->cMsgView.message_number--;						(dialogInfo->common)->cMsgView.message_total = msgbase_getnummsg ();			msgbase_close (CLOSE_UPDATE);			Broadcast (wtMsgView, broadDeleteCell,					(dialogInfo->common)->cMsgView.area_number,					(dialogInfo->common)->cMsgView.message_total);			Broadcast (wtSubjects, broadDeleteCell,					(dialogInfo->common)->cMsgView.area_number,					(dialogInfo->common)->cMsgView.message_number);			Broadcast (wtAreasList, broadRedrawCell,				(dialogInfo->common)->cMsgView.area_number, 0);			break;		case ' ':			if (!(dialogInfo->common)->cMsgView.message_total)				break;			(*markArray[(dialogInfo->common)->cMsgView.area_number])				[(dialogInfo->common)->cMsgView.message_number] ^= 0xFF,						SetControlValue ( (dialogInfo->common)->cMsgView.controlsArray[btMarked],					((*markArray[(dialogInfo->common)->cMsgView.area_number])						[(dialogInfo->common)->cMsgView.message_number]) ?							btIDMarked : btIDUMarked);			Broadcast (wtSubjects, broadRedrawCell,				(dialogInfo->common)->cMsgView.area_number,				(dialogInfo->common)->cMsgView.message_number);			break;					case '/':					if (!(dialogInfo->common)->cMsgView.message_total)				break;			msgbase_open_idx ((dialogInfo->common)->cMsgView.area_number, true);			if ( msgbase_read_atom ( (dialogInfo->common)->cMsgView.message_number, &Atom ) )			{				Atom.base_flags &= ~ATOM_WASREAD;				msgbase_write_atom ( (dialogInfo->common)->cMsgView.message_number, &Atom );			}			msgbase_close (CLOSE_UPDATE);						InitContents (dialogInfo,				(dialogInfo->common)->cMsgView.area_number,				(dialogInfo->common)->cMsgView.message_number, false);			Broadcast (wtAreasList, broadRedrawCell,				(dialogInfo->common)->cMsgView.area_number, 0);						Broadcast (wtSubjects, broadRedrawCell,				(dialogInfo->common)->cMsgView.area_number,				(dialogInfo->common)->cMsgView.message_number);/*			Broadcast (wtSubjects, broadRedrawCell,				(dialogInfo->common)->cMsgView.area_number, ctemp);*/			break;				case DownArrowKey:					GetBackColor (&color1);			color.red = color.green = color.blue = 0xFFFF;			RGBBackColor(&color);			VActionProc ((*((dialogInfo->common)->cMsgView.bodytext))->scroll, kControlDownButtonPart);//			color.red = color.green = color.blue = 50000;			RGBBackColor(&color1);			break;				case UpArrowKey:					GetBackColor (&color1);			color.red = color.green = color.blue = 0xFFFF;			RGBBackColor(&color);			VActionProc ((*((dialogInfo->common)->cMsgView.bodytext))->scroll, kControlUpButtonPart);//			color.red = color.green = color.blue = 50000;			RGBBackColor(&color1);			break;				case PageDownKey:					GetBackColor (&color1);			color.red = color.green = color.blue = 0xFFFF;			RGBBackColor(&color);			VActionProc ((*((dialogInfo->common)->cMsgView.bodytext))->scroll, kControlPageDownPart);//			color.red = color.green = color.blue = 50000;			RGBBackColor(&color1);			break;				case PageUpKey:					GetBackColor (&color1);			color.red = color.green = color.blue = 0xFFFF;			RGBBackColor(&color);			VActionProc ((*((dialogInfo->common)->cMsgView.bodytext))->scroll, kControlPageUpPart);//			color.red = color.green = color.blue = 50000;			RGBBackColor(&color1);			break;				case LeftArrowKey:					if ((dialogInfo->common)->cMsgView.message_total && (dialogInfo->common)->cMsgView.message_number != 0)			{				InitContents (dialogInfo,					(dialogInfo->common)->cMsgView.area_number,					--(dialogInfo->common)->cMsgView.message_number, true);			}			else				CallASndPlay (132);							break;		case RightArrowKey:						if ((dialogInfo->common)->cMsgView.message_total && (dialogInfo->common)->cMsgView.message_number != (dialogInfo->common)->cMsgView.message_total-1)			{				InitContents (dialogInfo,					(dialogInfo->common)->cMsgView.area_number,					++(dialogInfo->common)->cMsgView.message_number, true);			}			else				CallASndPlay (132);			break;		case HomeKey:					if ((dialogInfo->common)->cMsgView.message_total && (dialogInfo->common)->cMsgView.message_number != 0)			{				(dialogInfo->common)->cMsgView.message_number = 0;				InitContents (dialogInfo,					(dialogInfo->common)->cMsgView.area_number,					(dialogInfo->common)->cMsgView.message_number, true);			}			break;		case EndKey:					if ((dialogInfo->common)->cMsgView.message_total && (dialogInfo->common)->cMsgView.message_number != (dialogInfo->common)->cMsgView.message_total-1)			{				(dialogInfo->common)->cMsgView.message_number = (dialogInfo->common)->cMsgView.message_total - 1;				InitContents (dialogInfo,					(dialogInfo->common)->cMsgView.area_number,					(dialogInfo->common)->cMsgView.message_number, true);			}			break;					case '0':						if ((event->message & 0xFF00) != 0x5200)				break;					if (!(dialogInfo->common)->cMsgView.message_total)				break;			msgbase_open_idx ((dialogInfo->common)->cMsgView.area_number, true);			ltemp = msgbase_scanunread (0, 0);						if ((dialogInfo->common)->cMsgView.message_number != ltemp)			{				(dialogInfo->common)->cMsgView.message_number = ltemp;					InitContents (dialogInfo,						(dialogInfo->common)->cMsgView.area_number,						(dialogInfo->common)->cMsgView.message_number, true);			}			else				CallASndPlay (132);						msgbase_close (CLOSE_ONLY);					break;		case TabKey:			if (!(dialogInfo->common)->cMsgView.message_total)				goto TabBer;			msgbase_open_idx ((dialogInfo->common)->cMsgView.area_number, true);			if ( msgbase_read_atom ( (dialogInfo->common)->cMsgView.message_number, &Atom ) )			{				if (Atom.msg_reply_next != -1)				{					(dialogInfo->common)->cMsgView.message_number = Atom.msg_reply_next;					InitContents (dialogInfo,						(dialogInfo->common)->cMsgView.area_number,						(dialogInfo->common)->cMsgView.message_number, true);				}				else				{					ltemp = msgbase_scanunread (0, 0);										if ((dialogInfo->common)->cMsgView.message_number != ltemp)					{						(dialogInfo->common)->cMsgView.message_number = ltemp;							InitContents (dialogInfo,								(dialogInfo->common)->cMsgView.area_number,								(dialogInfo->common)->cMsgView.message_number, true);					}					else					{						msgbase_close (CLOSE_ONLY);										TabBer:											iii = (dialogInfo->common)->cMsgView.area_number + 1;						while (iii <= AreasNumber + 1)						{							if (trackUnread (iii, &ltemp, &mn))								break;							iii++;						}												if (iii > AreasNumber + 1)							CallASndPlay (132);						else						{							WViewEventProcessor ((EventRecord *) iii, (windowsQElPtr) -1L, actionCreate);							WViewEventProcessor (NULL, dialogInfo, actionClose);						}											break;					}				}			}			msgbase_close (CLOSE_ONLY);					break;				case '*':				first:			if (!(dialogInfo->common)->cMsgView.message_total)				break;			msgbase_open_idx ((dialogInfo->common)->cMsgView.area_number, true);			ltemp = (dialogInfo->common)->cMsgView.message_number;			ctemp = -1;						while (ltemp != -1)			{				if ( msgbase_read_atom ( ltemp, &Atom ) )				{					ctemp = ltemp;					ltemp = Atom.msg_reply_prev;				}				else					break;			}						msgbase_close (CLOSE_ONLY);			if (ctemp != -1 && ctemp != (dialogInfo->common)->cMsgView.message_number)			{				(dialogInfo->common)->cMsgView.message_number = ctemp;				InitContents (dialogInfo,					(dialogInfo->common)->cMsgView.area_number,					(dialogInfo->common)->cMsgView.message_number, true);			}			break;		case '-':					if (event->modifiers & optionKey)			{			reply_exact:							if (!(dialogInfo->common)->cMsgView.message_total)					break;				msgbase_open_idx ((dialogInfo->common)->cMsgView.area_number, true);				ctemp = -1;				if (msgbase_read_atom ( (dialogInfo->common)->cMsgView.message_number, &Atom1 ) &&						Atom1.msg_reply_prev != -1)				{					ltemp = Atom1.msg_reply_prev;					while (ltemp != -1)					{						if (msgbase_read_atom ( ltemp, &Atom ))						{							if (Atom.base_flags & ATOM_MSGID)							{								if ((Atom.base_flags & ATOM_NONFTNMSGID) && (Atom1.base_flags & ATOM_NONFTNREPLY))								{									if (Atom.msgid_crc == Atom1.reply_crc)									{										ctemp = ltemp;										break;									}								}								else									if (!(Atom.base_flags & ATOM_NONFTNMSGID) && !(Atom1.base_flags & ATOM_NONFTNREPLY))									{										if (Atom.msgid_num == Atom1.reply_num && cmp2addrs (&Atom.from, &Atom1.reply))										{											ctemp = ltemp;											break;										}									}							}														ctemp = ltemp;							ltemp = Atom.msg_reply_prev;						}						else						{							ctemp = -1;							break;						}					}				}								msgbase_close (CLOSE_ONLY);				if (ctemp != -1 && ctemp != (dialogInfo->common)->cMsgView.message_number)				{					(dialogInfo->common)->cMsgView.message_number = ctemp;					InitContents (dialogInfo,						(dialogInfo->common)->cMsgView.area_number,						(dialogInfo->common)->cMsgView.message_number, true);				}				else					SysBeep (10);			}			else			{			reply:							if (!(dialogInfo->common)->cMsgView.message_total)					break;				msgbase_open_idx ((dialogInfo->common)->cMsgView.area_number, true);				if ( msgbase_read_atom ( (dialogInfo->common)->cMsgView.message_number, &Atom ) )				{					msgbase_close (CLOSE_ONLY);					if (Atom.msg_reply_prev != -1)					{						(dialogInfo->common)->cMsgView.message_number = Atom.msg_reply_prev;						InitContents (dialogInfo,							(dialogInfo->common)->cMsgView.area_number,							(dialogInfo->common)->cMsgView.message_number, true);					}				}				else					msgbase_close (CLOSE_ONLY);			}					break;		case '+':				next:					if (!(dialogInfo->common)->cMsgView.message_total)				break;			msgbase_open_idx ((dialogInfo->common)->cMsgView.area_number, true);			if ( msgbase_read_atom ( (dialogInfo->common)->cMsgView.message_number, &Atom ) )			{				msgbase_close (CLOSE_ONLY);				if (Atom.msg_reply_next != -1)				{					(dialogInfo->common)->cMsgView.message_number = Atom.msg_reply_next;					InitContents (dialogInfo,						(dialogInfo->common)->cMsgView.area_number,						(dialogInfo->common)->cMsgView.message_number, true);				}			}			else				msgbase_close (CLOSE_ONLY);			break;		}				break;			case updateEvt://		Debugger ();		SetPort (dialogInfo->dialog);		BeginUpdate (dialogInfo->dialog);/*		color.red = color.green = color.blue = 0xFFFF;		RGBBackColor(&color);		LongRectToRect (&(*((*((dialogInfo->common)->cMsgView.bodytext))->bodytext))->viewRect, &iRect);		iRect.bottom = (dialogInfo->dialog)->portRect.bottom - 2;		EraseRect (&iRect);		color.red = color.green = color.blue = 50000;		RGBBackColor(&color);*/		DrawContents (dialogInfo->common);		UpdateDialog (dialogInfo->dialog, (dialogInfo->dialog)->visRgn);				if (needpgf)			TE32KFeatureFlag (te32KFShowCarridgeReturns, TE32KBitSet, (*((dialogInfo->common)->cMsgView.bodytext))->bodytext);		else			TE32KFeatureFlag (te32KFShowCarridgeReturns, TE32KBitClear, (*((dialogInfo->common)->cMsgView.bodytext))->bodytext);		myTEUpdate ((dialogInfo->common)->cMsgView.bodytext);		if (!(dialogInfo->inFront))		{			SetRect (&iRect,				(*(*((dialogInfo->common)->cMsgView.bodytext))->bodytext)->viewRect.right + 2,				(*(*((dialogInfo->common)->cMsgView.bodytext))->bodytext)->viewRect.top - 2,				(dialogInfo->dialog)->portRect.right,				(dialogInfo->dialog)->portRect.bottom - 15);						EraseRect (&iRect);			MoveTo (iRect.left, iRect.top);			LineTo (iRect.left, iRect.bottom);		}		GetBackColor (&color1);		color.red = color.green = color.blue = 0xFFFF;		RGBBackColor(&color);		if ((dialogInfo->common)->cMsgView.MessageBody &&			((dialogInfo->common)->cMsgView.MessageBody)->flags & MSGLOCAL)			if (*((short *) 0x0D60) == 1)			{				(*(dialogInfo->common)->cMsgView.te.named.from)->txFace = underline;				TextFace (underline);			}			else				ForeColor (redColor);		RectToLongRect (&(dialogInfo->dialog)->portRect, &tlRect);//		littleTE32KUpdate (&tlRect, (dialogInfo->common)->cMsgView.te.named.from);		littleTE32KUpdate (&(dialogInfo->dialog)->portRect, (dialogInfo->common)->cMsgView.te.named.from);		(*(dialogInfo->common)->cMsgView.te.named.from)->txFace = 0;		TextFace (0);		ForeColor (blackColor);//		littleTE32KUpdate (&tlRect, (dialogInfo->common)->cMsgView.te.named.fromaddr);		littleTE32KUpdate (&(dialogInfo->dialog)->portRect, (dialogInfo->common)->cMsgView.te.named.fromaddr);		if ((dialogInfo->common)->cMsgView.MessageBody)		{			strcpy ( &tmp[1], (dialogInfo->common)->cMsgView.MessageBody->toname );			tmp[0] = strlen ( &tmp[1] );			if (myname ((StringPtr) tmp))				if (*((short *) 0x0D60) == 1)				{					(*(dialogInfo->common)->cMsgView.te.named.to)->txFace = underline;					TextFace (underline);				}				else					ForeColor (redColor);		}//		littleTE32KUpdate (&tlRect, (dialogInfo->common)->cMsgView.te.named.to);		littleTE32KUpdate (&(dialogInfo->dialog)->portRect, (dialogInfo->common)->cMsgView.te.named.to);		(*(dialogInfo->common)->cMsgView.te.named.to)->txFace = 0;		TextFace (0);		ForeColor (blackColor);		if (!(dialogInfo->common)->cMsgView.area_number)//			littleTE32KUpdate (&tlRect, (dialogInfo->common)->cMsgView.te.named.toaddr);			littleTE32KUpdate (&(dialogInfo->dialog)->portRect, (dialogInfo->common)->cMsgView.te.named.toaddr);		//		littleTE32KUpdate (&tlRect, (dialogInfo->common)->cMsgView.te.named.subj);		littleTE32KUpdate (&(dialogInfo->dialog)->portRect, (dialogInfo->common)->cMsgView.te.named.subj);//		color.red = color.green = color.blue = 50000;		RGBBackColor(&color1);		TE32KUpdate (&tlRect, (dialogInfo->common)->cMsgView.te.named.date);		UpdateControls (dialogInfo->dialog, (dialogInfo->dialog)->visRgn);		DrawOnlyGrowIcon (dialogInfo->dialog);		EndUpdate (dialogInfo->dialog);			break;	case nullEvent:				where = event->where;		GetPort (&oldPort);		SetPort (dialogInfo->dialog);				GlobalToLocal (&where);		LongRectToRect (&(*((*(dialogInfo->common)->cMsgView.bodytext)->bodytext))->viewRect, &tRect);		if (PtInRect (where, &tRect))		{			iType = 0;//			SetCursor (&iBeam);		}		else			iType = -1;//			InitCursor ();		if (crsI != iType)		{			crsI = iType;						if (crsI < 0)				InitCursor ();			else				SetCursor (&crs[crsI]);		}		SetPort (oldPort);		break;	}}void WViewDialogProcessor (EventRecord *event, windowsQElPtr dialogInfo, long info){	DialogPtr	dialog;	short		iHit;	Point		where;	/*	if (IsDialogEvent (event))	{		if (DialogSelect (event, &dialog, &iHit))		{			switch (iHit)			{//			case miFlagPopUp:				//				HandlePopUp ((dialogInfo->common)->cMsgView.flagsPopUp, NULL);//				event->what = 0;//				break;				//			case miAka:				//				HandlePopUp ((dialogInfo->common)->cMsgView.AkaPopUp, NULL);//				event->what = 0;//				break;							default:							break;			}		}	}*/}