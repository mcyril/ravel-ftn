#include <Sound.h>#include <stdio.h>#include <string.h>#include "TE32K.h"#include "PascalStr.h"#include "DialogLib.h"#include "PopUpLib.h"#include "myTEdit.h"//#include "Ravel_FTN.h"#include "ravel_msg_base.h"#include "Ravel_Prefs.h"#include "Preferences.h"#include "pktparse.h"#include "stringutl.h"#include "nodelist.h"#include "rPrinting.h"//#include "BaseManager.h"/*ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее*/#include "CommonData.h"#include "WindowsList.h"#include "WSubjects.h"#include "WView.h"#include "WEdit.h"#include "WASelect.h"#include "WNodes.h"#include "WAddressee.h"#include "WFind.h"#include "NodeCookie.h"#include "multisaver.h"#include "SoundLib.h"/*ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее*/#include "Templates.h"#include "rMenus.h"/*ееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееееее*/extern	Handle	*markArray;typedef struct _wloc {	Point	topleft;	short	bottom;	} wloc;#if defined(powerc) || defined(__powerc)	extern	UniversalProcPtr	uupMyAlertProc;#else	pascal Boolean myAlertProc ( DialogPtr theDialog, EventRecord *theEvent, short *itemHit );#endifstatic	Rect	originalView = {0,0,0,0};void		DeleteMark (long area, long message);void		DoEvent (EventRecord *event);pascal void LDEFSubj (short lMessage, Boolean lSelect, Rect *lRect, Cell lCell,				short lDataOffset, short lDataLen, ListHandle lHandle);//#define cLeftOffset		5pascal void LDEFSubj (short lMessage, Boolean lSelect, Rect *lRect, Cell lCell,				short lDataOffset, short lDataLen, ListHandle lHandle){	short 		leftDraw, topDraw, k;	FontInfo 	fi;	unsigned short	i;	pktmsg		*m;	Str255		title, temp;	Point		drawpt;	char		tmp[128];	windowsQElPtr	dialogInfo;//	Boolean		readed;//	msgbase_atom	Atom;	unsigned char	oldMode;	PenState	penState;			if ((lMessage == lInitMsg) || (lMessage == lCloseMsg))		return ;		leftDraw = lRect->left+(*lHandle)->indent.h;	topDraw = lRect->top+(*lHandle)->indent.v;		switch (lMessage)	{	case lDrawMsg:			SetPort ((*lHandle)->port);		EraseRect (lRect);			if (lDataLen == 2)		{			TextFont (viewFont);			TextSize (viewSize);			GetFontInfo (&fi);			SetPt ( &drawpt, leftDraw, topDraw+fi.leading+fi.ascent );			i = *(unsigned short *)((*(*lHandle)->cells)+lDataOffset);//			memcpy ( (Ptr) &i, *((*lHandle)->cells)+lDataOffset, 2 );			//е	locked dot//е	marked dot//е message number//			msgbase_read_atom ( i, &Atom );//			readed = !(Atom.deleted & ATOM_WASREAD);			msgbase_read_message (i, &m, READMODE_ONLY);						dialogInfo = (windowsQElPtr) GetWRefCon ((*lHandle)->port);						sprintf (tmp, "%c%c%c%4ld",							((m->base_flags & ATOM_LOCKED) != 0) ? 0x11 : 0x20,				((*markArray[(dialogInfo->common)->cSubjList.area_number])[i]) ? 0x04 : 0x20,				((m->base_flags & ATOM_WASREAD) == 0) ? 0x10 : 0x20,				i+1 );						MoveTo ( drawpt.h + 1, drawpt.v );			DrawText (tmp, 0, strlen (tmp));//е from name			strcpy ( (char *) &temp[1], m->fromname );			temp[0] = strlen (m->fromname);			if (temp[0] > 20)			{				temp[0] = 17;				pStrConc ( temp, "\p...", temp );			}						MoveTo ( drawpt.h + fi.widMax*8 + 1, drawpt.v );			if (m->flags & MSGLOCAL)			{				if (*((short *) 0x0D60) == 1)					TextFace (underline);				else					ForeColor (redColor);			}			DrawString ( temp );			if (*((short *) 0x0D60) == 1)				TextFace (0);			else				ForeColor (blackColor);//е to name			strcpy ( (char *) &temp[1], m->toname );			temp[0] = strlen (m->toname);			if (temp[0] > 20)			{				temp[0] = 17;				pStrConc ( temp, "\p...", temp );			}						MoveTo ( drawpt.h + fi.widMax*29 + 1, drawpt.v );			strcpy ( &tmp[1], m->toname );			tmp[0] = strlen ( &tmp[1] );			if (myname ((StringPtr) tmp))			{				if (*((short *) 0x0D60) == 1)					TextFace (underline);				else					ForeColor (redColor);			}			DrawString ( temp );			if (*((short *) 0x0D60) == 1)				TextFace (0);			else				ForeColor (blackColor);//е subject			strcpy ( (char *) &temp[1], m->subj );			temp[0] = strlen (m->subj);			if (temp[0] > 32)			{				temp[0] = 29;				pStrConc ( temp, "\p...", temp );			}						MoveTo ( drawpt.h + fi.widMax*50 + 1, drawpt.v );			DrawString ( temp );			MoveTo ( drawpt.h + fi.widMax*2 + 4, lRect->bottom );			LineTo ( drawpt.h + fi.widMax*2 + 4, lRect->top );			MoveTo ( drawpt.h + fi.widMax*7 + 3, lRect->bottom );			LineTo ( drawpt.h + fi.widMax*7 + 3, lRect->top );			MoveTo ( drawpt.h + fi.widMax*28 + 3, lRect->bottom );			LineTo ( drawpt.h + fi.widMax*28 + 3, lRect->top );			MoveTo ( drawpt.h + fi.widMax*49 + 3, lRect->bottom );			LineTo ( drawpt.h + fi.widMax*49 + 3, lRect->top );			FreePktMsg (m);		}				if (!lSelect)			break;			case lHiliteMsg:			oldMode = LMGetHiliteMode();		LMSetHiliteMode(1);		if (((WindowPeek)(*lHandle)->port)->hilited)			InvertRect (lRect);		else		{			GetPenState (&penState);			PenMode (srcXor);			FrameRect (lRect);			SetPenState (&penState);		}		LMSetHiliteMode(oldMode);				break;	}}static void AdjustFields (DialogPtr dialog, ListHandle lst){	FontInfo	fInfo;	short		iType;	Handle		iHandle;	Rect		rView;		short		hStep, nextHPos, nextVPos;		TextFont (viewFont);	TextSize (viewSize);	GetFontInfo (&fInfo);	hStep = fInfo.ascent + fInfo.descent + 5;	GetDialogItem ( dialog, siFrom, &iType, &iHandle, &rView );	nextVPos = rView.top;	nextHPos = rView.left;	SetRect (&rView, nextHPos, nextVPos, nextHPos + fInfo.widMax * MName, nextVPos + hStep - 5);	SetDialogItem ( dialog, siFrom, iType, iHandle, &rView );	nextHPos = rView.right + 5;	GetDialogItem ( dialog, 8, &iType, &iHandle, &rView );	SetRect (&rView, rView.left, nextVPos+fInfo.descent, rView.right, nextVPos+fInfo.descent+(rView.bottom-rView.top));	SetDialogItem ( dialog, 8, iType, iHandle, &rView );	GetDialogItem ( dialog, siFromAd, &iType, &iHandle, &rView );	SetRect (&rView, nextHPos, nextVPos, nextHPos + fInfo.widMax * MAddr, nextVPos + hStep - 5);	SetDialogItem ( dialog, siFromAd, iType, iHandle, &rView );	nextHPos = rView.right + 5;	GetDialogItem ( dialog, siDate, &iType, &iHandle, &rView );	SetRect (&rView, nextHPos, nextVPos, nextHPos + fInfo.widMax * MDate, nextVPos + hStep - 5);	SetDialogItem ( dialog, siDate, iType, iHandle, &rView );	nextVPos += hStep;		GetDialogItem ( dialog, siTo, &iType, &iHandle, &rView );	nextHPos = rView.left;	SetRect (&rView, nextHPos, nextVPos, nextHPos + fInfo.widMax * MName, nextVPos + hStep - 5);	SetDialogItem ( dialog, siTo, iType, iHandle, &rView );	nextHPos = rView.right + 5;		GetDialogItem ( dialog, 9, &iType, &iHandle, &rView );	SetRect (&rView, rView.left, nextVPos+fInfo.descent, rView.right, nextVPos+fInfo.descent+(rView.bottom-rView.top));	SetDialogItem ( dialog, 9, iType, iHandle, &rView );	GetDialogItem ( dialog, siToAd, &iType, &iHandle, &rView );	SetRect (&rView, nextHPos, nextVPos, nextHPos + fInfo.widMax * MAddr, nextVPos + hStep - 5);	SetDialogItem ( dialog, siToAd, iType, iHandle, &rView );	nextHPos = rView.right + 5;	GetDialogItem ( dialog, siFlags, &iType, &iHandle, &rView );	SetRect (&rView, nextHPos, nextVPos, nextHPos + fInfo.widMax * MDate, nextVPos + hStep - 5);	SetDialogItem ( dialog, siFlags, iType, iHandle, &rView );	nextVPos += hStep;	GetDialogItem ( dialog, siSubj, &iType, &iHandle, &rView );	SetRect (&rView, rView.left, nextVPos, rView.left + fInfo.widMax * MSubject, nextVPos + hStep - 5);	SetDialogItem ( dialog, siSubj, iType, iHandle, &rView );	GetDialogItem ( dialog, 10, &iType, &iHandle, &rView );	SetRect (&rView, rView.left, nextVPos+fInfo.descent, rView.right, nextVPos+fInfo.descent+(rView.bottom-rView.top));	SetDialogItem ( dialog, 10, iType, iHandle, &rView );	nextVPos += hStep;	GetDialogItem ( dialog, siList, &iType, &iHandle, &rView );	SetRect (&rView, rView.left, nextVPos, rView.right, rView.bottom);	SetDialogItem ( dialog, siList, iType, iHandle, &rView );	(*lst)->rView.top = nextVPos;}static void DrawMsgNum (commonDataPtr common){	short			iType;	Handle			iHandle;	Rect			iRect, rView;	Str255			stemp, temp;	msgbase_atom	Atom;			if ((*common->cSubjList.list)->dataBounds.bottom == 0)	{		GetDialogItem ( common->cSubjList.dialog, siMsgNum, &iType, &iHandle, &rView );		SetDialogItemText (iHandle, "\p");		return;	}	//	if (common->cSubjList.area_number == AreasNumber+1)//		OpenBase ( BADAREA, true );//	else//		OpenBase (common->cSubjList.area_number, true);	msgbase_open_idx (common->cSubjList.area_number, true);		NumToString (common->cSubjList.message_number + 1, stemp);	if ( msgbase_read_atom ( common->cSubjList.message_number, &Atom ) )	{		if (Atom.msg_reply_prev != -1 )		{			pStrConc ( stemp, "\p-", stemp );			NumToString (Atom.msg_reply_prev + 1, temp );			pStrConc ( stemp, temp, stemp );		}		if (Atom.msg_reply_next != -1 )		{			pStrConc ( stemp, "\p+", stemp );			NumToString (Atom.msg_reply_next + 1, temp );			pStrConc ( stemp, temp, stemp );		}	}	pStrConc ( stemp, "\p of ", stemp );	NumToString ((*common->cSubjList.list)->dataBounds.bottom, temp);	pStrConc ( stemp, temp, stemp );	GetDialogItem ( common->cSubjList.dialog, siMsgNum, &iType, &iHandle, &rView );	SetDialogItemText (iHandle, stemp);	msgbase_close (CLOSE_ONLY);//	DrawDialog (common->cSubjList.dialog);}static void DrawContents (commonDataPtr common){	short		iType;	Handle		iHandle;	Rect		iRect, rView;	RGBColor	color, color1;	char		tmp[64], ttt[128];	Str63		stemp, temp;	pktmsg		*MessageBody;	SetPort (common->cSubjList.dialog);	GetDialogItem ( common->cSubjList.dialog, 10, &iType, &iHandle, &rView );	SetDialogItemText (iHandle, "\pSubj:");		GetDialogItem ( common->cSubjList.dialog, siList, &iType, &iHandle, &rView );	MoveTo (0, rView.top - 1);	LineTo ((common->cSubjList.dialog)->portRect.right, rView.top - 1);	GetDialogItem ( common->cSubjList.dialog, siStatus, &iType, &iHandle, &rView );	MoveTo (0, rView.bottom);	LineTo ((common->cSubjList.dialog)->portRect.right, rView.bottom);	GetBackColor (&color1);	color.red = color.green = color.blue = 0xFFFF;	RGBBackColor(&color);	GetDialogItem ( common->cSubjList.dialog, siFrom, &iType, &iHandle, &rView );	EraseRect ( &rView );	InsetRect (&rView, -2, -2);	FrameRect (&rView);	GetDialogItem ( common->cSubjList.dialog, siTo, &iType, &iHandle, &rView );	EraseRect ( &rView );	InsetRect (&rView, -2, -2);	FrameRect (&rView);	GetDialogItem ( common->cSubjList.dialog, siSubj, &iType, &iHandle, &rView );	EraseRect ( &rView );	InsetRect (&rView, -2, -2);	FrameRect (&rView);//	GetDialogItem ( common->cSubjList.dialog, siDate, &iType, &iHandle, &rView );//	EraseRect ( &rView );//	InsetRect (&rView, -2, -2);//	FrameRect (&rView);	GetDialogItem ( common->cSubjList.dialog, siFromAd, &iType, &iHandle, &rView );	EraseRect ( &rView );	InsetRect (&rView, -2, -2);	FrameRect (&rView);	msgbase_open_idx (common->cSubjList.area_number, true);	if (msgbase_getnummsg () != 0 &&		msgbase_read_message ( common->cSubjList.message_number, &MessageBody, READMODE_ONLY ))	{		GetDialogItem ( common->cSubjList.dialog, siList, &iType, &iHandle, &rView );		MoveTo (0, rView.top - 1);		LineTo ((common->cSubjList.dialog)->portRect.right, rView.top - 1);		if (MessageBody->flags & MSGLOCAL)			if (*((short *) 0x0D60) == 1)				TextFace (underline);			else				ForeColor (redColor);		GetDialogItem ( common->cSubjList.dialog, siFrom, &iType, &iHandle, &rView );		TETextBox ( MessageBody->fromname, strlen (MessageBody->fromname), &rView, teForceLeft);		TextFace (0);		ForeColor (blackColor);		strcpy ( &tmp[1], MessageBody->toname );		tmp[0] = strlen ( &tmp[1] );		if (myname ((StringPtr) tmp))			if (*((short *) 0x0D60) == 1)				TextFace (underline);			else				ForeColor (redColor);		GetDialogItem ( common->cSubjList.dialog, siTo, &iType, &iHandle, &rView );		TETextBox ( MessageBody->toname, strlen (MessageBody->toname), &rView, teForceLeft);		TextFace (0);		ForeColor (blackColor);		if ((MessageBody->flags & (MSGFILE | MSGFREQ)) != 0)		{			GetDialogItem ( common->cSubjList.dialog, 10, &iType, &iHandle, &rView );			SetDialogItemText (iHandle, "\pFile:");			TextFont (4);		}				GetDialogItem ( common->cSubjList.dialog, siSubj, &iType, &iHandle, &rView );		TETextBox ( MessageBody->subj, strlen (MessageBody->subj), &rView, teForceLeft);		TextFont (viewFont);		TextSize (viewSize);		if (!common->cSubjList.area_number)		{			GetDialogItem ( common->cSubjList.dialog, siToAd, &iType, &iHandle, &rView );			EraseRect ( &rView );			printaddr (&MessageBody->to, tmp);			TETextBox ( tmp, strlen (tmp), &rView, teForceLeft);			InsetRect (&rView, -2, -2);			FrameRect (&rView);		}				GetDialogItem ( common->cSubjList.dialog, siFromAd, &iType, &iHandle, &rView );//		EraseRect ( &rView );//		InsetRect (&rView, -2, -2);//		FrameRect (&rView);		printaddr (&MessageBody->from, tmp);		TETextBox ( tmp, strlen (tmp), &rView, teForceLeft);//		color.red = color.green = color.blue = 50000;		RGBBackColor(&color1);		GetDialogItem ( common->cSubjList.dialog, siDate, &iType, &iHandle, &rView );		TETextBox ( MessageBody->date, strlen (MessageBody->date), &rView, teForceLeft);		TextFace (condense);		flags_to_string ( MessageBody->flags, ttt );		GetDialogItem ( common->cSubjList.dialog, siFlags, &iType, &iHandle, &rView );		TETextBox ( ttt, strlen (ttt), &rView, teForceLeft );		TextFace (0);		FreePktMsg (MessageBody);	}	else	{//		color.red = color.green = color.blue = 50000;		RGBBackColor(&color1);	}	msgbase_close (CLOSE_ONLY);}static void AdjustWinSize (DialogPtr dialog, ListHandle list, short max){	short		iType, ii, dummy, neww, newh, newc;	Handle		iHandle;	Rect		iRect, rView, rDataBnds;	Point		cellSize;	FontInfo	fInfo;			TextFont (viewFont);	TextSize (viewSize);	GetFontInfo (&fInfo);	GetDialogItem ( dialog, 1, &iType, &iHandle, &rView );	newc = (*list)->cellSize.v;	neww = 1 + fInfo.widMax * (2+1+4+1+20+1+20+1+32) + 15;	//	rView.right;	newh = rView.top + (((max - rView.top) / newc) * newc);	SizeWindow ( dialog, neww, newh, true);	originalView.bottom = newh;	LSetDrawingMode ( false, list );		LSize ( neww - 15, ((newh - rView.top) / newc) * newc, list);		SetPt (&cellSize, neww - 15, newc);	LCellSize (cellSize, list);		(*((*list)->vScroll))->contrlRect.bottom -= 15;		LSetDrawingMode ( true, list );}void WSubjectsEventProcessor (EventRecord *event, windowsQElPtr dialogInfo, long info){	Boolean		needScrollUpdate = false;	DialogPtr	dialog;	ListHandle	list;	short		hasmarks;	short		iType, ii, dummy, neww, newh, newc, menuItem;	Handle		iHandle;	Rect		iRect, rView, rDataBnds;	Point		cellSize, theCell;	Point		where;			long		lSizeVH, j, ltemp, ctemp, nm, jj;	unsigned short iii;		Str255		stemp;		char		key;		WStateData	*WStDat;	MenuHandle	hMenu;		windowsQElPtr	dInfo;	WindowPtr		window;		commonDataPtr	pcommon;	GrafPtr			oldPort;	msgbase_atom	Atom;		pktmsg			*m;	EventRecord		event1;		switch (info & 0xFFFF)	{	case actionSetSize:				originalView.left = ((wloc *) event)->topleft.h;		originalView.top = ((wloc *) event)->topleft.v;		originalView.bottom = ((wloc *) event)->bottom;				break;		case actionGetSize:				((wloc *) event)->topleft.h = originalView.left;		((wloc *) event)->topleft.v = originalView.top;		((wloc *) event)->bottom = originalView.bottom;				break;		case actionCreate:		if (dInfo = windowsOpened (wtSubjects, (long) event, 0))		{			SelectWindow (dInfo->dialog);			break;		}				dialog = GetNewDialog (128 + wtSubjects, NULL, (WindowPtr) -1);		((WindowPeek)dialog)->windowKind = myKind;//		((WindowPeek)dialog)->windowKind = myKind_top;		SetPort ( dialog );		if (originalView.bottom)		{			if (!SuchWindow (wtSubjects) || qd.screenBits.bounds.bottom - originalView.top - 20 < originalView.bottom)			{				if (!originalView.top)				{					originalView.top = (*(((WindowPeek)dialog)->contRgn))->rgnBBox.top;					originalView.left = (*(((WindowPeek)dialog)->contRgn))->rgnBBox.left;	//				originalView.bottom = dialog->portRect.bottom;					originalView.top = LMGetMBarHeight () * 2;				}			}			else			{				originalView.left += 20;				originalView.top += 20;			}		}		else		{			originalView = (*(((WindowPeek)dialog)->contRgn))->rgnBBox;			originalView.bottom = dialog->portRect.bottom;			originalView.top = LMGetMBarHeight () * 2;		}				MoveWindow (dialog, originalView.left, originalView.top, false);		SizeWindow (dialog, dialog->portRect.right, originalView.bottom, false);		SetWTitle (dialog, ((long) event == 0L) ? "\pNETMAIL" :					((long) event == AreasNumber+1) ? "\pBADMAIL" :						(*areasHndls[((long) event)-1])->areaName);		TextFont (viewFont);		TextSize (viewSize);		GetDialogItem ( dialog, 1, &iType, &iHandle, &rView );		SetRect ( &rDataBnds, 0, 0, 1, 0 );		rView.right -= 15;		SetPt ( &cellSize, 0, 0 );//		if ((short) event == AreasNumber+1)//			OpenBase ( BADAREA, true );//		else//			OpenBase ((short) event, true);		msgbase_open_idx ((short) event, true);				list = LNew (						&rView,						&rDataBnds,						cellSize,						129,						dialog,						true,						false,						false,						true					);		(*list)->selFlags = 0x82;		(*list)->port->txFont = 4;		(*list)->port->txSize = 9;		(*(*list)->vScroll)->contrlRect.bottom -= 15;		MoveTo (0, rView.top - 1);		LineTo (rView.right + 15, rView.top - 1);				LActivate ( true, list );		LSetDrawingMode ( false, list );		j = msgbase_getnummsg ();		if (j)		{	//		if ( j*4 > 32767L )	//		{	//			SysBeep (10);	//			return;	//		}						dummy = LAddRow ( j, 0, list );			for (iii = 0; iii < j; iii++)			{	//			NumToString (ii, stemp);				SetPt ( &theCell, 0, iii );				LSetCell ( &iii, sizeof (short), theCell, list );				}						SetPt (&theCell, 0, ((long)dialogInfo < 0) ? msgbase_getlastread () : (long)dialogInfo);			LSetSelect (true, theCell,list);			LAutoScroll (list);		}				AdjustFields (dialog, list);		AdjustWinSize (dialog, list, dialog->portRect.bottom);		WStDat = (WStateData *) *((WindowPeek) dialog)->dataHandle;				newc = (*list)->cellSize.v;		dummy = rView.top + newc * (*list)->dataBounds.bottom;				SetRect (&(WStDat->stdState),			WStDat->stdState.left + dialog->portRect.left,			WStDat->stdState.top + dialog->portRect.top,			WStDat->stdState.left + dialog->portRect.right,			(qd.screenBits.bounds.bottom < WStDat->stdState.top + dummy) ?				qd.screenBits.bounds.bottom :				((*list)->dataBounds.bottom > 5) ? WStDat->stdState.top + dummy :					WStDat->stdState.top + dialog->portRect.bottom);		LSetDrawingMode ( true, list );		ShowWindow ( dialog );		pcommon = (commonDataPtr) NewPtrClear (sizeof (commonSubjList));				pcommon->cSubjList.dialog = dialog;		pcommon->cSubjList.list = list;		pcommon->cSubjList.area_number = (long) event;		pcommon->cSubjList.message_number = ((long)dialogInfo < 0) ? msgbase_getlastread () : (long)dialogInfo;		windowsAdd (dialog, wtSubjects, pcommon, WSubjectsEventProcessor, WSubjectsDialogProcessor);		dInfo = windowsLookUp (dialog);				SetWRefCon (dialog, (long) dInfo);		dInfo->inFront = true;		msgbase_close (CLOSE_ONLY);//		DrawMsgNum (pcommon);		WSubjectsEventProcessor (NULL, dInfo, ((long) inMenuBar << 16) | mouseDown);		break;	case actionClose:		originalView = (*(((WindowPeek)(dialogInfo->dialog))->contRgn))->rgnBBox;		originalView.bottom = (dialogInfo->dialog)->portRect.bottom;		LDispose ((dialogInfo->common)->cSubjList.list);		DisposePtr ((Ptr) dialogInfo->common);		DisposeDialog (dialogInfo->dialog);		windowsKill (dialogInfo->dialog);		break;			case actionActive:	//		DrawOnlyGrowIcon (dialogInfo->dialog);		MoveControl ((*(dialogInfo->common)->cSubjList.list)->vScroll,			(*(dialogInfo->common)->cSubjList.list)->rView.right + ((dialogInfo->inFront) ? 0 : 15),			(*(dialogInfo->common)->cSubjList.list)->rView.top - 1);		SetPt (&theCell, 0, 0);			if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )		{//			if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//				OpenBase ( BADAREA, true );//			else//				OpenBase ((dialogInfo->common)->cSubjList.area_number, true);			msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);						LDraw (theCell, (dialogInfo->common)->cSubjList.list);			msgbase_close (CLOSE_ONLY);		}			break;	case actionBroadcast:			GetPort (&oldPort);		SetPort (dialogInfo->dialog);				switch (((BroadcastRecPtr) event)->synctype)		{		case msgCmdGetMessage:			{				WinComPtr	wcp = (WinComPtr)((BroadcastRecPtr) event)->param[0];				msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);				if (msgbase_getnummsg () > 0 &&					msgbase_read_message ((dialogInfo->common)->cSubjList.message_number, &wcp->arg.MSG->msg, READMODE_TEXT))				{					wcp->result = 1;				}				else					wcp->result = -1;				msgbase_close (CLOSE_ONLY); 			}			break;		case msgCmdGetMessageNum:			{				WinComPtr	wcp = (WinComPtr)((BroadcastRecPtr) event)->param[0];				wcp->result = (dialogInfo->common)->cSubjList.message_number; 			}			break;				case broadClose:					WSubjectsEventProcessor (NULL, dialogInfo, actionClose);			break;					case broadRedrawCell:						if (((BroadcastRecPtr) event)->area != (dialogInfo->common)->cSubjList.area_number)				break;			//			if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//				OpenBase ( BADAREA, true );//			else//				OpenBase ((dialogInfo->common)->cSubjList.area_number, true);			msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);			if (msgbase_getnummsg () != 0 &&				((BroadcastRecPtr) event)->message < msgbase_getnummsg ())			{				SetPt (&theCell, 0, ((BroadcastRecPtr) event)->message);				LDraw (theCell, (dialogInfo->common)->cSubjList.list);			}			msgbase_close (CLOSE_ONLY);			break;		case broadRedrawCells:						if (((BroadcastRecPtr) event)->area != (dialogInfo->common)->cSubjList.area_number)				break;			//			if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//				OpenBase ( BADAREA, true );//			else//				OpenBase ((dialogInfo->common)->cSubjList.area_number, true);			msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);			LUpdate ( (dialogInfo->dialog)->visRgn, (dialogInfo->common)->cSubjList.list );			msgbase_close (CLOSE_ONLY);			break;		case broadDeleteCell:					if (((BroadcastRecPtr) event)->area != (dialogInfo->common)->cSubjList.area_number)				break;			//			if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//				OpenBase ( BADAREA, true );//			else//				OpenBase ((dialogInfo->common)->cSubjList.area_number, true);			msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);			SetPt (&theCell, 0, 0);					LSetDrawingMode (false, (dialogInfo->common)->cSubjList.list);						if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )			{				SetPt (&theCell, 0, (dialogInfo->common)->cSubjList.message_number);				LSetSelect (false, theCell, (dialogInfo->common)->cSubjList.list);			}						if (msgbase_getnummsg ())			{				if ((dialogInfo->common)->cSubjList.message_number >= msgbase_getnummsg ())					(dialogInfo->common)->cSubjList.message_number--;				LDelRow (1, ((BroadcastRecPtr) event)->message, (dialogInfo->common)->cSubjList.list);//				LDelRow (1, ((BroadcastRecPtr) event)->message+1, (dialogInfo->common)->cSubjList.list);			}			else			{				(dialogInfo->common)->cSubjList.message_number = 0;				LDelRow (0, 0, (dialogInfo->common)->cSubjList.list);			}						for (iii=(dialogInfo->common)->cSubjList.message_number; iii < msgbase_getnummsg (); iii++)			{				SetPt (&theCell, 0, iii);				LSetCell (&iii, sizeof (short), theCell, (dialogInfo->common)->cSubjList.list);				}						SetPt (&theCell, 0, ((BroadcastRecPtr) event)->message);			LSetSelect (true, theCell, (dialogInfo->common)->cSubjList.list);						LSetDrawingMode (true, (dialogInfo->common)->cSubjList.list);			msgbase_close (CLOSE_ONLY);//			DrawMsgNum (dialogInfo->common);//			DrawContents (dialogInfo->common);			EraseRect (&(dialogInfo->dialog)->portRect);			InvalRect (&(dialogInfo->dialog)->portRect);			break;		case broadAppendCell:					if (((BroadcastRecPtr) event)->area != (dialogInfo->common)->cSubjList.area_number)				break;			//			if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//				OpenBase ( BADAREA, true );//			else//				OpenBase ((dialogInfo->common)->cSubjList.area_number, true);			msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);						iii = msgbase_getnummsg () - 1;						theCell.h = 0;			theCell.v = LAddRow (1, 0x7FFF, (dialogInfo->common)->cSubjList.list);			LSetCell (&iii, sizeof (short), theCell, (dialogInfo->common)->cSubjList.list);			msgbase_close (CLOSE_ONLY);			InvalRect (&(dialogInfo->dialog)->portRect);						break;		case broadSyncCellLR://			Debugger ();					if (((BroadcastRecPtr) event)->area != (dialogInfo->common)->cSubjList.area_number)				break;						SetPt (&theCell, 0, 0);					if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )			{				SetPt (&theCell, 0, (dialogInfo->common)->cSubjList.message_number);				LSetSelect (false, theCell, (dialogInfo->common)->cSubjList.list);			}			SetPt (&theCell, 0, ((BroadcastRecPtr) event)->message);			LSetSelect (false, theCell, (dialogInfo->common)->cSubjList.list);						if ((dialogInfo->common)->cSubjList.message_number < theCell.v)				(dialogInfo->common)->cSubjList.message_number = theCell.v;						LAutoScroll ((dialogInfo->common)->cSubjList.list);			break;		}				SetPort (oldPort);				break;		case actionMenu:		SetPort (dialogInfo->dialog);		menuItem = (info >> 16) & 0xFF;				switch ((info >> 24) & 0xFF)		{		case fileM:					switch (menuItem)			{			case fExport:								SetPt (&theCell, 0, 0);							if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )					SaveMessagesToFile ((dialogInfo->common)->cSubjList.area_number, theCell.v, 0);								break;			case fPost:				if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cSubjList.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, 0, actionCreate);					Broadcast (wtMsgEdit, editPost,							(dialogInfo->common)->cSubjList.area_number, 0);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, 0, actionCreate);				}							case fPrint:							SetPt (&theCell, 0, 0);						if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )				{					msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);										nm = msgbase_getnummsg ();										for (jj=0; jj < nm; jj++)						if ((*markArray[(dialogInfo->common)->cSubjList.area_number])[jj])							break;									hasmarks = (jj != nm) ? true : false;										if (hasmarks)					{#ifndef LITE						jj = DoPrintMessages_Init ();#endif												if (jj)						{							if (jj == 1)							{								msgbase_read_message (theCell.v, &m, READMODE_TEXT);#ifndef LITE								DoPrintMessages_Print (m);#endif								FreePktMsg (m);#ifndef LITE								DoPrintMessages_Close ();#endif							}							else							{								WProgressEventProcessor ((EventRecord *) nm, (windowsQElPtr) 1, actionCreate);																for (jj=0; jj < nm; jj++)								{									Broadcast (wtFindDlg, broadSyncCellLR, jj, 0);									if ((*markArray[(dialogInfo->common)->cSubjList.area_number])[jj])									{										if (msgbase_read_message (jj, &m, READMODE_TEXT))										{#ifndef LITE											DoPrintMessages_Print (m);#endif											FreePktMsg (m);											if (WaitNextEvent (everyEvent, &event1, 0, NULL))											{												if (!event1.what)													goto nulled;																								msgbase_close (CLOSE_ONLY);																								DoEvent (&event1);																							msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);											}											else											{											nulled:																							DoEvent (&event1);											}										}									}								}																Broadcast (wtFindDlg, broadClose, -1, 0);							}							#ifndef LITE							DoPrintMessages_Close ();#endif						}					}					else					{						msgbase_read_message (theCell.v, &m, READMODE_TEXT);#ifndef LITE						DoPrintOneMessage (m);#endif						FreePktMsg (m);					}										msgbase_close (CLOSE_ONLY);				}								break;			}						break;				case msgM:					switch (menuItem)			{			case mDelete:							if (windowsOpened (wtMsgEdit, (dialogInfo->common)->cSubjList.area_number, 0))				{					CallASndPlay (129);					break;				}				//				if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//					OpenBase ( BADAREA, true );//				else//					OpenBase ((dialogInfo->common)->cSubjList.area_number, true);				msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);								nm = msgbase_getnummsg ();								msgbase_close (CLOSE_ONLY);								for (jj=0; jj < nm; jj++)					if ((*markArray[(dialogInfo->common)->cSubjList.area_number])[jj])						break;							hasmarks = (jj != nm) ? true : false;				#if defined(powerc) || defined(__powerc)				if (hasmarks)					ii = Alert (503, uupMyAlertProc);				else					ii = Alert (501, uupMyAlertProc);#else				if (hasmarks)					ii = Alert (503, myAlertProc);				else					ii = Alert (501, myAlertProc);#endif				if (ii == 2)					break;								if (ii == 5)		//		Kill Marked				{					for (jj = nm-1; jj >= 0; jj--)					{						if (!(*markArray[(dialogInfo->common)->cSubjList.area_number])[jj])							continue;//						if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//							OpenBase ( BADAREA, true );//						else//							OpenBase ((dialogInfo->common)->cSubjList.area_number, true);						msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);												SetPt (&theCell, 0, (dialogInfo->common)->cSubjList.message_number);						LSetSelect (false, theCell, (dialogInfo->common)->cSubjList.list);						SetPt (&theCell, 0, (dialogInfo->common)->cSubjList.message_number = jj);						LSetSelect (true, theCell, (dialogInfo->common)->cSubjList.list);						DeleteMark ((dialogInfo->common)->cSubjList.area_number, jj);						msgbase_delete_message (jj, ATOM_DELETED);						if ((iii = msgbase_getnummsg ()) == 0)							(dialogInfo->common)->cSubjList.message_number = 0;						msgbase_close (CLOSE_UPDATE);						Broadcast (wtMsgView, broadDeleteCell,								(dialogInfo->common)->cSubjList.area_number,								iii);						Broadcast (wtSubjects, broadDeleteCell,								(dialogInfo->common)->cSubjList.area_number, jj);/*						if (msgbase_read_atom (jj, &Atom))						{//							Atom.deleted = 1;							Atom.base_flags = ATOM_DELETED;							msgbase_write_atom (jj, &Atom);													DeleteMark ((dialogInfo->common)->cSubjList.area_number, jj);							msgbase_setnummsg (iii = (msgbase_getnummsg () - 1));														if (iii)							{//								if ((dialogInfo->common)->cSubjList.message_number >= msgbase_getnummsg ())//									(dialogInfo->common)->cSubjList.message_number--;							}							else								(dialogInfo->common)->cSubjList.message_number = 0;														msgbase_close (CLOSE_UPDATE);							Broadcast (wtMsgView, broadDeleteCell,									(dialogInfo->common)->cSubjList.area_number,									iii);							Broadcast (wtSubjects, broadDeleteCell,									(dialogInfo->common)->cSubjList.area_number, jj);						}						else						{							msgbase_close (CLOSE_ONLY);							break;						}*/					}									Broadcast (wtAreasList, broadRedrawCell,						(dialogInfo->common)->cSubjList.area_number, 0);				}				else				//		Kill current				{//					if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//						OpenBase ( BADAREA, true );//					else//						OpenBase ((dialogInfo->common)->cSubjList.area_number, true);					msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);										DeleteMark ((dialogInfo->common)->cSubjList.area_number,								(dialogInfo->common)->cSubjList.message_number);					msgbase_delete_message ((dialogInfo->common)->cSubjList.message_number, ATOM_DELETED);					iii = msgbase_getnummsg ();										msgbase_close (CLOSE_UPDATE);					Broadcast (wtMsgView, broadDeleteCell,							(dialogInfo->common)->cSubjList.area_number,							iii);					Broadcast (wtSubjects, broadDeleteCell,							(dialogInfo->common)->cSubjList.area_number,							(dialogInfo->common)->cSubjList.message_number);					Broadcast (wtAreasList, broadRedrawCell,						(dialogInfo->common)->cSubjList.area_number, 0);/*					if (msgbase_read_atom ((dialogInfo->common)->cSubjList.message_number, &Atom))					{//						Atom.deleted = 1;						Atom.base_flags = ATOM_DELETED;						msgbase_write_atom ((dialogInfo->common)->cSubjList.message_number, &Atom);											DeleteMark ((dialogInfo->common)->cSubjList.area_number,									(dialogInfo->common)->cSubjList.message_number);						msgbase_setnummsg (msgbase_getnummsg () - 1);						//						if ((dialogInfo->common)->cSubjList.message_number >= msgbase_getnummsg ())//							(dialogInfo->common)->cSubjList.message_number--;												iii = msgbase_getnummsg ();												msgbase_close (CLOSE_UPDATE);						Broadcast (wtMsgView, broadDeleteCell,								(dialogInfo->common)->cSubjList.area_number,								iii);						Broadcast (wtSubjects, broadDeleteCell,								(dialogInfo->common)->cSubjList.area_number,								(dialogInfo->common)->cSubjList.message_number);						Broadcast (wtAreasList, broadRedrawCell,							(dialogInfo->common)->cSubjList.area_number, 0);					}					else						msgbase_close (CLOSE_ONLY);*/				}				//				if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//					OpenBase ( BADAREA, true );//				else//					OpenBase ((dialogInfo->common)->cSubjList.area_number, true);				msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);				LAutoScroll ((dialogInfo->common)->cSubjList.list);				EraseRect (&(dialogInfo->dialog)->portRect);				InvalRect (&(dialogInfo->dialog)->portRect);								msgbase_close (CLOSE_ONLY);				break;			case mNew:				if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cSubjList.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, 0, actionCreate);					Broadcast (wtMsgEdit, editNew,							(dialogInfo->common)->cSubjList.area_number, 0);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, 0, actionCreate);				}				break;			case mReplyQ:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cSubjList.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, 0, actionCreate);					Broadcast (wtMsgEdit, editReplyQ,							(dialogInfo->common)->cSubjList.area_number,							(dialogInfo->common)->cSubjList.message_number);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, 0, actionCreate);				}								break;			case mReply:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cSubjList.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, 0, actionCreate);					Broadcast (wtMsgEdit, editReply,							(dialogInfo->common)->cSubjList.area_number,							(dialogInfo->common)->cSubjList.message_number);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, 0, actionCreate);				}								break;			case mCommentQ:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cSubjList.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, 0, actionCreate);					Broadcast (wtMsgEdit, editCommentQ,							(dialogInfo->common)->cSubjList.area_number,							(dialogInfo->common)->cSubjList.message_number);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, 0, actionCreate);				}								break;			case mComment:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cSubjList.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, 0, actionCreate);					Broadcast (wtMsgEdit, editComment,							(dialogInfo->common)->cSubjList.area_number,							(dialogInfo->common)->cSubjList.message_number);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, 0, actionCreate);				}								break;			case mForward:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cMsgView.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number,											(windowsQElPtr) (dialogInfo->common)->cSubjList.message_number, actionCreate);					WASelectEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, (windowsQElPtr) mForward, actionCreate);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, 0, actionCreate);				}								break;			case mReplyQto:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cSubjList.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number,											(windowsQElPtr) (dialogInfo->common)->cSubjList.message_number, actionCreate);					WASelectEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, (windowsQElPtr) mReplyQto, actionCreate);//					Broadcast (wtMsgEdit, editReply,//							(dialogInfo->common)->cSubjList.area_number,//							(dialogInfo->common)->cSubjList.message_number);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, 0, actionCreate);				}								break;			case mReplyto:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cSubjList.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number,											(windowsQElPtr) (dialogInfo->common)->cSubjList.message_number, actionCreate);					WASelectEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, (windowsQElPtr) mReplyto, actionCreate);//					Broadcast (wtMsgEdit, editReply,//							(dialogInfo->common)->cSubjList.area_number,//							(dialogInfo->common)->cSubjList.message_number);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, 0, actionCreate);				}								break;			case mCommentQto:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cSubjList.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number,											(windowsQElPtr) (dialogInfo->common)->cSubjList.message_number, actionCreate);					WASelectEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, (windowsQElPtr) mCommentQto, actionCreate);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, 0, actionCreate);				}								break;			case mCommentto:							if (!windowsOpened (wtMsgEdit, (dialogInfo->common)->cSubjList.area_number, 0))				{					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number,											(windowsQElPtr) (dialogInfo->common)->cSubjList.message_number, actionCreate);					WASelectEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, (windowsQElPtr) mCommentto, actionCreate);				}				else				{					CallASndPlay (129);					WEditEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number, 0, actionCreate);				}								break;			}						break;		case nodeM:			switch (menuItem)			{			case nBrowse:								SetPt (&theCell, 0, 0);							if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )				{//					if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//						OpenBase ( BADAREA, true );//					else//						OpenBase ((dialogInfo->common)->cSubjList.area_number, true);					msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);					if (msgbase_read_message ( theCell.v, &m, READMODE_ONLY ))					{						if (m->from.point)							iii = 3;						else							if (m->from.node)								iii = 2;							else								if (m->from.net)									iii = 1;								else									iii = 0;						WNodeEventProcessor ((EventRecord *) iii, (windowsQElPtr) &m->from, actionCreate);						FreePktMsg (m);					}										msgbase_close (CLOSE_ONLY);				}				else					WNodeEventProcessor ((EventRecord *) 2L, (windowsQElPtr) &(*homesystem)->mainAddr.ad, actionCreate);				break;			case nWhoIs:							SetPt (&theCell, 0, 0);							if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )				{//					if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//						OpenBase ( BADAREA, true );//					else//						OpenBase ((dialogInfo->common)->cSubjList.area_number, true);					msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);					if (msgbase_read_message ( theCell.v, &m, READMODE_ONLY ))					{						WhoIs (&m->from);						FreePktMsg (m);					}										msgbase_close (CLOSE_ONLY);				}								break;			case nNotepad:							WAddresseeEventProcessor ((EventRecord *) 1L, NULL, actionCreate);				break;			}						break;		}				break;		case actionOpen:			SetPt (&theCell, 0, 0);			if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )		{			WViewEventProcessor ((EventRecord *) (dialogInfo->common)->cSubjList.area_number,				(windowsQElPtr) theCell.v, actionCreate);		}		break;		case mouseDown:		if ((info >> 16) != inMenuBar)			where = event->where;		switch (info >> 16)		{		case inMenuBar:					recalcWindowMenu ();						SetPt (&theCell, 0, 0);					dummy = LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list);			hMenu = GetMenuHandle (fileM + 256);			(*hMenu)->enableFlags = 1L | (1L << fQuit) | (1L << fClose) | (1L << fPageSetup);						if ((dialogInfo->common)->cSubjList.area_number != AreasNumber+1)				(*hMenu)->enableFlags |= (1L << fPost);						if (dummy)#ifndef LITE				(*hMenu)->enableFlags |= (1L << fOpen) | (1L << fExport)  | (1L << fPrint);#else				(*hMenu)->enableFlags |= (1L << fOpen) | (1L << fExport);#endif			hMenu = GetMenuHandle (editM + 256);			(*hMenu)->enableFlags = 1L | (1L << iUserName) | (1L << iOrigin) |										(1L << iShowKludges) | (1L << iShowPgf);			hMenu = GetMenuHandle (msgM + 256);			(*hMenu)->enableFlags = 1L | (1L << mNew);			if (dummy)			{				(*hMenu)->enableFlags |=							(1L << mReplyto) |							(1L << mReplyQto) |							(1L << mForward) |							(((dialogInfo->common)->cSubjList.area_number != AreasNumber+1 &&								(dialogInfo->common)->cSubjList.area_number) ?											(1L << mComment) : 0) |							(((dialogInfo->common)->cSubjList.area_number != AreasNumber+1 &&								(dialogInfo->common)->cSubjList.area_number) ?											(1L << mCommentQ) : 0) |							(((dialogInfo->common)->cSubjList.area_number != AreasNumber+1 &&								(dialogInfo->common)->cSubjList.area_number) ?											(1L << mCommentto) : 0) |							(((dialogInfo->common)->cSubjList.area_number != AreasNumber+1 &&								(dialogInfo->common)->cSubjList.area_number) ?											(1L << mCommentQto) : 0) |							(((dialogInfo->common)->cSubjList.area_number != AreasNumber+1) ?											(1L << mReply) : 0) |							(((dialogInfo->common)->cSubjList.area_number != AreasNumber+1) ?											(1L << mReplyQ) : 0);//				(*hMenu)->enableFlags |= (1L << mReplyQ) | (1L << mReply) | (1L << mForward) |//										(1L << mReplyQto) | (1L << mReplyto) |//										(1L << mDelete);				(*hMenu)->enableFlags |= (1L << mDelete);			}						hMenu = GetMenuHandle (nodeM + 256);						(*hMenu)->enableFlags = 0;						if (padname[0])				(*hMenu)->enableFlags |= (1L | (1L << nNotepad));						if (yep ())			{				(*hMenu)->enableFlags |= 1L | (1L << nBrowse);				if (dummy)					(*hMenu)->enableFlags |= (1L << nWhoIs);			}						hMenu = GetMenuHandle (shuffleM + 256);			(*hMenu)->enableFlags = -1L;			hMenu = GetMenuHandle (windowM + 256);						if (((WindowPeek)(dialogInfo->dialog))->windowKind != myKind_top)			{				(*hMenu)->enableFlags = -1L;				(*hMenu)->enableFlags &= ~(1L << wSubjects);			}			else				(*hMenu)->enableFlags = 0;						DrawMenuBar ();			break;		case inContent:					FindWindow (event->where, &window);						if (window != FrontWindow ())			{				if (((WindowPeek)FrontWindow ())->windowKind == myKind_top)					SysBeep (10);				else					SelectWindow (window);			}			else			{				SetPort (dialogInfo->dialog);				GlobalToLocal (&where);								rView = (*((dialogInfo->common)->cSubjList.list))->rView;				rView.right += 15;								if (PtInRect (where, &rView))				{//					if ((short) (dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//						OpenBase ( BADAREA, true );//					else//						OpenBase ((dialogInfo->common)->cSubjList.area_number, true);					msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);										dummy = LClick (where, event->modifiers, (dialogInfo->common)->cSubjList.list);										msgbase_close (CLOSE_ONLY);										SetPt (&theCell, 0, 0);									if (!dummy && LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )					{						if ((dialogInfo->common)->cSubjList.message_number != theCell.v)						{							(dialogInfo->common)->cSubjList.message_number = theCell.v;							iRect = (dialogInfo->dialog)->portRect;							GetDialogItem (dialogInfo->dialog, siList, &iType, &iHandle, &rView );							iRect.bottom = rView.top;							InvalRect (&iRect);						}						if (event->modifiers & optionKey)							Broadcast (wtMsgView, broadSyncCellLR,								(dialogInfo->common)->cSubjList.area_number, theCell.v);					}					if (dummy)					{						WSubjectsEventProcessor (NULL, dialogInfo, actionOpen);					}				}			}			break;		case inZoomIn:		case inZoomOut:			SetPort (dialogInfo->dialog);			if (TrackBox (dialogInfo->dialog, event->where, info >> 16))			{				ZoomWindow (dialogInfo->dialog, info >> 16, true);				//				if ((short) (dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//					OpenBase ( BADAREA, true );//				else//					OpenBase ((dialogInfo->common)->cSubjList.area_number, true);				msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);								AdjustWinSize (dialogInfo->dialog,						(dialogInfo->common)->cSubjList.list,						(dialogInfo->dialog)->portRect.bottom);								msgbase_close (CLOSE_ONLY);								originalView = (*(((WindowPeek)(dialogInfo->dialog))->contRgn))->rgnBBox;				originalView.bottom = (dialogInfo->dialog)->portRect.bottom;				EraseRect (&(dialogInfo->dialog)->portRect);				InvalRect (&(dialogInfo->dialog)->portRect);			}			break;				case inGoAway:					if (TrackGoAway (dialogInfo->dialog, event->where))				if (event->modifiers & optionKey)					Broadcast (wtSubjects, broadClose, 0, 0);				else					WSubjectsEventProcessor (event, dialogInfo, actionClose);						break;		case inDrag:			FindWindow (event->where, &window);						if (window != FrontWindow ())			{				if (((WindowPeek)FrontWindow ())->windowKind == myKind_top)					SysBeep (10);				else					SelectWindow (window);			}			else			{				DragWindow ( dialogInfo->dialog, event->where, &qd.screenBits.bounds );				originalView = (*(((WindowPeek)(dialogInfo->dialog))->contRgn))->rgnBBox;				originalView.bottom = (dialogInfo->dialog)->portRect.bottom;			}						break;		case inGrow:					SetPort (dialogInfo->dialog);				GetDialogItem ( dialogInfo->dialog, 1, &iType, &iHandle, &rView );						newc = (*((dialogInfo->common)->cSubjList.list))->cellSize.v;			rDataBnds.top = rView.top + newc * 6;			rDataBnds.bottom = qd.screenBits.bounds.bottom;			rDataBnds.left = (dialogInfo->dialog)->portRect.right;			rDataBnds.right = (dialogInfo->dialog)->portRect.right;			lSizeVH = GrowWindow ( dialogInfo->dialog, event->where, &rDataBnds );						if (lSizeVH)			{//				if ((short) (dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//					OpenBase ( BADAREA, true );//				else//					OpenBase ((dialogInfo->common)->cSubjList.area_number, true);				msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);				AdjustWinSize (dialogInfo->dialog, (dialogInfo->common)->cSubjList.list, HiWord (lSizeVH));				EraseRect (&(dialogInfo->dialog)->portRect);				InvalRect (&(dialogInfo->dialog)->portRect);								msgbase_close (CLOSE_ONLY);			}						break;		}			break;		case keyDown:	case autoKey:				if (!(*(dialogInfo->common)->cSubjList.list)->dataBounds.bottom)			break;		key = event->message & 0xFF;				SetPort (dialogInfo->dialog);		switch (key)		{		case HelpKey:					SetPt (&theCell, 0, 0);					if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )			{//				if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//					OpenBase ( BADAREA, true );//				else//					OpenBase ((dialogInfo->common)->cSubjList.area_number, true);				msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);				if (msgbase_read_message ( theCell.v, &m, READMODE_ONLY ))				{					WhoIs (&m->from);					FreePktMsg (m);				}								msgbase_close (CLOSE_ONLY);			}						break;		case DeleteFwdKey:					SetPt (&theCell, 0, 0);					if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )			{				(dialogInfo->common)->cSubjList.message_number = theCell.v;				if (windowsOpened (wtMsgEdit, (dialogInfo->common)->cSubjList.area_number, 0))				{					CallASndPlay (129);					break;				}				//				if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//					OpenBase ( BADAREA, true );//				else//					OpenBase ((dialogInfo->common)->cSubjList.area_number, true);				msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);								nm = msgbase_getnummsg ();								msgbase_close (CLOSE_ONLY);								for (jj=0; jj < nm; jj++)					if ((*markArray[(dialogInfo->common)->cSubjList.area_number])[jj])						break;							hasmarks = (jj != nm) ? true : false;				#if defined(powerc) || defined(__powerc)				if (hasmarks)					ii = Alert (503, uupMyAlertProc);				else					ii = Alert (501, uupMyAlertProc);#else				if (hasmarks)					ii = Alert (503, myAlertProc);				else					ii = Alert (501, myAlertProc);#endif							if (ii == 2)					break;								if (ii == 5)		//		Kill Marked				{					for (jj = nm-1; jj >= 0; jj--)					{						if (!(*markArray[(dialogInfo->common)->cSubjList.area_number])[jj])							continue;//						if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//							OpenBase ( BADAREA, true );//						else//							OpenBase ((dialogInfo->common)->cSubjList.area_number, true);						msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);												SetPt (&theCell, 0, (dialogInfo->common)->cSubjList.message_number);						LSetSelect (false, theCell, (dialogInfo->common)->cSubjList.list);						SetPt (&theCell, 0, (dialogInfo->common)->cSubjList.message_number = jj);						LSetSelect (true, theCell, (dialogInfo->common)->cSubjList.list);						DeleteMark ((dialogInfo->common)->cSubjList.area_number, jj);						msgbase_delete_message (jj, ATOM_DELETED);						if ((iii = msgbase_getnummsg ()) == 0)							(dialogInfo->common)->cSubjList.message_number = 0;						msgbase_close (CLOSE_UPDATE);						Broadcast (wtMsgView, broadDeleteCell,								(dialogInfo->common)->cSubjList.area_number,								iii);						Broadcast (wtSubjects, broadDeleteCell,								(dialogInfo->common)->cSubjList.area_number, jj);/*						if (msgbase_read_atom (jj, &Atom))						{//							Atom.deleted = 1;							Atom.base_flags = ATOM_DELETED;							msgbase_write_atom (jj, &Atom);													DeleteMark ((dialogInfo->common)->cSubjList.area_number, jj);							msgbase_setnummsg (iii = (msgbase_getnummsg () - 1));														if (iii)							{//								if ((dialogInfo->common)->cSubjList.message_number >= msgbase_getnummsg ())//									(dialogInfo->common)->cSubjList.message_number--;							}							else								(dialogInfo->common)->cSubjList.message_number = 0;														msgbase_close (CLOSE_UPDATE);							Broadcast (wtMsgView, broadDeleteCell,									(dialogInfo->common)->cSubjList.area_number,									iii);							Broadcast (wtSubjects, broadDeleteCell,									(dialogInfo->common)->cSubjList.area_number, jj);						}						else						{							msgbase_close (CLOSE_ONLY);							break;						}*/					}										Broadcast (wtAreasList, broadRedrawCell,						(dialogInfo->common)->cSubjList.area_number, 0);				}				else				//		Kill current				{//					if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//						OpenBase ( BADAREA, true );//					else//						OpenBase ((dialogInfo->common)->cSubjList.area_number, true);					msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);										DeleteMark ((dialogInfo->common)->cSubjList.area_number,								(dialogInfo->common)->cSubjList.message_number);					msgbase_delete_message ((dialogInfo->common)->cSubjList.message_number, ATOM_DELETED);					iii = msgbase_getnummsg ();										msgbase_close (CLOSE_UPDATE);					Broadcast (wtMsgView, broadDeleteCell,							(dialogInfo->common)->cSubjList.area_number,							iii);					Broadcast (wtSubjects, broadDeleteCell,							(dialogInfo->common)->cSubjList.area_number,							(dialogInfo->common)->cSubjList.message_number);					Broadcast (wtAreasList, broadRedrawCell,						(dialogInfo->common)->cSubjList.area_number, 0);/*					if (msgbase_read_atom ((dialogInfo->common)->cSubjList.message_number, &Atom))					{//						Atom.deleted = 1;						Atom.base_flags = ATOM_DELETED;						msgbase_write_atom ((dialogInfo->common)->cSubjList.message_number, &Atom);											DeleteMark ((dialogInfo->common)->cSubjList.area_number,									(dialogInfo->common)->cSubjList.message_number);						msgbase_setnummsg (msgbase_getnummsg () - 1);						//						if ((dialogInfo->common)->cSubjList.message_number >= msgbase_getnummsg ())//							(dialogInfo->common)->cSubjList.message_number--;												iii = msgbase_getnummsg ();												msgbase_close (CLOSE_UPDATE);						Broadcast (wtMsgView, broadDeleteCell,								(dialogInfo->common)->cSubjList.area_number,								iii);						Broadcast (wtSubjects, broadDeleteCell,								(dialogInfo->common)->cSubjList.area_number,								(dialogInfo->common)->cSubjList.message_number);						Broadcast (wtAreasList, broadRedrawCell,							(dialogInfo->common)->cSubjList.area_number, 0);					}					else						msgbase_close (CLOSE_ONLY);*/				}				//				if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//					OpenBase ( BADAREA, true );//				else//					OpenBase ((dialogInfo->common)->cSubjList.area_number, true);				msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);				LAutoScroll ((dialogInfo->common)->cSubjList.list);								EraseRect (&(dialogInfo->dialog)->portRect);				InvalRect (&(dialogInfo->dialog)->portRect);				msgbase_close (CLOSE_ONLY);				break;			}						break;		case '=':			SetPt (&theCell, 0, 0);					if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )			{				(dialogInfo->common)->cSubjList.message_number = theCell.v;					Broadcast (wtMsgView, broadSyncCellLR,						(dialogInfo->common)->cSubjList.area_number, theCell.v);			}			break;				case EnterKey:		case ReturnKey:			SetPt (&theCell, 0, 0);					if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )			{				(dialogInfo->common)->cSubjList.message_number = theCell.v;				if (event->modifiers & optionKey)					Broadcast (wtMsgView, broadSyncCellLR,						(dialogInfo->common)->cSubjList.area_number, theCell.v);				WSubjectsEventProcessor (NULL, dialogInfo, actionOpen);			}			break;				case UpArrowKey:		//	Up		case DownArrowKey:		//	Down//			if ((short) (dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//				OpenBase ( BADAREA, true );//			else//				OpenBase ((dialogInfo->common)->cSubjList.area_number, true);			msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);			newh = (*((dialogInfo->common)->cSubjList.list))->dataBounds.bottom;					SetPt (&theCell, 0, 0);					if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )				newc = theCell.v;			else				newc = (key == UpArrowKey) ? newh : -1;						neww = (key == UpArrowKey) ? newc - 1 : newc + 1;						if (neww >= newh)			{				needScrollUpdate = true;				neww = 0;			}			else				if (neww < 0)				{					needScrollUpdate = true;					neww = newh - 1;				}						(dialogInfo->common)->cSubjList.message_number = neww;						SetPt (&theCell, 0, newc);			LSetSelect (false, theCell, (dialogInfo->common)->cSubjList.list);						SetPt (&theCell, 0, neww);			LSetSelect (true, theCell, (dialogInfo->common)->cSubjList.list);						LAutoScroll ((dialogInfo->common)->cSubjList.list);			msgbase_close (CLOSE_ONLY);			break;		case PageUpKey:			//	Up		case PageDownKey:		//	Down			GetDialogItem ( dialogInfo->dialog, 1, &iType, &iHandle, &rView );			dummy = ((dialogInfo->dialog)->portRect.bottom - rView.top) / (*((dialogInfo->common)->cSubjList.list))->cellSize.v;			newh = (*((dialogInfo->common)->cSubjList.list))->dataBounds.bottom;			if (dummy < newh)			{//				if ((short) (dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//					OpenBase ( BADAREA, true );//				else//					OpenBase ((dialogInfo->common)->cSubjList.area_number, true);				msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);				SetPt (&theCell, 0, 0);							if (LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list ))				{					newc = theCell.v;										neww = (key == PageUpKey) ? newc - dummy : newc + dummy;										if (neww >= newh)						neww = newh - 1;					else						if (neww < 0)							neww = 0;										(dialogInfo->common)->cSubjList.message_number = neww;					SetPt (&theCell, 0, newc);					LSetSelect (false, theCell, (dialogInfo->common)->cSubjList.list);										SetPt (&theCell, 0, neww);					LSetSelect (true, theCell, (dialogInfo->common)->cSubjList.list);									LAutoScroll ((dialogInfo->common)->cSubjList.list);				}							msgbase_close (CLOSE_ONLY);			}			else			{				SetPt (&theCell, 0, 0);							if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )				{					newc = theCell.v;										neww = (key == PageUpKey) ? 0 : newh - 1;										SetPt (&theCell, 0, newc);					LSetSelect (false, theCell, (dialogInfo->common)->cSubjList.list);										SetPt (&theCell, 0, neww);					LSetSelect (true, theCell, (dialogInfo->common)->cSubjList.list);					LAutoScroll ((dialogInfo->common)->cSubjList.list);				}			}						break;		case HomeKey://			if ((short) (dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//				OpenBase ( BADAREA, true );//			else//				OpenBase ((dialogInfo->common)->cSubjList.area_number, true);			msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);			SetPt (&theCell, 0, 0);					if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )			{				newc = theCell.v;				SetPt (&theCell, 0, newc);				LSetSelect (false, theCell, (dialogInfo->common)->cSubjList.list);			}			(dialogInfo->common)->cSubjList.message_number = 0;			SetPt (&theCell, 0, 0);			LSetSelect (true, theCell, (dialogInfo->common)->cSubjList.list);							LAutoScroll ((dialogInfo->common)->cSubjList.list);			msgbase_close (CLOSE_ONLY);			break;		case EndKey://			if ((short) (dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//				OpenBase ( BADAREA, true );//			else//				OpenBase ((dialogInfo->common)->cSubjList.area_number, true);			msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);			newh = (*((dialogInfo->common)->cSubjList.list))->dataBounds.bottom;			(dialogInfo->common)->cSubjList.message_number = newh - 1;			SetPt (&theCell, 0, 0);					if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )			{				newc = theCell.v;				SetPt (&theCell, 0, newc);				LSetSelect (false, theCell, (dialogInfo->common)->cSubjList.list);			}			SetPt (&theCell, 0, newh-1);			LSetSelect (true, theCell, (dialogInfo->common)->cSubjList.list);							LAutoScroll ((dialogInfo->common)->cSubjList.list);			msgbase_close (CLOSE_ONLY);			break;		case ' '://			if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//				OpenBase ( BADAREA, true );//			else//				OpenBase ((dialogInfo->common)->cSubjList.area_number, true);			msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);						SetPt (&theCell, 0, 0);					if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )			{				(*markArray[(dialogInfo->common)->cSubjList.area_number])[theCell.v] ^= 0xFF,				LDraw (theCell, (dialogInfo->common)->cSubjList.list);			}						newh = (*((dialogInfo->common)->cSubjList.list))->dataBounds.bottom;					SetPt (&theCell, 0, 0);					if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )				newc = theCell.v;			else				newc = (key == UpArrowKey) ? newh : -1;						neww = (key == UpArrowKey) ? newc - 1 : newc + 1;						if (neww >= newh)				neww = 0;			else				if (neww < 0)					neww = newh - 1;						(dialogInfo->common)->cSubjList.message_number = neww;						SetPt (&theCell, 0, newc);			LSetSelect (false, theCell, (dialogInfo->common)->cSubjList.list);						SetPt (&theCell, 0, neww);			LSetSelect (true, theCell, (dialogInfo->common)->cSubjList.list);						LAutoScroll ((dialogInfo->common)->cSubjList.list);			msgbase_close (CLOSE_ONLY);			Broadcast (wtMsgView, broadRedrawCell,				(dialogInfo->common)->cSubjList.area_number, 0);			break;					case '/'://			if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//				OpenBase ( BADAREA, true );//			else//				OpenBase ((dialogInfo->common)->cSubjList.area_number, true);			msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);						SetPt (&theCell, 0, 0);					if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )			{				(dialogInfo->common)->cSubjList.message_number = theCell.v;							if ( msgbase_read_atom ( (dialogInfo->common)->cSubjList.message_number, &Atom ) )				{//					Atom.deleted &= ~0x4000;					Atom.base_flags &= ~ATOM_WASREAD;					msgbase_write_atom ( (dialogInfo->common)->cSubjList.message_number, &Atom );				}				LDraw (theCell, (dialogInfo->common)->cSubjList.list);//				msgbase_close (CLOSE_UPDATE);/*				ltemp = GetLastRead ();				SetLastRead ((dialogInfo->common)->cSubjList.message_number = theCell.v);				LDraw (theCell, (dialogInfo->common)->cSubjList.list);				SetPt (&theCell, 0, ltemp);				LDraw (theCell, (dialogInfo->common)->cSubjList.list);*/			}						msgbase_close (CLOSE_UPDATE);					Broadcast (wtAreasList, broadRedrawCell,				(dialogInfo->common)->cSubjList.area_number, 0);			Broadcast (wtMsgView, broadRedrawCell,				(dialogInfo->common)->cSubjList.area_number, 0);			break;		case '*'://			if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//				OpenBase ( BADAREA, true );//			else//				OpenBase ((dialogInfo->common)->cSubjList.area_number, true);			msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);			ltemp = (dialogInfo->common)->cSubjList.message_number;			ctemp = -1;						while (ltemp != -1)			{				if ( msgbase_read_atom ( ltemp, &Atom ) )				{					ctemp = ltemp;					ltemp = Atom.msg_reply_prev;				}				else					break;			}						if (ctemp != -1 && ctemp != (dialogInfo->common)->cSubjList.message_number)			{				(dialogInfo->common)->cSubjList.message_number = ctemp;				SetPt (&theCell, 0, 0);							if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )				{					newc = theCell.v;					SetPt (&theCell, 0, newc);					LSetSelect (false, theCell, (dialogInfo->common)->cSubjList.list);				}				SetPt (&theCell, 0, ctemp);				LSetSelect (true, theCell, (dialogInfo->common)->cSubjList.list);								LAutoScroll ((dialogInfo->common)->cSubjList.list);			}			msgbase_close (CLOSE_ONLY);			break;		case '-'://			if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//				OpenBase ( BADAREA, true );//			else//				OpenBase ((dialogInfo->common)->cSubjList.area_number, true);			msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);			if ( msgbase_read_atom ( (dialogInfo->common)->cSubjList.message_number, &Atom ) )			{				if (Atom.msg_reply_prev != -1)				{					(dialogInfo->common)->cSubjList.message_number = Atom.msg_reply_prev;					SetPt (&theCell, 0, 0);									if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )					{						newc = theCell.v;						SetPt (&theCell, 0, newc);						LSetSelect (false, theCell, (dialogInfo->common)->cSubjList.list);					}					SetPt (&theCell, 0, Atom.msg_reply_prev);					LSetSelect (true, theCell, (dialogInfo->common)->cSubjList.list);									LAutoScroll ((dialogInfo->common)->cSubjList.list);				}			}			msgbase_close (CLOSE_ONLY);					break;		case '+'://			if ((dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//				OpenBase ( BADAREA, true );//			else//				OpenBase ((dialogInfo->common)->cSubjList.area_number, true);			msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);			if ( msgbase_read_atom ( (dialogInfo->common)->cSubjList.message_number, &Atom ) )			{				if (Atom.msg_reply_next != -1)				{					(dialogInfo->common)->cSubjList.message_number = Atom.msg_reply_next;										SetPt (&theCell, 0, 0);									if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )					{						newc = theCell.v;						SetPt (&theCell, 0, newc);						LSetSelect (false, theCell, (dialogInfo->common)->cSubjList.list);					}					SetPt (&theCell, 0, Atom.msg_reply_next);					LSetSelect (true, theCell, (dialogInfo->common)->cSubjList.list);									LAutoScroll ((dialogInfo->common)->cSubjList.list);				}			}			msgbase_close (CLOSE_ONLY);					break;		}		switch (key)		{		case HomeKey:		case EndKey:			needScrollUpdate = true;				case UpArrowKey:		//	Up		case DownArrowKey:		//	Down		case PageUpKey:			//	Up		case PageDownKey:		//	Down		case ' ':		case '*':		case '+':		case '-':			SetPt (&theCell, 0, 0);			if ( LGetSelect (true, &theCell, (dialogInfo->common)->cSubjList.list) )			{				(dialogInfo->common)->cSubjList.message_number = theCell.v;								if ((*(dialogInfo->common)->cSubjList.list)->dataBounds.bottom > 4095 && needScrollUpdate)					iRect = (dialogInfo->dialog)->portRect;				else				{					iRect = (dialogInfo->dialog)->portRect;					GetDialogItem (dialogInfo->dialog, siList, &iType, &iHandle, &rView );					iRect.bottom = rView.top;				}								InvalRect (&iRect);				if (event->modifiers & optionKey)					Broadcast (wtMsgView, broadSyncCellLR,						(dialogInfo->common)->cSubjList.area_number, theCell.v);			}			break;		}		break;			case updateEvt:		SetPort (dialogInfo->dialog);//		GetDialogItem (dialogInfo->dialog, siMsgNum, &iType, &iHandle, &rView);//		InvalRect (&rView);//		GetDialogItem (dialogInfo->dialog, 10, &iType, &iHandle, &rView);//		InvalRect (&rView);		BeginUpdate (dialogInfo->dialog);//		iRect = (dialogInfo->dialog)->portRect;//		GetDialogItem (dialogInfo->dialog, siList, &iType, &iHandle, &rView );//		iRect.bottom = rView.top;//		EraseRect (&iRect);//		InvalRect (&iRect);//		iRect = (*(((WindowPeek)(dialogInfo->dialog))->updateRgn))->rgnBBox;		//		GlobalToLocal (&topLeft(iRect));//		GlobalToLocal (&botRight(iRect));//		EraseRect (&iRect);//		DrawContents (dialogInfo->common);//		DrawMsgNum (dialogInfo->common);//		DrawDialog (dialogInfo->dialog);		DrawContents (dialogInfo->common);		DrawMsgNum (dialogInfo->common);		UpdateDialog (dialogInfo->dialog, (dialogInfo->dialog)->visRgn);//		if ((short) (dialogInfo->common)->cSubjList.area_number == AreasNumber+1)//			OpenBase ( BADAREA, true );//		else//			OpenBase ((dialogInfo->common)->cSubjList.area_number, true);		msgbase_open_idx ((dialogInfo->common)->cSubjList.area_number, true);/*		{			RgnHandle	mRgn;						mRgn = NewRgn ();			RectRgn (mRgn, &iRect);			LUpdate ( mRgn, (dialogInfo->common)->cSubjList.list );			if (!(dialogInfo->inFront))			{				iRect = (*(dialogInfo->common)->cSubjList.list)->rView;				iRect.left = iRect.right;				iRect.right += 15;				iRect.bottom -= 15;				EraseRect (&iRect);				MoveTo ((*(dialogInfo->common)->cSubjList.list)->rView.right,						(*(dialogInfo->common)->cSubjList.list)->rView.top);				LineTo ((*(dialogInfo->common)->cSubjList.list)->rView.right,						(*(dialogInfo->common)->cSubjList.list)->rView.bottom);			}			DisposeRgn (mRgn);		}*/		LUpdate ((dialogInfo->dialog)->visRgn, (dialogInfo->common)->cSubjList.list);		if (!(dialogInfo->inFront))		{			iRect = (*(dialogInfo->common)->cSubjList.list)->rView;			iRect.left = iRect.right;			iRect.right += 15;			iRect.bottom -= 15;			EraseRect (&iRect);			MoveTo ((*(dialogInfo->common)->cSubjList.list)->rView.right,					(*(dialogInfo->common)->cSubjList.list)->rView.top);			LineTo ((*(dialogInfo->common)->cSubjList.list)->rView.right,					(*(dialogInfo->common)->cSubjList.list)->rView.bottom);		}		msgbase_close (CLOSE_ONLY);				DrawOnlyGrowIcon (dialogInfo->dialog);		EndUpdate (dialogInfo->dialog);		break;	}}void WSubjectsDialogProcessor (EventRecord *event, windowsQElPtr dialogInfo, long info){	DialogPtr	dialog;	short		iHit;	Point		where;	}